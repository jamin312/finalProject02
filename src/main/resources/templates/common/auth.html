<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
  <meta charset="UTF-8">
  <title>ì—­í•  ê¶Œí•œ ì„¤ì •</title>

  <!-- Toast UI Grid -->
  <link rel="stylesheet"
        href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
  <script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>

  <style>
    .role-auth-wrapper #roleGrid,
    .role-auth-wrapper #authGridHr,
    .role-auth-wrapper #authGridSales,
    .role-auth-wrapper #authGridCommon {
      width: 100%;
      margin-top: 6px;
    }

    .role-auth-wrapper .card-title {
      font-weight: 600;
    }

    .role-auth-wrapper .section-title {
      font-size: 15px;
      font-weight: 600;
    }

    .accordion-header-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
    }

    .accordion-header-inner .accordion-button {
      flex-grow: 1;
    }

    .quick-setting-dropdown .dropdown-toggle {
      border-radius: .25rem;
      border: 1px solid #ced4da;
      background-color: #fff;
      color: #495057;
      font-size: .875rem;
      padding: .25rem .5rem;
    }

    .quick-setting-dropdown .dropdown-toggle::after {
      margin-left: .5rem;
    }

    .quick-setting-dropdown .dropdown-menu {
      min-width: 180px;
      padding: 8px 12px;
    }

    .quick-setting-dropdown .dropdown-menu .form-check {
      padding-left: 0;
      margin-bottom: 4px;
    }

    .quick-setting-dropdown .dropdown-menu .form-check-input {
      position: static;
      margin-left: 0;
      margin-right: 6px;
    }
    
    .role-auth-wrapper .tui-grid-cell.sys-role {
	  background-color: #ffffff !important;
	  color: #999 !important;
	}
  </style>
</head>

<body layout:fragment="content">
<div class="role-auth-wrapper">

  <!-- ==========================
       ì—­í•  ì¡°íšŒ ì˜ì—­
       ========================== -->
  <div class="row">
    <div class="col-md-12 mb-3">
      <div class="card">
        <div class="card-header">
          <div class="card-header-left">
            <h5 class="card-title">ì—­í•  ì¡°íšŒ</h5>
          </div>
          <div class="card-header-right">
            <button id="btnRoleReset" class="btn btn-dark" type="button">ì´ˆê¸°í™”</button>
            <button id="btnRoleSearch" class="btn btn-outline-dark" type="button">ì¡°íšŒ</button>
          </div>
        </div>

        <div class="card-body">
          <div class="row mb-2">

            <!-- ì—­í•  ëª… + ìë™ì™„ì„± -->
            <div class="col-md-3">
              <label for="roleName" class="form-label">ì—­í•  ëª…</label>
              <div class="position-relative">
                <input id="roleName"
                       type="text"
                       class="form-control"
                       placeholder="ì¸ì‚¬ ë‹´ë‹¹"
                       autocomplete="off">
                <ul id="roleNameSuggest"
                    class="list-group position-absolute w-100"
                    style="z-index: 2000;">
                </ul>
              </div>
            </div>

            <!-- ì—­í•  ìœ í˜• + ìë™ì™„ì„± -->
            <div class="col-md-3">
			  <label for="roleType" class="form-label">ì—­í•  ìœ í˜•</label>
			  <select id="roleType" class="form-select">
			    <option value="">ì „ì²´</option>
			    <option value="d1">ì¸ì‚¬</option>
			    <option value="d2">ê³µí†µ</option>
			    <option value="d3">ì˜ì—…</option>
			  </select>
			</div>

            <!-- ì‚¬ìš© ì—¬ë¶€ -->
            <div class="col-md-3">
              <label for="useYn" class="form-label">ì‚¬ìš© ì—¬ë¶€</label>
              <select id="useYn" class="form-select">
                <option value="">ì „ì²´</option>
                <option value="e1">ì‚¬ìš©</option>
                <option value="e2">ë¯¸ì‚¬ìš©</option>
              </select>
            </div>

          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- ==========================
       ì—­í•  ëª©ë¡ / ê¶Œí•œ ì„¤ì •
       ========================== -->
  <div class="row">
    <!-- ì—­í•  ëª©ë¡ -->
    <div class="col-md-6">
      <div class="card mb-3">

        <div class="card-header">
          <div class="card-header-left">
            <h5 class="card-title">ì—­í•  ëª©ë¡</h5>
          </div>
          <div class="card-header-right">
            <!-- <button id="btnRoleAdd" type="button" class="btn btn-outline-dark me-2">í–‰ ì¶”ê°€</button> -->
            <div th:replace="~{fragments/buttons :: addRowButton('MENU_COMM_004', 'btnRoleAdd')}"></div>
            <!-- <button id="btnRoleSave" type="button" class="btn btn-outline-dark">ì €ì¥</button> -->
            <div th:replace="~{fragments/buttons :: saveButton('MENU_COMM_004', 'btnRoleSave')}"></div>
          </div>
        </div>

        <div class="card-body">
          <div id="roleGrid"></div>
        </div>
      </div>
    </div>

    <!-- ê¶Œí•œ ì„¤ì • -->
    <div class="col-md-6">
      <div class="card mb-3">

        <div class="card-header">
          <div class="card-header-left">
            <h5 class="card-title">ê¶Œí•œ ì„¤ì •</h5>
          </div>
          <div class="card-header-right">
            <!-- <button id="btnAuthSave" type="button" class="btn btn-outline-dark">ì €ì¥</button> -->
            <div th:replace="~{fragments/buttons :: saveButton('MENU_COMM_004', 'btnAuthSave')}"></div>
          </div>
        </div>

        <div class="card-body">
          <div class="accordion" id="authAccordion">

            <!-- ì¸ì‚¬/ê¸‰ì—¬ (d1) -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingHr">
                <div class="accordion-header-inner">
                  <button class="accordion-button collapsed"
                          type="button"
                          data-bs-toggle="collapse"
                          data-bs-target="#collapseHr"
                          aria-expanded="true"
                          aria-controls="collapseHr">
                    ì¸ì‚¬/ê¸‰ì—¬
                  </button>

                  <div class="dropdown quick-setting-dropdown">
                    <button class="btn dropdown-toggle btn-sm"
                            type="button"
                            data-bs-toggle="dropdown"
                            aria-expanded="false">
                      ë¹ ë¥¸ ì„¤ì •
                    </button>
                    <div class="dropdown-menu dropdown-menu-end p-2">
                      <div class="form-check">
                        <input class="form-check-input quick-bulk-check"
                               type="checkbox"
                               value="readAll"
                               id="qs-hr-read"
                               data-grid="hr">
                        <label class="form-check-label" for="qs-hr-read">
                          ì¡°íšŒ ì¼ê´„ ì ìš©
                        </label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input quick-bulk-check"
                               type="checkbox"
                               value="saveAll"
                               id="qs-hr-save"
                               data-grid="hr">
                        <label class="form-check-label" for="qs-hr-save">
                          ì €ì¥/ìˆ˜ì • ì¼ê´„ ì ìš©
                        </label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input quick-bulk-check"
                               type="checkbox"
                               value="deleteAll"
                               id="qs-hr-delete"
                               data-grid="hr">
                        <label class="form-check-label" for="qs-hr-delete">
                          ì‚­ì œ ì¼ê´„ ì ìš©
                        </label>
                      </div>
                    </div>
                  </div>
                </div>
              </h2>
              <div id="collapseHr"
                   class="accordion-collapse collapse"
                   aria-labelledby="headingHr"
                   data-bs-parent="#authAccordion">
                <div class="accordion-body">
                  <div id="authGridHr"></div>
                </div>
              </div>
            </div>

            <!-- ì˜ì—… (d3) -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingSales">
                <div class="accordion-header-inner">
                  <button class="accordion-button collapsed"
                          type="button"
                          data-bs-toggle="collapse"
                          data-bs-target="#collapseSales"
                          aria-expanded="false"
                          aria-controls="collapseSales">
                    ì˜ì—…
                  </button>

                  <div class="dropdown quick-setting-dropdown">
                    <button class="btn dropdown-toggle btn-sm"
                            type="button"
                            data-bs-toggle="dropdown"
                            aria-expanded="false">
                      ë¹ ë¥¸ ì„¤ì •
                    </button>
                    <div class="dropdown-menu dropdown-menu-end p-2">
                      <div class="form-check">
                        <input class="form-check-input quick-bulk-check"
                               type="checkbox"
                               value="readAll"
                               id="qs-sales-read"
                               data-grid="sales">
                        <label class="form-check-label" for="qs-sales-read">
                          ì¡°íšŒ ì¼ê´„ ì ìš©
                        </label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input quick-bulk-check"
                               type="checkbox"
                               value="saveAll"
                               id="qs-sales-save"
                               data-grid="sales">
                        <label class="form-check-label" for="qs-sales-save">
                          ì €ì¥/ìˆ˜ì • ì¼ê´„ ì ìš©
                        </label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input quick-bulk-check"
                               type="checkbox"
                               value="deleteAll"
                               id="qs-sales-delete"
                               data-grid="sales">
                        <label class="form-check-label" for="qs-sales-delete">
                          ì‚­ì œ ì¼ê´„ ì ìš©
                        </label>
                      </div>
                    </div>
                  </div>
                </div>
              </h2>
              <div id="collapseSales"
                   class="accordion-collapse collapse"
                   aria-labelledby="headingSales"
                   data-bs-parent="#authAccordion">
                <div class="accordion-body">
                  <div id="authGridSales"></div>
                </div>
              </div>
            </div>

            <!-- ê³µí†µ (d2) -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingCommon">
                <div class="accordion-header-inner">
                  <button class="accordion-button collapsed"
                          type="button"
                          data-bs-toggle="collapse"
                          data-bs-target="#collapseCommon"
                          aria-expanded="false"
                          aria-controls="collapseCommon">
                    ê³µí†µ
                  </button>

                  <div class="dropdown quick-setting-dropdown">
                    <button class="btn dropdown-toggle btn-sm"
                            type="button"
                            data-bs-toggle="dropdown"
                            aria-expanded="false">
                      ë¹ ë¥¸ ì„¤ì •
                    </button>
                    <div class="dropdown-menu dropdown-menu-end p-2">
                      <div class="form-check">
                        <input class="form-check-input quick-bulk-check"
                               type="checkbox"
                               value="readAll"
                               id="qs-common-read"
                               data-grid="common">
                        <label class="form-check-label" for="qs-common-read">
                          ì¡°íšŒ ì¼ê´„ ì ìš©
                        </label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input quick-bulk-check"
                               type="checkbox"
                               value="saveAll"
                               id="qs-common-save"
                               data-grid="common">
                        <label class="form-check-label" for="qs-common-save">
                          ì €ì¥/ìˆ˜ì • ì¼ê´„ ì ìš©
                        </label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input quick-bulk-check"
                               type="checkbox"
                               value="deleteAll"
                               id="qs-common-delete"
                               data-grid="common">
                        <label class="form-check-label" for="qs-common-delete">
                          ì‚­ì œ ì¼ê´„ ì ìš©
                        </label>
                      </div>
                    </div>
                  </div>
                </div>
              </h2>
              <div id="collapseCommon"
                   class="accordion-collapse collapse"
                   aria-labelledby="headingCommon"
                   data-bs-parent="#authAccordion">
                <div class="accordion-body">
                  <div id="authGridCommon"></div>
                </div>
              </div>
            </div>

          </div> <!-- /accordion -->
        </div> <!-- /card-body -->

      </div>
    </div>
  </div>

</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {

    let currentRoleId = null;
    let currentRoleRowKey = null;
    let currentRoleIsSystem = false;
	
    const ROLE_TYPE_ITEMS = [
        { text: 'ì¸ì‚¬', value: 'd1' },   
        { text: 'ê³µí†µ', value: 'd2' },  
        { text: 'ì˜ì—…', value: 'd3' }    
      ];
    
    const roleGridOptions = {
	     bodyHeight: 440,
	     rowHeight: 32,
	     scrollX: false,
	     scrollY: true,
	     rowHeaders: ['rowNum'],
	     columnOptions: {
	       minWidth: 80,
	       resizable: true
	     }
	   };
    
    const authGridOptions = {
      bodyHeight: 240,
      rowHeight: 32,
      scrollX: false,
      scrollY: true,
      rowHeaders: ['rowNum'],
      columnOptions: {
        minWidth: 80,
        resizable: true
      }
    };

    if (!window.tui || !tui.Grid) {
      return;
    }

    // ==========================
    // 1. ì—­í•  ëª©ë¡ Grid
    // ==========================
    const roleGrid = new tui.Grid({
      el: document.getElementById('roleGrid'),
      data: [],
      ...roleGridOptions,
      rowClassName: function (row) {
    	    // vendId ê°€ ì—†ìœ¼ë©´ ê³µí†µ(ì‹œìŠ¤í…œ) ì—­í• 
    	    return row.vendId ? '' : 'sys-role';
    	  },
      columns: [
    	  { header: 'ì—­í•  ID', name: 'roleId', hidden: true },

    	  {
    	    header: 'ì—­í•  ëª…',
    	    name: 'roleNm',
    	    editor: 'text'
    	  },
    	  {
    	    header: 'ì—­í•  ìœ í˜•',
    	    name: 'roleTy',
    	    editor: {
    	      type: 'select',
    	      options: { listItems: ROLE_TYPE_ITEMS }
    	    },
    	    formatter: function ({ value }) {
    	      const item = ROLE_TYPE_ITEMS.find(i => i.value === value);
    	      return item ? item.text : value;
    	    }
    	  },
    	  {
    	    header: 'ì—­í•  ì„¤ëª…',
    	    name: 'roleDc',
    	    editor: 'text'
    	  },
    	  {
    	    header: 'ì‚¬ìš© ì—¬ë¶€',
    	    name: 'yn',
    	    editor: {
    	      type: 'select',
    	      options: {
    	        listItems: [
    	          { text: 'ì‚¬ìš©', value: 'e1' },
    	          { text: 'ë¯¸ì‚¬ìš©', value: 'e2' }
    	        ]
    	      }
    	    },
    	    formatter: function ({ value }) {
    	      if (value === 'e1') return 'ì‚¬ìš©';
    	      if (value === 'e2') return 'ë¯¸ì‚¬ìš©';
    	      return value;
    	    }
    	  }
    	]
    });

    // í•„ìˆ˜ í—¤ë”(*) í‘œì‹œ
    if (window.TeamCommon && TeamCommon.grid && TeamCommon.grid.applyRequiredHeaders) {
      TeamCommon.grid.applyRequiredHeaders([
        { gridId: 'roleGrid', columns: ['roleNm', 'roleTy', 'yn'] }
      ]);
    }

    // ==========================
    // 2. ê¶Œí•œ Gridë“¤
    // ==========================
    function createAuthGrid(elId) {
      return new tui.Grid({
        el: document.getElementById(elId),
        data: [],
        ...authGridOptions,
        columns: [
          { header: 'ë©”ë‰´ID', name: 'menuId', hidden: true },
          { header: 'ë©”ë‰´ / í™”ë©´', name: 'menuNm', minWidth: 220 },
          {
            header: 'ì¡°íšŒ',
            name: 'selYn',
            align: 'center',
            formatter: ({ value }) =>
              '<input type="checkbox" ' + (value === 'e1' ? 'checked' : '') + ' />'
          },
          {
            header: 'ì €ì¥ / ìˆ˜ì •',
            name: 'insYn',
            align: 'center',
            formatter: ({ value }) =>
              '<input type="checkbox" ' + (value === 'e1' ? 'checked' : '') + ' />'
          },
          {
            header: 'ì‚­ì œ',
            name: 'delYn',
            align: 'center',
            formatter: ({ value }) =>
              '<input type="checkbox" ' + (value === 'e1' ? 'checked' : '') + ' />'
          }
        ]
      });
    }

    const authGridHr     = createAuthGrid('authGridHr');
    const authGridSales  = createAuthGrid('authGridSales');
    const authGridCommon = createAuthGrid('authGridCommon');

    const moduleGridMap = {
      hr:     { grid: authGridHr,     moduleId: 'd1' },
      sales:  { grid: authGridSales,  moduleId: 'd3' },
      common: { grid: authGridCommon, moduleId: 'd2' }
    };

    // ==========================
    // 3. ë¹ ë¥¸ ì„¤ì • ì²´í¬ë°•ìŠ¤
    // ==========================
    function syncQuickCheckboxes(grid, gridKey) {
      if (!grid) return;

      const rows = grid.getData();
      const allRead   = rows.length > 0 && rows.every(r => r.selYn === 'e1');
      const allSave   = rows.length > 0 && rows.every(r => r.insYn === 'e1');
      const allDelete = rows.length > 0 && rows.every(r => r.delYn === 'e1');

      const qsRead   = document.querySelector('#qs-' + gridKey + '-read');
      const qsSave   = document.querySelector('#qs-' + gridKey + '-save');
      const qsDelete = document.querySelector('#qs-' + gridKey + '-delete');

      if (qsRead)   qsRead.checked   = allRead;
      if (qsSave)   qsSave.checked   = allSave;
      if (qsDelete) qsDelete.checked = allDelete;
    }

    function applyBulkSetting(grid, action, checked) {
      if (!grid) return;

      const val = checked ? 'e1' : 'e2';
      const rows = grid.getData().map(function (row) {
        if (action === 'readAll')   row.selYn = val;
        if (action === 'saveAll')   row.insYn = val;
        if (action === 'deleteAll') row.delYn = val;
        return row;
      });

      grid.resetData(rows);
    }

    document.querySelectorAll('.quick-bulk-check').forEach(function (cb) {
      cb.addEventListener('change', function (e) {
        const gridKey = e.target.dataset.grid;
        const action  = e.target.value;
        const checked = e.target.checked;

        const info = moduleGridMap[gridKey];
        if (!info) return;

        applyBulkSetting(info.grid, action, checked);
        syncQuickCheckboxes(info.grid, gridKey);
      });
    });

    function setupGridClickSync(grid, gridKey) {
      grid.on('click', function (ev) {
        const col = ev.columnName;
        const rowKey = ev.rowKey;
        if (rowKey == null) return;
        if (['selYn', 'insYn', 'delYn'].indexOf(col) === -1) return;

        const current = grid.getValue(rowKey, col);
        const nextVal = current === 'e1' ? 'e2' : 'e1';
        grid.setValue(rowKey, col, nextVal, false);

        syncQuickCheckboxes(grid, gridKey);
      });
    }

    setupGridClickSync(authGridHr, 'hr');
    setupGridClickSync(authGridSales, 'sales');
    setupGridClickSync(authGridCommon, 'common');

    // ì•„ì½”ë””ì–¸ ì—´ë¦´ ë•Œ ë ˆì´ì•„ì›ƒ ì¬ê³„ì‚° (ì˜›ë‚  ì½”ë“œ resize ë¬¸ì œ í•´ê²° íŒ¨í„´)
    $('#collapseHr, #collapseSales, #collapseCommon')
      .on('shown.bs.collapse', function (e) {
        const id = e.target.id;
        setTimeout(function () {
          if (id === 'collapseHr') {
            authGridHr.refreshLayout();
          } else if (id === 'collapseSales') {
            authGridSales.refreshLayout();
          } else if (id === 'collapseCommon') {
            authGridCommon.refreshLayout();
          }
        }, 0);
      });

    // ì´ˆê¸° í•œ ë²ˆ ì „ì²´ ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ ë³´ì • (HR ì„¹ì…˜ì€ show ìƒíƒœë¼ shown ì´ë²¤íŠ¸ê°€ ì•ˆ ëœ¨ê¸° ë•Œë¬¸)
    setTimeout(function () {
      authGridHr.refreshLayout();
      authGridSales.refreshLayout();
      authGridCommon.refreshLayout();
    }, 0);

    // ==========================
    // 4. ìë™ì™„ì„± (TeamCommon.autocomplete)
    // ==========================
    if (window.TeamCommon && TeamCommon.autocomplete && TeamCommon.autocomplete.init) {
      // ì—­í•  ëª… ìë™ì™„ì„±
      TeamCommon.autocomplete.init({
        inputSelector: '#roleName',
        listSelector: '#roleNameSuggest',
        url: '/api/auth/roles/nameSuggest',
        paramName: 'keyword',
        minLength: 1,
        preventClose: true,
        mapResponse: function (item) {
          return {
            id: item.roleId,
            label: item.roleNm,
            value: item.roleNm
          };
        },
        onSelect: function (item) {
          $('#roleName').val(item.value);
        }
      });
    }

    // ==========================
    // 5. AJAX: ì—­í•  / ê¶Œí•œ ì¡°íšŒ
    // ==========================
    function loadRoleList() {
      const params = {
        roleNm: $('#roleName').val() || '',
        roleTy: $('#roleType').val() || '',
        useYn:  $('#useYn').val()    || ''
      };

      $.getJSON('/api/auth/roles', params, function (data) {
        roleGrid.resetData(data || []);
		
        const rowCount = roleGrid.getRowCount();
        for (let rk = 0; rk < rowCount; rk++) {
          const row = roleGrid.getRow(rk);
          if (!row) continue;

          if (!row.vendId) {
            roleGrid.addRowClassName(rk, 'sys-role');
          } else {
            roleGrid.removeRowClassName(rk, 'sys-role');
          }
        }
        
        const rows = roleGrid.getData();
        if (rows.length > 0) {
          currentRoleId = rows[0].roleId;
          loadAllAuthGrids(currentRoleId);
        } else {
          currentRoleId = null;
          // ë©”ë‰´ëŠ” ê·¸ëŒ€ë¡œ ë‘ê³  ì‹¶ìœ¼ë©´ ì•„ë˜ resetData ë¶€ë¶„ì€ ì§€ì›Œë„ ë¨
          loadAllAuthGrids(currentRoleId);
        }
      }).fail(function (xhr) {
        console.error('ì—­í•  ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨', xhr);
      });
    }

    function loadAuthGridByModule(roleId, gridKey) {
      const info = moduleGridMap[gridKey];
      if (!info) return;

      const params = {
        moduleId: info.moduleId,
        roleId: roleId || ''   // roleId ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´ë¡œ ì „ë‹¬
      };

      $.getJSON('/api/auth/menus', params, function (data) {
        info.grid.resetData(data || []);
        syncQuickCheckboxes(info.grid, gridKey);
        info.grid.refreshLayout();   // ë°ì´í„° ë¡œë”© í›„ ë°”ë¡œ ë ˆì´ì•„ì›ƒ ë³´ì •
      }).fail(function (xhr) {
        console.error('ê¶Œí•œ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨ [' + gridKey + ']', xhr);
        info.grid.resetData([]);
        syncQuickCheckboxes(info.grid, gridKey);
        info.grid.refreshLayout();
      });
    }

    function loadAllAuthGrids(roleId) {
      loadAuthGridByModule(roleId, 'hr');
      loadAuthGridByModule(roleId, 'sales');
      loadAuthGridByModule(roleId, 'common');
    }

    // ==========================
    // 6. ë²„íŠ¼/ì´ë²¤íŠ¸ ë°”ì¸ë”©
    // ==========================

    // ì¡°íšŒ ë²„íŠ¼ â†’ ì¢Œì¸¡ ê·¸ë¦¬ë“œë§Œ ì¡°íšŒ
    $('#btnRoleSearch').on('click', function () {
      loadRoleList();
    });

    // ì´ˆê¸°í™” ë²„íŠ¼
    $('#btnRoleReset').on('click', function () {
      $('#roleName').val('');
      $('#roleType').val('');
      $('#useYn').val('');
      roleGrid.resetData([]);
      currentRoleId = null;
      loadAllAuthGrids(null);  // ìš°ì¸¡ì€ ê¸°ë³¸ ë©”ë‰´ë§Œ ë‹¤ì‹œ ë¡œë”©
    });

    // ì—­í•  í–‰ í´ë¦­ â†’ í•´ë‹¹ ì—­í•  ê¸°ì¤€ìœ¼ë¡œ ê¶Œí•œ ì¡°íšŒ
    roleGrid.on('click', function (ev) {
   	  const rowKey = ev.rowKey;
      const row = roleGrid.getRow(ev.rowKey);
      if (!row) return;
            
      currentRoleRowKey = rowKey;
      currentRoleId = row.roleId;
      
      currentRoleIsSystem = !!row.roleId && !row.vendId;
      
      loadAllAuthGrids(currentRoleId);
    });

    // í–‰ ì¶”ê°€ ë²„íŠ¼
    $('#btnRoleAdd').on('click', function () {
      roleGrid.prependRow(
        {
          roleId: null,
          roleNm: '',
          roleTy: '',
          yn: 'e1'
        },
        { focus: true }
      );
    });

    // ì—­í•  ì €ì¥
    $('#btnRoleSave').on('click', function () {
      roleGrid.finishEditing();	
    	
      const modified = roleGrid.getModifiedRows();
	
      if (
        modified.createdRows.length === 0 &&
        modified.updatedRows.length === 0
      ) {
        alert('ë³€ê²½ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      const invalidUpdated = modified.updatedRows.filter(row => {
   	    // roleIdê°€ ìˆê³  vendIdê°€ ì—†ìœ¼ë©´ DBì— ìˆëŠ” ê³µí†µ ì—­í• ë¡œ íŒë‹¨
   	    return row.roleId && !row.vendId;
   	  });

      if (invalidUpdated.length > 0) {
    	alert('ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.\nê³µí†µ ì—­í• ì€ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    	// âœ í™”ë©´ì„ DB ê¸°ì¤€ìœ¼ë¡œ ë¡¤ë°±
    	loadRoleList();
    	return;
      }

      const payload = {
        created: modified.createdRows,
        updated: modified.updatedRows
      };

      $.ajax({
   	    url: '/api/auth/roles',
   	    method: 'POST',
   	    contentType: 'application/json',
   	    data: JSON.stringify(payload)
   	  }).done(function (res) {
   	    const created = (res && res.createdCount) || 0;
   	    const updated = (res && res.updatedCount) || 0;
   	    const deleted = (res && res.deletedCount) || 0;

   	    let msg = '';
   	    if (created > 0) msg += created + 'ê±´ì˜ ì—­í• ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\n';
   	    if (updated > 0) msg += updated + 'ê±´ì˜ ì—­í• ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.\n';
   	    if (deleted > 0) msg += deleted + 'ê±´ì˜ ì—­í• ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.\n';
   	    if (!msg) msg = 'ë³€ê²½ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.';

   	    alert(msg);
   	    loadRoleList();
   	  }).fail(function () {
   	    alert('ì—­í•  ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
   	  });
    });

    // ê¶Œí•œ ì €ì¥
    $('#btnAuthSave').on('click', function () {

	  // 1) ì¢Œì¸¡ ê·¸ë¦¬ë“œ í¸ì§‘ ì¢…ë£Œ
	  roleGrid.finishEditing();
	
	  // 2) í˜„ì¬ ì„ íƒëœ í–‰ì´ ìˆëŠ”ì§€
	  if (currentRoleRowKey == null) {
	    alert('ë¨¼ì € ì¢Œì¸¡ì—ì„œ ì—­í• ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.');
	    return;
	  }
	
	  const selectedRole = roleGrid.getRow(currentRoleRowKey);
	
	  // 3) ì‹ ê·œ í–‰ì¸ë° ì•„ì§ ì €ì¥ ì•ˆ ëœ ê²½ìš°
	  if (!selectedRole || !selectedRole.roleId) {
	    alert('ìƒˆë¡œ ì¶”ê°€í•œ ì—­í• ì…ë‹ˆë‹¤.\në¨¼ì € ì¢Œì¸¡ ì—­í•  ì •ë³´ë¥¼ ì €ì¥í•œ ë’¤ ê¶Œí•œì„ ì €ì¥í•´ ì£¼ì„¸ìš”.');
	    return;
	  }
	
	  // ğŸ”¹ vend_id ì—†ëŠ” ì‹œìŠ¤í…œ ì—­í•  â†’ ì„ íƒëœ ì—­í• ì˜ DB ê°’ìœ¼ë¡œ ë¡¤ë°±
	  if (!selectedRole.vendId) {
	    alert('ì´ ì—­í• ì€ ê¶Œí•œì„ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
	    loadAllAuthGrids(selectedRole.roleId);   // â˜… null ë§ê³  ì´ ì—­í•  ê¸°ì¤€
	    return;
	  }
	
	  // 4) ì—¬ê¸°ê¹Œì§€ ì™”ìœ¼ë©´ DBì— ìˆëŠ” ì—­í• 
	  currentRoleId = selectedRole.roleId;
	
	  authGridHr.finishEditing();
	  authGridSales.finishEditing();
	  authGridCommon.finishEditing();
	
	  const authList = [];
	
	  ['hr', 'sales', 'common'].forEach(function (key) {
	    const info = moduleGridMap[key];
	    if (!info) return;
	
	    const rows = info.grid.getData();
	    rows.forEach(function (row) {
	      authList.push({
	        roleId: currentRoleId,
	        moduleId: info.moduleId,
	        menuId: row.menuId,
	        selYn: row.selYn || 'e2',
	        insYn: row.insYn || 'e2',
	        updtYn: row.insYn || 'e2',
	        delYn: row.delYn || 'e2'
	      });
	    });
	  });
	
	  $.ajax({
	    url: '/api/auth/menus/save',
	    method: 'POST',
	    contentType: 'application/json',
	    data: JSON.stringify(authList)
	  }).done(function (res) {
	    const mode  = res && res.mode;
	    const count = (res && res.count) || 0;
	
	    let msg;
	    if (mode === 'insert') {
	      msg = 'ê¶Œí•œì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.';
	    } else if (mode === 'update') {
	      msg = 'ê¶Œí•œì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.';
	    } else {
	      msg = 'ê¶Œí•œì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.';
	    }
	
	    alert(msg);
	    loadAllAuthGrids(currentRoleId);   // ì •ìƒ ì €ì¥ ì‹œë„ ì´ ì—­í•  ê¸°ì¤€
	  }).fail(function (xhr) {
	    const res = xhr.responseJSON;
	    const msg = (res && res.message) ? res.message : 'ê¶Œí•œ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
	    alert(msg);
	
	    // ğŸ”¹ ì‹¤íŒ¨(ê¶Œí•œ ì—†ìŒ í¬í•¨) ì‹œì—ë„ ì„ íƒëœ ì—­í•  ê¸°ì¤€ìœ¼ë¡œ ë¡¤ë°±
	    if (selectedRole && selectedRole.roleId) {
	      loadAllAuthGrids(selectedRole.roleId);
	    }
	  });
	});
    
    // ì°½ í¬ê¸° ë³€ê²½ ì‹œ ë ˆì´ì•„ì›ƒ ë³´ì •
    window.addEventListener('resize', function () {
      roleGrid.refreshLayout();
      authGridHr.refreshLayout();
      authGridSales.refreshLayout();
      authGridCommon.refreshLayout();
    });

    // ==========================
    // 7. í˜ì´ì§€ ì§„ì… ì‹œ
    //    - ì¢Œì¸¡ ì—­í•  ê·¸ë¦¬ë“œëŠ” ë¹„ì›Œë‘ê³ 
    //    - ìš°ì¸¡ ì•„ì½”ë””ì–¸ì€ ë©”ë‰´ ì „ì²´ ë¡œë”©
    // ==========================
    loadAllAuthGrids(null);

  });
</script>

</body>
</html>
