<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout}">
<head>
<meta charset="UTF-8">
<title>ê³µí†µ ì½”ë“œ ê´€ë¦¬</title>

<!-- Toast UI Grid -->
<link rel="stylesheet"
	href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>

<style>
/* form-select ìƒ‰ìƒì€ style.css ê³µí†µ ì‚¬ìš© â†’ ë³„ë„ ì˜¤ë²„ë¼ì´ë“œ ì œê±° */
.common-code-wrapper #groupGrid, .common-code-wrapper #codeGrid {
	width: 100%;
	margin-top: 4px;
}

.common-code-wrapper .card-title {
	font-weight: 600;
}

/* ì œëª© h5 ì•„ë˜ ì—¬ë°± ì¤„ì´ê¸° */
.common-code-wrapper .card-header-left h5 {
	margin-bottom: 0;
}

/* ë²„íŠ¼ ê°„ê²©ì€ style.css ì˜ .card-header-right(gap) ê³µí†µ ì‚¬ìš© â†’ ì—¬ê¸°ì„  ì¶”ê°€ ë§ˆì§„ ì œê±° */

/* ìë™ì™„ì„± UL ê³µí†µ ìŠ¤íƒ€ì¼ */
#codeGroupSuggest {
	max-height: 200px;
	overflow-y: auto;
	background: #ffffff;
	border: 1px solid #dee2e6;
	padding: 0;
	margin-top: 2px;
	z-index: 2000; /* ì´ë¯¸ ë„£ì–´ë†¨ìœ¼ë©´ ê·¸ëŒ€ë¡œ ë‘¬ë„ ë¨ */
}

/* ê° ì•„ì´í…œ í…ìŠ¤íŠ¸ í™•ì‹¤íˆ ë³´ì´ê²Œ */
#codeGroupSuggest .autocomplete-item {
	font-size: 0.9rem; /* í˜¹ì‹œ ìƒìœ„ì—ì„œ 0ìœ¼ë¡œ ì¡ì•˜ì„ ê²½ìš° ëŒ€ë¹„ */
	color: #212529 !important; /* ê²€ì •ì— ê°€ê¹ê²Œ */
	background-color: #ffffff;
	cursor: pointer;
}

/* hover ì‹œ ê°•ì¡° */
#codeGroupSuggest .autocomplete-item:hover, #codeGroupSuggest .autocomplete-item:focus
	{
	background-color: #f8f9fa;
}
</style>
</head>

<body layout:fragment="content">
	<div class="common-code-wrapper">

		<!-- ê³µí†µ ì½”ë“œ ì¡°íšŒ ì¹´ë“œ -->
		<div class="row">
			<div class="col-md-12 mb-3">
				<div class="card">

					<!-- í—¤ë”: ì œëª© + ì´ˆê¸°í™”/ì¡°íšŒ ë²„íŠ¼ -->
					<div class="card-header">
						<div class="card-header-left">
							<h5 class="card-title">ê³µí†µ ì½”ë“œ ì¡°íšŒ</h5>
						</div>
						<div class="card-header-right">
							<button id="btnReset" class="btn btn-dark" type="button">ì´ˆê¸°í™”</button>
							<button id="btnSearch" class="btn btn-outline-dark" type="button">ì¡°íšŒ</button>
						</div>
					</div>

					<div class="card-body">
						<div class="row mb-2">
							<div class="col-md-3">
								<label for="codeGroupName" class="form-label">ì½”ë“œ ê·¸ë£¹ ëª…</label>

								<!-- [ìë™ì™„ì„±][ì¶”ê°€] ì½”ë“œ ê·¸ë£¹ëª… input + ì¶”ì²œ ëª©ë¡ì„ í•¨ê»˜ ê°ì‹¸ëŠ” ë˜í¼ -->
								<div class="position-relative">
									<!-- [ìë™ì™„ì„±][ê¸°ì¡´ inputì— autocomplete="off"ë§Œ ì¶”ê°€] -->
									<input id="codeGroupName" type="text" class="form-control"
										placeholder="ì½”ë“œ ê·¸ë£¹ ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" autocomplete="off">
									<!-- ë¸Œë¼ìš°ì € ê¸°ë³¸ ìë™ì™„ì„± ë„ê¸° -->

									<!-- [ìë™ì™„ì„±][ì¶”ê°€] ì½”ë“œ ê·¸ë£¹ëª… ìë™ì™„ì„± í›„ë³´ ë¦¬ìŠ¤íŠ¸ -->
									<ul id="codeGroupSuggest"
										class="list-group position-absolute w-100"
										style="z-index: 2000;">
										<!-- JSì—ì„œ <li> í•­ëª©ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
									</ul>
								</div>

								<!-- í•„ìš”í•˜ë©´ ê·¸ë£¹ IDìš© hidden ì¶”ê°€ (ì˜ˆì‹œ)
                            <input type="hidden" id="codeGroupId" name="codeGroupId">
                            -->
							</div>
							<div class="col-md-3">
								<label for="codeGroupRegYn" class="form-label">ì½”ë“œ ì €ì¥ ì—¬ë¶€</label>
								<div class="position-relative">
									<select id="codeGroupRegYn" name="codeGroupRegYn"
										class="form-select">
										<option value="">ì„ íƒ</option>
										<option value="N">ê°€ëŠ¥</option>
										<option value="Y">ë¶ˆê°€ëŠ¥</option>
									</select>
								</div>
							</div>
						</div>
					</div>

				</div>
			</div>
		</div>

		<!-- ì¢Œì¸¡: ê·¸ë£¹ Grid / ìš°ì¸¡: ì½”ë“œ Grid -->
		<div class="row">
			<!-- ê·¸ë£¹ Grid ì¹´ë“œ -->
			<div class="col-md-6">
				<div class="card mb-3">

					<!-- í—¤ë”: ì½”ë“œ ê·¸ë£¹ ëª©ë¡ -->
					<div class="card-header">
						<div class="card-header-left">
							<h5 class="card-title">ì½”ë“œ ê·¸ë£¹ ëª©ë¡</h5>
						</div>
					</div>

					<div class="card-body">
						<div id="groupGrid"></div>
					</div>
				</div>
			</div>

			<!-- ì½”ë“œ Grid ì¹´ë“œ -->
			<div class="col-md-6">
				<div class="card mb-3">

					<!-- í—¤ë”: ê³µí†µ ì½”ë“œ ëª©ë¡ -->
					<div class="card-header">
						<div class="card-header-left">
							<h5 class="card-title">ê³µí†µ ì½”ë“œ ëª©ë¡</h5>
						</div>
						<div class="card-header-right">
							<!-- <button id="addRowBtn" class="btn btn-outline-dark">í–‰ì¶”ê°€</button> -->
							<div th:replace="~{fragments/buttons :: addRowButton('MENU_COMM_001', 'addRowBtn')}"></div>
							<!-- <button id="insertBtn" type="button" class="btn btn-outline-dark">ì €ì¥</button> -->
							
							<div th:replace="~{fragments/buttons :: saveButton('MENU_COMM_001', 'insertBtn')}"></div>
						</div>
					</div>

					<div class="card-body">
						<div id="codeGrid"></div>
					</div>
				</div>
			</div>
		</div>

	</div>

	<script>
  document.addEventListener('DOMContentLoaded', function () {

    // Toast Grid ë¡œë”© í™•ì¸
    if (!window.tui || !tui.Grid) {
      return;
    }

    // ==========================
    // 0. í˜„ì¬ ì„ íƒëœ ê·¸ë£¹ ID ì €ì¥ìš©
    // ==========================
    let currentGrpId = null;

    // ==========================
    // 1. Grid ê³µí†µ ì˜µì…˜
    // ==========================
    const commonGridOptions = {
      bodyHeight: 440,
      scrollX: false,
      scrollY: true,
      rowHeaders: [],
      columnOptions: {
        minWidth: 80,
        resizable: true,
        editingEvent: 'click'
      }
    };

    // ==========================
    // 2. Grid ìƒì„± (ì´ˆê¸° ë°ì´í„°ëŠ” ë¹ˆ ë°°ì—´)
    // ==========================
    const groupGrid = new tui.Grid({
      el: document.getElementById('groupGrid'),
      data: [],
      ...commonGridOptions,
      columns: [
        { header: 'ê·¸ë£¹ ID', name: 'groupId' },
        { header: 'ì½”ë“œ ê·¸ë£¹ ëª…', name: 'groupName' },
        { header: 'ì„¤ëª…', name: 'description' },
        { header: 'ì½”ë“œ ì €ì¥ ì—¬ë¶€', name: 'oprtrYn', sortable: true }
      ]
    });

    const codeGrid = new tui.Grid({
      el: document.getElementById('codeGrid'),
      data: [],
      ...commonGridOptions,
      columns: [
        {
          header: 'ì½”ë“œ ID',
          name: 'codeId',
          formatter: ({ value }) => {
            if (value === null || value === undefined || value === '') {
              return 'ìë™ ì…ë ¥ë©ë‹ˆë‹¤.';
            }
            return value;
          }
        },
        {
          header: 'ì½”ë“œ ëª…',
          name: 'codeName',
          editor: 'text',
          formatter: ({ value }) => {
            if (value === null || value === undefined || value === '') {
              return 'ì½”ë“œ ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”';
            }
            return value;
          }
        },
        {
          header: 'ì‚¬ìš© ì—¬ë¶€',
          name: 'useYn',
          editor: {
            type: 'select',
            options: {
              listItems: [
                { text: 'ì‚¬ìš©',   value: 'Y' },
                { text: 'ë¯¸ì‚¬ìš©', value: 'N' }
              ]
            }
          },
          formatter: function ({ value }) {
            if (value === null || value === undefined || value === '') {
              return 'ì‚¬ìš©/ë¯¸ì‚¬ìš© ì„ íƒí•´ì£¼ì„¸ìš”';
            }
            if (value === 'Y') return 'ì‚¬ìš©';
            if (value === 'N') return 'ë¯¸ì‚¬ìš©';
            return value;
          }
        },
        {
            header: 'ìˆ˜ì • ê°€ëŠ¥ ì—¬ë¶€',
            name: 'modifyYn',      // ë°ì´í„° í•„ë“œ ì´ë¦„
            align: 'center',
            sortable: true,
            formatter: ({ value }) => {
              if (value === 'Y') return 'ìˆ˜ì • ê°€ëŠ¥';
              if (value === 'N') return 'ìˆ˜ì • ë¶ˆê°€ëŠ¥';
              return value || '';
            }
          }
      ]
    });

    // í•„ìˆ˜ ì»¬ëŸ¼ í—¤ë”(*) í‘œì‹œ (ê³µí†µ ìœ í‹¸ ì‚¬ìš©)
    if (window.TeamCommon && TeamCommon.grid && typeof TeamCommon.grid.applyRequiredHeaders === 'function') {
      TeamCommon.grid.applyRequiredHeaders([
        { gridId: 'codeGrid', columns: ['codeName', 'useYn'] }
      ]);
    }

    // ==========================
    // 3. ì´ˆê¸°í™” ë²„íŠ¼
    // ==========================
    const $btnReset = document.getElementById('btnReset');
    const $codeGroupName = document.getElementById('codeGroupName');
    const $codeGroupRegYn = document.getElementById('codeGroupRegYn');

    if ($btnReset && $codeGroupName) {
      $btnReset.addEventListener('click', function () {
        $codeGroupName.value = '';
        $codeGroupRegYn.value = '';
        
        groupGrid.resetData([]);
        codeGrid.resetData([]);
        currentGrpId = null;
      });
    }

    // ==========================
    // 4. í–‰ ì¶”ê°€ ë²„íŠ¼
    // ==========================
    const addRowBtn = document.getElementById('addRowBtn');

    if (addRowBtn) {
      addRowBtn.addEventListener('click', () => {
        if (!currentGrpId) {
          alert('ì™¼ìª½ì—ì„œ ë¨¼ì € ì½”ë“œ ê·¸ë£¹ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
          return;
        }

        codeGrid.prependRow(
          {
            codeId: '',
            codeName: '',
            useYn: '',
            modifyYn: 'Y'
          },
          { focus: true }
        );
      });
    }

    // ==========================
    // 5. ì½”ë“œ ê·¸ë£¹ëª… ìë™ì™„ì„± (ê³µí†µ ìœ í‹¸ ì‚¬ìš©)
    // ==========================
    if (window.TeamCommon && TeamCommon.autocomplete && typeof TeamCommon.autocomplete.init === 'function') {

      TeamCommon.autocomplete.init({
        inputSelector: '#codeGroupName',
        listSelector: '#codeGroupSuggest',
        url: '/code/auto',
        paramName: 'keyword',
        minLength: 1,
        delay: 300,
        mapResponse: function (item) {
          return {
            id: item.groupId,
            label: item.grpNm,
            value: item.grpNm
          };
        },
        onSelect: function (item) {
          document.getElementById('codeGroupName').value = item.value;
        }
      });

    } else {
      console.warn('TeamCommon.autocomplete.init ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. teamUtil.js / autocomplete ìœ í‹¸ ë¡œë”© í™•ì¸');
    }

    // ==========================
    // 6. ê·¸ë£¹ ëª©ë¡ ì¡°íšŒ
    // ==========================
    const btnClick = document.getElementById('btnSearch');

    if (btnClick) {
      btnClick.addEventListener('click', function () {
        const keyword = $codeGroupName.value.trim();
        const oprtrYn = $codeGroupRegYn ? $codeGroupRegYn.value : '';
        getGroupList(keyword, oprtrYn);
      });
    }

    function getGroupList(grpNm, oprtrYn) {
      const body = { 
    		  grpNm: grpNm,
    		  oprtrYn: oprtrYn	  
      };

      fetch("/code/grpNm", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
      })
        .then(res => {
          if (!res.ok) {
            throw new Error("ì„œë²„ ì˜¤ë¥˜: " + res.status);
          }
          return res.json();
        })
        .then(result => {
          const mapped = result.map(row => ({
            groupId: row.grpId,
            groupName: row.grpNm,
            description: row.dc,
            useYn: row.useYn,
            oprtrYn: row.oprtrYn === 'Y' ? 'ë¶ˆê°€ëŠ¥' : 'ê°€ëŠ¥'
          }));

          groupGrid.resetData(mapped);
          codeGrid.resetData([]);
          currentGrpId = null;
        })
        .catch(err => {
          console.error("ì½”ë“œ ê·¸ë£¹ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜", err);
        });
    }

    // ==========================
    // 7. íŠ¹ì • ê·¸ë£¹ì˜ ì½”ë“œ ëª©ë¡ ì¡°íšŒ í•¨ìˆ˜
    // ==========================
    function loadCodeListByGrpId(grpId) {
      if (!grpId) return;

      fetch('/code/codeId', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ grpId: grpId })
      })
        .then(function (res) {
          if (!res.ok) {
            throw new Error('ì„œë²„ ì˜¤ë¥˜: ' + res.status);
          }
          return res.json();
        })
        .then(function (result) {
          const mapped = result.map(function (row) {
            return {
              codeId: row.codeId,
              codeName: row.codeNm,
              useYn: row.yn,
              modifyYn: row.vendId ? 'Y' : 'N'
            };
          });

          codeGrid.resetData(mapped);
        })
        .catch(function (err) {
          console.error('ì½”ë“œ ëª©ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜', err);
        });
    }

    // ==========================
    // 8. ê·¸ë£¹ Grid í´ë¦­ â†’ currentGrpId ì„¤ì • + ì½”ë“œ ì¡°íšŒ
    // ==========================
    groupGrid.on('click', function (ev) {
      if (ev.targetType !== 'cell') {
        return;
      }

      const row = groupGrid.getRow(ev.rowKey);
      if (!row) return;

      const grpId = row.groupId;
      currentGrpId = grpId;
      console.log('ì„ íƒëœ grpId:', grpId);

      loadCodeListByGrpId(grpId);
    });

    // ==========================
    // 9. ì €ì¥ ë²„íŠ¼: ì‹ ê·œ í–‰ë“¤ INSERT
    // ==========================
    const insertBtn = document.getElementById('insertBtn');

    if (insertBtn) {
      insertBtn.addEventListener('click', async function () {
        if (!currentGrpId) {
          alert('ì™¼ìª½ì—ì„œ ì½”ë“œ ê·¸ë£¹ì„ ë¨¼ì € ì„ íƒí•œ í›„, í–‰ì„ ì¶”ê°€/ìˆ˜ì •í•˜ê³  ì €ì¥í•˜ì„¸ìš”.');
          return;
        }

        // âœ… í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ì…€ ê°’ ê°•ì œ ë°˜ì˜
        codeGrid.finishEditing();

        const modified = codeGrid.getModifiedRows();
        const createdRows = modified.createdRows || [];  // ì‹ ê·œ(ì €ì¥)
        const updatedRows = modified.updatedRows || [];  // ìˆ˜ì •

        // ì €ì¥ + ìˆ˜ì • ëŒ€ìƒ ëª¨ë‘ í•©ì¹˜ê¸°
        const targetRows = [
          ...createdRows.map(r => ({ ...r, _type: 'insert' })),
          ...updatedRows.map(r => ({ ...r, _type: 'update' }))
        ];

        if (targetRows.length === 0) {
          alert('ì €ì¥/ìˆ˜ì •í•  ì½”ë“œ í–‰ì´ ì—†ìŠµë‹ˆë‹¤.\ní–‰ì„ ì¶”ê°€í•˜ê±°ë‚˜ ê¸°ì¡´ í–‰ì„ ìˆ˜ì •í•œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
          return;
        }

        // í•„ìˆ˜ê°’ ê²€ì¦ (ì½”ë“œ ëª…, ì‚¬ìš© ì—¬ë¶€)
        for (let i = 0; i < targetRows.length; i++) {
          const row = targetRows[i];
          if (!row.codeName || !row.useYn) {
            alert(
              'ì½”ë“œ í–‰ì— ë¹ˆ ê°’ì´ ìˆìŠµë‹ˆë‹¤.\n' +
              'ì½”ë“œ ëª…ê³¼ ì‚¬ìš© ì—¬ë¶€ëŠ” ëª¨ë‘ í•„ìˆ˜ì…ë‹ˆë‹¤.\n' +
              'â†’ ê·¸ë¦¬ë“œì—ì„œ í•´ë‹¹ í–‰ì„ í™•ì¸í•´ì£¼ì„¸ìš”.'
            );
            return;
          }
        }

        // ğŸ”¹ ì—¬ê¸°ë¶€í„°: ìˆœì°¨ë¡œ í•œ ê±´ì”© ì„œë²„ í˜¸ì¶œ
        const results = [];

        for (let i = 0; i < targetRows.length; i++) {
          const row = targetRows[i];
          const isUpdate = row._type === 'update';
          const url = isUpdate ? '/code/modCode' : '/code/regCode';

          const payload = {
            grpId: currentGrpId,
            // ìˆ˜ì •ì¼ ë•Œë§Œ codeId ì „ë‹¬, ì €ì¥ì¼ ë•ŒëŠ” null
            codeId: isUpdate ? row.codeId : null,
            codeNm: row.codeName,
            yn: row.useYn,
            vendId: null   // TODO: ê±°ë˜ì²˜ë³„ ì½”ë“œ í•„ìš”í•˜ë©´ ë‚˜ì¤‘ì— ì„¸íŒ…
          };

          try {
            const res = await fetch(url, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(payload)
            });

            let data;
            if (!res.ok) {
              data = {
                success: false,
                message: 'ì„œë²„ ì˜¤ë¥˜: ' + res.status
              };
            } else {
              data = await res.json();   // CodeRegResponseDto {success, message, codeId}
            }

            data._type = row._type;
            data._rowIndex = i;
            results.push(data);

          } catch (err) {
            console.error('ì½”ë“œ ì €ì¥ ìš”ì²­ ì¤‘ ì˜¤ë¥˜', err);
            results.push({
              success: false,
              message: 'í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
              _type: row._type,
              _rowIndex: i
            });
          }
        }

        // ğŸ”¹ ì—¬ê¸°ë¶€í„°ëŠ” ê¸°ì¡´ Promise.all ê²°ê³¼ ì²˜ë¦¬ ë¡œì§ ê·¸ëŒ€ë¡œ ì¬ì‚¬ìš©
        try {
          let insertCount = 0;
          let updateCount = 0;
          const failMessages = [];

          results.forEach(function (res) {
            const isUpdate = res && res._type === 'update';
            const rowNo = (res && typeof res._rowIndex === 'number')
              ? res._rowIndex + 1
              : '?';
            const typeLabel = isUpdate ? 'ìˆ˜ì •' : 'ì €ì¥';

            if (res && res.success) {
              if (isUpdate) {
                updateCount++;
              } else {
                insertCount++;
              }
            } else {
              const msg = (res && res.message) ? res.message : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
              failMessages.push(`í–‰ ${rowNo} (${typeLabel}): ${msg}`);
            }
          });

          let alertMsg = '';
          if (insertCount > 0) {
            alertMsg += insertCount + 'ê±´ì˜ ì½”ë“œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\n';
          }
          if (updateCount > 0) {
            alertMsg += updateCount + 'ê±´ì˜ ì½”ë“œê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.\n';
          }
          if (failMessages.length > 0) {
            alertMsg += '\nì‹¤íŒ¨í•œ í–‰ì´ ìˆìŠµë‹ˆë‹¤.\n' + failMessages.join('\n');
          }

          alert(alertMsg || 'ì²˜ë¦¬ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');

          if (insertCount > 0 || updateCount > 0) {
            // ì €ì¥ í›„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            loadCodeListByGrpId(currentGrpId);
          }
        } catch (err) {
          console.error('ì½”ë“œ ì €ì¥ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜', err);
          alert('ì½”ë“œ ì €ì¥ ì¤‘ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.');
        }
      });
    }



  }); // end DOMContentLoaded
</script>



</body>
</html>
