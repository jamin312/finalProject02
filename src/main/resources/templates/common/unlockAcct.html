<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
  <meta charset="UTF-8">
  <title>잠금 계정 조회</title>

  <!-- Toast UI Grid -->
  <link rel="stylesheet"
        href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
  <script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>
  <script src="assets/vendors/bootstrap-datepicker/bootstrap-datepicker.min.js"></script>
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

  <style>
    .lock-account-wrapper .card-title {
      font-weight: 600;
    }

    /* Grid 영역 */
    .lock-account-wrapper #accountGrid {
      width: 100%;
      margin-top: 4px;
    }

    /* 자동완성 목록 공통 스타일 */
    .lock-account-wrapper .autocomplete-list {
      max-height: 200px;
      overflow-y: auto;
      z-index: 2000;
    }

    /* 잠금 일시가 '-' 일 때 가운데 정렬용 */
    .lock-account-wrapper .lock-time-center {
      display: block;
      text-align: center;
    }
  </style>
</head>

<body layout:fragment="content">
<div class="lock-account-wrapper">

  <!-- 잠금 계정 조회 카드 -->
  <div class="row mb-3">
    <div class="col-md-12">
      <div class="card">

        <!-- 카드 헤더 : 제목 + 초기화/조회 버튼 -->
        <div class="card-header">
          <div class="card-header-left">
            <h5 class="card-title">잠금 계정 조회</h5>
          </div>
          <div class="card-header-right">
            <button id="btnReset" type="button" class="btn btn-dark">초기화</button>
            <button id="btnSearch" type="button" class="btn btn-outline-dark">조회</button>
          </div>
        </div>

        <div class="card-body">
          <div class="row g-2">
            <!-- 거래처 명 (autoComplete) -->
            <div class="col-md-3">
              <label for="clientName" class="form-label">거래처 명</label>
              <div class="position-relative">
                <input id="clientName" type="text" class="form-control" placeholder="YEDAM"
                       autocomplete="off" />
                <ul id="clientNameList"
                    class="list-group position-absolute w-100 autocomplete-list"
                    style="display:none;"></ul>
              </div>
            </div>

            <!-- 계정 ID (autoComplete) -->
            <div class="col-md-3">
              <label for="accountId" class="form-label">계정 ID</label>
              <div class="position-relative">
                <input id="accountId" type="text" class="form-control" placeholder="HONG@NON.AC"
                       autocomplete="off" />
                <ul id="accountIdList"
                    class="list-group position-absolute w-100 autocomplete-list"
                    style="display:none;"></ul>
              </div>
            </div>

            <!-- 사용자 이름 (autoComplete) -->
            <div class="col-md-3">
              <label for="userName" class="form-label">사용자 이름</label>
              <div class="position-relative">
                <input id="userName" type="text" class="form-control" placeholder="홍길동"
                       autocomplete="off" />
                <ul id="userNameList"
                    class="list-group position-absolute w-100 autocomplete-list"
                    style="display:none;"></ul>
              </div>
            </div>

            <!-- 계정 상태 (공통 코드 r1~r4) -->
            <div class="col-md-3">
              <label for="status" class="form-label">계정 상태</label>
              <select id="status" class="form-select">
                <option value="">전체</option>
                <!-- 나머지는 JS에서 공통 코드로 채움 -->
              </select>
            </div>
          </div>

          <div class="row g-2 mt-2">
            <div class="col-md-6">
              <label class="form-label">잠금 일시</label>
              <div class="d-flex align-items-center js-date-range">

                <!-- 시작일 -->
                <div class="input-group date">
                  <input type="text"
                         class="form-control datepicker js-date-range-start"
                         placeholder="시작일">
                  <span class="input-group-text js-date-range-icon-start">
                    <i class="bi bi-calendar"></i>
                  </span>
                </div>

                <span class="mx-1 fw-bold fs-5">~</span>

                <!-- 종료일 -->
                <div class="input-group date ms-2">
                  <input type="text"
                         class="form-control datepicker js-date-range-end"
                         placeholder="종료일">
                  <span class="input-group-text js-date-range-icon-end">
                    <i class="bi bi-calendar"></i>
                  </span>
                </div>

              </div>
            </div>

          </div>
        </div>
        <!-- /card-body -->
      </div>
    </div>
  </div>

  <!-- 계정 목록 카드 -->
  <div class="row">
    <div class="col-md-12">
      <div class="card">

        <!-- 카드 헤더 : 제목 + 잠금 해제 / 저장 버튼 -->
        <div class="card-header">
          <div class="card-header-left">
            <h5 class="card-title">계정 목록</h5>
          </div>
          <div class="card-header-right">
            <div th:replace="~{fragments/buttons :: unlockButton('MENU_COMM_007', 'btnUnlock')}"></div>
            <div th:replace="~{fragments/buttons :: saveButton('MENU_COMM_007', 'btnSave')}"></div>
          </div>
        </div>

        <div class="card-body">
          <div id="accountGrid"></div>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Toast UI Grid 방어 코드
    if (!window.tui || !tui.Grid) {
      return;
    }

    let RAW_STATUS_CODES = [];   // CodeDto 목록 그대로
    let STATUS_CODE_ITEMS = [];  // Grid/Select용 {value, text}
    let ACTIVE_CODE_ID = null;   // codeNm = 'ACTIVE' 인 codeId(r1)
    let LOCKED_CODE_ID = null;   // codeNm = 'LOCKED' 인 codeId(r2)
    let accountGrid = null;

    // 영어 코드명을 한글 표시로 매핑
    function toStatusLabel(codeNm) {
      switch (codeNm) {
        case 'ACTIVE':
          return '활성';
        case 'LOCKED':
          return '잠금';
        case 'INACTIVE':
          return '비활성';
        case 'TERMINATED':
          return '구독 해지';
        default:
          return codeNm;
      }
    }

    // -----------------------
    // 1. 계정 상태 공통 코드 조회
    // -----------------------
    function loadStatusCodes() {
      return $.getJSON('/api/lockAcct/status-codes')
        .done(function (codes) {
          RAW_STATUS_CODES = codes || [];

          STATUS_CODE_ITEMS = RAW_STATUS_CODES.map(function (c) {
            return {
              value: c.codeId,               // r1, r2, r3, r4
              text: toStatusLabel(c.codeNm)  // 한글 표시
            };
          });

          // SELECT 박스 옵션 세팅
          const $status = $('#status');
          RAW_STATUS_CODES.forEach(function (c) {
            const label = toStatusLabel(c.codeNm);
            $status.append(
              $('<option>', {
                value: c.codeId,
                text: label
              })
            );
          });

          // ACTIVE 코드 ID 기억 (잠금 해제 시 사용)
          const active = RAW_STATUS_CODES.find(function (c) {
            return c.codeNm === 'ACTIVE';
          });
          if (active) {
            ACTIVE_CODE_ID = active.codeId;
          }

          // LOCKED 코드 ID 기억 (잠금 일시 표시용)
          const locked = RAW_STATUS_CODES.find(function (c) {
            return c.codeNm === 'LOCKED';
          });
          if (locked) {
            LOCKED_CODE_ID = locked.codeId;
          }
        })
        .fail(function () {
          alert('계정 상태 공통코드 조회에 실패했습니다.');
        });
    }

    // -----------------------
    // 2. Grid 생성
    // -----------------------
    function createGrid() {
      const commonGridOptions = {
        bodyHeight: 320,
        scrollX: false,
        scrollY: false,
        rowHeaders: ['checkbox'],     // 좌측 체크박스
        columnOptions: {
          minWidth: 80,
          resizable: true
        }
      };

      accountGrid = new tui.Grid({
        el: document.getElementById('accountGrid'),
        data: [],       // 처음에는 비워두고 조회 시 채움
        ...commonGridOptions,
        columns: [
          { header: '계정PK',     name: 'empAcctId', hidden: true },
          { header: '회사코드',   name: 'vendId',    hidden: true },
          { header: '거래처 명', name: 'clientName', minWidth: 120, sortable: true },
          { header: '계정 ID',   name: 'accountId',  minWidth: 180, sortable: true },
          { header: '사용자 명', name: 'userName',   minWidth: 120 },
          {
            header: '상태',
            name: 'status',    // r1, r2, r3, r4
            minWidth: 90,
            editor: {
              type: 'select',
              options: {
                listItems: STATUS_CODE_ITEMS
              }
            },
            formatter: function ({ value }) {
              const item = STATUS_CODE_ITEMS.find(function (i) {
                return i.value === value;
              });
              return item ? item.text : value;
            }
          },
          {
            header: '잠금 일시',
            name: 'lockTime',
            minWidth: 180,
            align: 'left',      // 기본은 왼쪽 정렬
            formatter: function ({ value, row }) {
              // 상태가 LOCKED 가 아니면 "-" 표시 (가운데 정렬)
              if (!LOCKED_CODE_ID || row.status !== LOCKED_CODE_ID || !value) {
                return '<span class="lock-time-center">-</span>';
              }
              // 날짜인 경우는 그냥 값 그대로 (왼쪽 정렬)
              return value;
            }
          }
        ]
      });

      // 필수 컬럼 표시
      if (window.TeamCommon && TeamCommon.grid && typeof TeamCommon.grid.applyRequiredHeaders === 'function') {
        TeamCommon.grid.applyRequiredHeaders([
          { gridId: 'accountGrid', columns: ['status'] }
        ]);
      }

      // 리사이즈 시 레이아웃 보정
      window.addEventListener('resize', function () {
        accountGrid.refreshLayout();
      });
    }

    // -----------------------
    // 3. 목록 조회 (조회 버튼 눌렀을 때만 호출)
    // -----------------------
    function doSearch() {
      if (!accountGrid) return;

      const params = {
        clientName: $('#clientName').val().trim(),
        accountId: $('#accountId').val().trim(),
        userName: $('#userName').val().trim(),
        status: $('#status').val(),
        lockStartDt: $('.js-date-range-start').val(),
        lockEndDt: $('.js-date-range-end').val()
      };

      $.getJSON('/api/lockAcct/list', params)
        .done(function (list) {
          accountGrid.resetData(list || []);
        })
        .fail(function () {
          alert('잠금 계정 목록 조회 중 오류가 발생했습니다.');
        });
    }

    // -----------------------
    // 4. 잠금 해제 버튼 (바로 DB 반영)
    // -----------------------
    function initUnlockButton() {
      const btnUnlock = document.getElementById('btnUnlock');
      if (!btnUnlock) return;

      btnUnlock.addEventListener('click', function () {
        if (!accountGrid) return;

        // 편집 중인 셀 commit
        accountGrid.finishEditing();

        const checkedRowKeys = accountGrid.getCheckedRowKeys();

        if (checkedRowKeys.length === 0) {
          alert('선택된 계정이 없습니다.');
          return;
        }

        if (!ACTIVE_CODE_ID) {
          alert('활성 상태 코드 정보가 없습니다.');
          return;
        }

        // 서버에 보낼 payload 구성 (선택된 계정 → ACTIVE 코드로)
        const payload = [];
        checkedRowKeys.forEach(function (rowKey) {
          const row = accountGrid.getRow(rowKey);
          if (row) {
            payload.push({
              empAcctId: row.empAcctId,
              status: ACTIVE_CODE_ID
            });
          }
        });

        if (payload.length === 0) {
          alert('선택된 계정이 없습니다.');
          return;
        }

        $.ajax({
          url: '/api/lockAcct/update-status',
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify(payload)
        }).done(function () {
          alert('선택된 계정의 잠금이 해제되었습니다.');
          doSearch();   // 다시 조회해서 화면 동기화
        }).fail(function () {
          alert('잠금 해제 중 오류가 발생했습니다.');
        });
      });
    }

    // -----------------------
    // 5. 저장 버튼 (그리드에서 수정한 상태값 일괄 UPDATE)
    // -----------------------
    function initSaveButton() {
      const btnSave = document.getElementById('btnSave');
      if (!btnSave) return;

      btnSave.addEventListener('click', function () {
        if (!accountGrid) return;

        // 편집 중인 셀 commit
        accountGrid.finishEditing();

        const modified = accountGrid.getModifiedRows();
        const updated = modified.updatedRows || [];

        if (updated.length === 0) {
          alert('변경된 계정이 없습니다.');
          return;
        }

        const payload = updated.map(function (row) {
          return {
            empAcctId: row.empAcctId,
            status: row.status
          };
        });

        $.ajax({
          url: '/api/lockAcct/update-status',
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify(payload)
        }).done(function () {
          alert('계정 상태가 저장되었습니다.');
          accountGrid.clearModifiedData();
          doSearch(); // 최신 데이터 다시 조회
        }).fail(function () {
          alert('계정 상태 저장 중 오류가 발생했습니다.');
        });
      });
    }

    // -----------------------
    // 6. 초기화 / 조회 버튼
    // -----------------------
    function initSearchButtons() {
      $('#btnSearch').on('click', function () {
        doSearch();
      });

      $('#btnReset').on('click', function () {
        $('#clientName').val('');
        $('#accountId').val('');
        $('#userName').val('');
        $('#status').val('');
        $('.js-date-range-start').val('');
        $('.js-date-range-end').val('');

        // 그리드도 비움 (조회는 사용자가 다시 "조회" 눌렀을 때)
        if (accountGrid) {
          accountGrid.resetData([]);
        }
      });
    }

    // -----------------------
    // 7. 자동완성 초기화
    // -----------------------
    function initAutocomplete() {
      if (!window.TeamCommon || !TeamCommon.autocomplete || typeof TeamCommon.autocomplete.init !== 'function') {
        return;
      }

      // 공통 mapResponse: 서버 응답 {id,label,value} -> autocomplete item
      function commonMapResponse(item) {
        return {
          id: item.id,
          label: item.label,
          value: item.value
        };
      }

      // 거래처 명 (GET /api/lockAcct/auto/vendor?keyword=...)
      TeamCommon.autocomplete.init({
        inputSelector: '#clientName',
        listSelector: '#clientNameList',
        url: '/api/lockAcct/auto/vendor',
        paramName: 'keyword',
        minLength: 1,
        delay: 300,
        mapResponse: commonMapResponse,
        onSelect: function (item) {
          $('#clientName').val(item.value);
        }
      });

      // 계정 ID (GET /api/lockAcct/auto/accountId?keyword=...)
      TeamCommon.autocomplete.init({
        inputSelector: '#accountId',
        listSelector: '#accountIdList',
        url: '/api/lockAcct/auto/accountId',
        paramName: 'keyword',
        minLength: 1,
        delay: 300,
        mapResponse: commonMapResponse,
        onSelect: function (item) {
          $('#accountId').val(item.value);
        }
      });

      // 사용자 이름 (GET /api/lockAcct/auto/userName?keyword=...)
      TeamCommon.autocomplete.init({
        inputSelector: '#userName',
        listSelector: '#userNameList',
        url: '/api/lockAcct/auto/userName',
        paramName: 'keyword',
        minLength: 1,
        delay: 300,
        mapResponse: commonMapResponse,
        onSelect: function (item) {
          $('#userName').val(item.value);
        }
      });
    }

    // -----------------------
    // 초기 로딩 플로우
    // 1) 공통코드 조회
    // 2) Grid 생성
    // 3) 버튼, 자동완성 바인딩
    // * 페이지 진입 시에는 조회 안 함
    // -----------------------
    loadStatusCodes().done(function () {
      createGrid();
      initUnlockButton();
      initSaveButton();
      initSearchButtons();
      initAutocomplete();
      // doSearch();  // ▶ 페이지 진입 시 자동 조회 X
    });
  });
</script>

</body>
</html>
