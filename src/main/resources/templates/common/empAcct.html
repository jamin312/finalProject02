<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
  <meta charset="UTF-8">
  <title>ì‚¬ì› ê³„ì • ê´€ë¦¬</title>

  <!-- Toast UI Grid -->
  <link rel="stylesheet"
        href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
  <script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>

  <style>
    .emp-account-wrapper .card-title {
      font-weight: 600;
      font-size: 1.1rem;
    }

    .emp-account-wrapper #empGrid,
    .emp-account-wrapper #roleGrid {
      width: 100%;
      margin-top: 4px;
    }

    .emp-account-wrapper .help-text {
      font-size: 12px;
      color: #6c757d;
    }

    .emp-account-wrapper .card-header-left {
      display: flex;
      align-items: center;
    }

    .emp-account-wrapper .card-header-left .card-title {
      margin-bottom: 0;
    }

    .emp-account-wrapper .tui-grid-header-area .tui-grid-cell-row-header {
      background-color: #f5f5f5;
    }

    .emp-account-wrapper .tui-grid-body-area .tui-grid-cell-row-header {
      background-color: #ffffff;
    }

    .emp-account-wrapper .form-control[readonly],
    .emp-account-wrapper .form-select[disabled] {
      cursor: not-allowed;
      background-color: #f8f9fa;
    }
    
    /* ì—­í•  ì¹´ë“œ ë¹„í™œì„±í™” ìƒíƒœ */
	.emp-account-wrapper .disabled-card {
	  opacity: 0.6;
	  pointer-events: none;
	}
	
	/* ì—­í•  ì—†ìŒ ì•ˆë‚´ ë¬¸êµ¬ */
	.emp-account-wrapper .role-empty-message {
	  font-size: 12px;
	  color: #999;
	}
    
  </style>
</head>

<body layout:fragment="content">
<div class="emp-account-wrapper"
     th:data-vend-id="${session.LOGIN_EMP != null ? session.LOGIN_EMP.vendId : ''}">

  <!-- ================= ì‚¬ì› ì¡°íšŒ ================= -->
  <div class="row">
    <div class="col-md-12 mb-3">
      <div class="card">
        <div class="card-header">
          <div class="card-header-left">
            <h5 class="card-title">ì‚¬ì› ì¡°íšŒ</h5>
          </div>
          <div class="card-header-right">
            <button class="btn btn-dark" type="button" id="btnEmpSearchReset">ì´ˆê¸°í™”</button>
            <button class="btn btn-outline-dark" type="button" id="btnEmpSearch">ì¡°íšŒ</button>
          </div>
        </div>

        <div class="card-body">
          <div class="row mb-2">
            <div class="col-md-3">
              <label for="deptName">ë¶€ì„œ ëª…</label>
              <select id="deptName" class="form-select">
                <option value="">ì „ì²´</option>
                <option th:each="dept : ${deptList}"
                        th:value="${dept.deptNm}"
                        th:text="${dept.deptNm}">
                </option>
              </select>
            </div>
            <div class="col-md-3">
              <label for="jobName">ì§ê¸‰ ëª…</label>
              <select id="jobName" class="form-select">
                <option value="">ì „ì²´</option>
                <option th:each="code : ${jobCodeList}"
                        th:value="${code.codeId}"
                        th:text="${code.codeNm}">
                </option>
              </select>
            </div>

            <div class="col-md-3 position-relative">
              <label for="empName">ì‚¬ì› ì´ë¦„</label>
              <input id="empName"
                     type="text"
                     class="form-control"
                     placeholder="í™ê¸¸ë™"
                     autocomplete="off">

              <ul id="empNameList"
                  class="list-group position-absolute w-100"
                  style="z-index: 2000; max-height: 200px; overflow-y: auto; display:none;"></ul>
            </div>

            <div class="col-md-3 position-relative">
              <label for="accountId">ê³„ì • ID</label>
              <input id="accountId"
                     type="text"
                     class="form-control"
                     placeholder="yedam"
                     autocomplete="off">
              <ul id="accountIdList"
                  class="list-group position-absolute w-100"
                  style="z-index: 2000; max-height: 200px; overflow-y: auto; display:none;"></ul>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- ================= ì‚¬ì› ëª©ë¡ (3ì¤„ ê³ ì • + ìŠ¤í¬ë¡¤) ================= -->
  <div class="row">
    <div class="col-md-12 mb-3">
      <div class="card">
        <div class="card-header">
          <div class="card-header-left">
            <h5 class="card-title me-2">ì‚¬ì› ëª©ë¡</h5>
            <span class="help-text">
              * ì‚¬ì› ëª©ë¡ì—ì„œ ëŒ€ìƒì„ ì„ íƒí•˜ë©´ ì•„ë˜ì—ì„œ ê³„ì •ì„ ìƒì„±Â·ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
              ê³„ì • ìƒíƒœì— ë”°ë¼ ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ ë°œê¸‰ ë° ë¬¸ì ì „ì†¡ ë°©ì‹ì´ ë‹¬ë¼ì§‘ë‹ˆë‹¤.
            </span>
          </div>
          <div class="card-header-right"></div>
        </div>

        <div class="card-body">
          <div id="empGrid"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== ì•„ë˜ í•œ í–‰: ê³„ì • ì •ë³´ + ì—­í•  ì„¤ì • ========== -->
  <div class="row">
    <!-- ì‚¬ì› ê³„ì • ì •ë³´ (ì™¼ìª½) -->
    <div class="col-md-7 mb-3">
      <div class="card h-100">
        <div class="card-header">
          <div class="card-header-left">
            <h5 class="card-title">ì‚¬ì› ê³„ì • ì •ë³´</h5>
          </div>
          <div class="card-header-right">
            <!-- <button type="button" class="btn btn-outline-dark" id="btnEmpAcctSave">ì €ì¥</button> -->
            <div th:replace="~{fragments/buttons :: saveButton('MENU_COMM_003', 'btnEmpAcctSave')}"></div>
          </div>
        </div>

        <div class="card-body">
          <!-- í•„ìš”í•˜ë©´ ê³„ì • PK ì €ì¥ìš© hidden -->
          <input type="hidden" id="empAcctId">

          <!-- 1í–‰: ë¶€ì„œ / ì§ê¸‰ / ì‚¬ë²ˆ -->
          <div class="row mb-2">
            <div class="col-md-4">
              <label>ë¶€ì„œ ëª…</label>
              <input id="empDeptName"
                     type="text"
                     class="form-control form-control-sm"
                     placeholder="YEDAM"
                     readonly>
            </div>
            <div class="col-md-4">
              <label>ì§ê¸‰ ëª…</label>
              <input id="empJobName"
                     type="text"
                     class="form-control form-control-sm"
                     placeholder="ì‚¬ì›"
                     readonly>
            </div>
            <div class="col-md-4">
              <label>ì‚¬ë²ˆ</label>
              <input id="empNo"
                     type="text"
                     class="form-control form-control-sm"
                     placeholder="2511001"
                     readonly>
            </div>
          </div>

          <!-- 2í–‰: ì‚¬ì›ëª… / ì—°ë½ì²˜ / ì´ë©”ì¼ -->
          <div class="row mb-2">
            <div class="col-md-4">
              <label>ì‚¬ì› ëª…</label>
              <input id="empNameDetail"
                     type="text"
                     class="form-control form-control-sm"
                     placeholder="í™ê¸¸ë™"
                     readonly>
            </div>
            <div class="col-md-4">
              <label>ì—°ë½ì²˜</label>
              <input id="empPhone"
                     type="text"
                     class="form-control form-control-sm"
                     placeholder="010-1111-1234"
                     readonly>
            </div>
            <div class="col-md-4">
              <label>ì´ë©”ì¼</label>
              <input id="empEmail"
                     type="email"
                     class="form-control form-control-sm"
                     placeholder="YEDAM@YEDAM.AC"
                     readonly>
            </div>
          </div>

          <!-- 3í–‰: íšŒì‚¬ì½”ë“œ / ì•„ì´ë”” / ê³„ì •ìƒíƒœ -->
          <div class="row mb-2">
            <div class="col-md-4">
              <label>íšŒì‚¬ ì½”ë“œ</label>
              <input id="empCompanyCode"
                     type="text"
                     class="form-control form-control-sm"
                     placeholder="CO_YEDAM001"
                     readonly>
            </div>
            <div class="col-md-4">
              <label id="empLoginIdLabel">ê³„ì •ID</label>
              <input id="empLoginId"
                     type="text"
                     class="form-control form-control-sm"
                     placeholder="HONG@HONG.AC"
                     readonly>
            </div>
            <div class="col-md-4">
              <label class="astar">ê³„ì • ìƒíƒœ</label>
              <select id="empAcctStatus" class="form-select form-select-sm">
                <option value="">-</option>
                <option th:each="code : ${acctStatusList}"
                        th:value="${code.codeId}"
                        th:text="${code.codeNm}">
                </option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ê³„ì • ì—­í•  ì„¤ì • (ì˜¤ë¥¸ìª½) -->
    <div class="col-md-5 mb-3">
      <div class="card h-100 disabled-card" id="roleCard">
        <div class="card-header">
          <div class="card-header-left">
            <h5 class="card-title me-2 mb-0">ê³„ì • ì—­í•  ì„¤ì •</h5>
            <span class="help-text">â€» ê³„ì •ì´ ì¡´ì¬í•  ê²½ìš°, ì„¤ì • ê°€ëŠ¥í•©ë‹ˆë‹¤.</span>
          </div>
          <div class="card-header-right">
            <!-- <button type="button"
                    class="btn btn-outline-dark"
                    id="btnRoleSelectModal">ì—­í•  ì¡°íšŒ</button> -->
            <div th:replace="~{fragments/buttons :: roleButton('MENU_COMM_003', 'btnRoleSelectModal')}"></div>
            <!-- <button type="button" class="btn btn-outline-dark" id="btnRoleSave">ì €ì¥</button> -->
            <div th:replace="~{fragments/buttons :: saveButton('MENU_COMM_003', 'btnRoleSave')}"></div>
            <!-- <button type="button" class="btn btn-danger" id="btnRoleDelete">ì‚­ì œ</button> -->
            <div th:replace="~{fragments/buttons :: deleteButton('MENU_COMM_003', 'btnRoleDelete')}"></div>
          </div>
        </div>

        <div class="card-body">
          <div id="roleGrid"></div>
          <div id="roleEmptyMessage"
		       class="role-empty-message mt-2"
		       style="display:none;">
		    í˜„ì¬ ê³„ì •ì— ì„¤ì •ëœ ì—­í• ì´ ì—†ìŠµë‹ˆë‹¤.<br>
		    [ì—­í•  ì¡°íšŒ] ë²„íŠ¼ìœ¼ë¡œ ì—­í• ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
		  </div>
        </div>
      </div>
    </div>
  </div>

</div>

<div th:replace="common/modal/authModal :: authModal"></div>

<script>
  document.addEventListener('DOMContentLoaded', function () {  
	  
	
	  function setSelectByOptionText($select, text) {
		  if (!text) return;

		  const el = $select && $select[0];
		  if (!el) return;

		  const opts = Array.from(el.options);
		  const found = opts.find(o => (o.textContent || '').trim() === text.trim());
		  if (found) {
		    $select.val(found.value);
		  }
		}

		function applyDeptJobFromItem(item) {
		  // deptName: valueê°€ deptNm
		  if (item.deptNm && item.deptNm.trim() !== '') {
		    $('#deptName').val(item.deptNm);
		  } else {
		    $('#deptName').val(''); // âœ… ì—†ìœ¼ë©´ ì „ì²´
		  }

		  // jobName: value=codeId, text=codeNm(ì§ê¸‰ëª…)
		  if (item.jobNm && item.jobNm.trim() !== '') {
		    setSelectByOptionText($('#jobName'), item.jobNm);
		  } else {
		    $('#jobName').val(''); // âœ… ì—†ìœ¼ë©´ ì „ì²´
		  }
		}
	  
	

    let selectedEmpRow = null;      // í˜„ì¬ ì„ íƒëœ ì‚¬ì› í–‰ ë°ì´í„°
    let selectedEmpRowKey = null;   // í˜„ì¬ ì„ íƒëœ ê·¸ë¦¬ë“œ rowKey

    // ğŸ”¹ ì„ íƒëœ ì‚¬ì›ì˜ "ê¸°ì¤€ ìŠ¤ëƒ…ìƒ·" (ë§ˆì§€ë§‰ ë¡œë”©/ì €ì¥ ì‹œì )
    let selectedEmpSnapshot = {
      status: null,   // acctStatus (r1/r2/r3/...)
      roleIds: []     // ë§ˆì§€ë§‰ ì €ì¥/ë¡œë”© ì‹œ ì—­í•  ID ëª©ë¡
    };

    // ==========================
    // 0. Toast Grid ì¡´ì¬ ì—¬ë¶€ ì²´í¬
    // ==========================
    if (!window.tui || !tui.Grid) {
      console.warn('tui.Grid not loaded');
      return;
    }

    // ==========================
    // 1. ê³µí†µ ìƒìˆ˜ ì •ì˜
    // ==========================
    const STATUS_ACTIVE   = 'r1'; // ì‚¬ìš©
    const STATUS_LOCKED   = 'r2'; // ì ê¸ˆ
    const STATUS_INACTIVE = 'r3'; // ë¹„í™œì„±
    const STATUS_END      = 'r4'; // í•´ì§€(ì´ í™”ë©´ì—ì„œëŠ” ìˆ¨ê¹€ ì²˜ë¦¬)

    const EMP_SEARCH_URL     = '/api/empAcct/employees';
    const EMP_SAVE_URL       = '/api/empAcct/save';
    const EMP_ROLE_LIST_URL  = '/api/empAcct/roles';

    // ==========================
    // 2. ì„¸ì…˜ vendId (íšŒì‚¬ ì½”ë“œ) ì½ê¸°
    // ==========================
    const wrapper = document.querySelector('.emp-account-wrapper');
    const SESSION_VEND_ID = wrapper ? (wrapper.dataset.vendId || '') : '';

    // ==========================
    // 3. jQuery ì—˜ë¦¬ë¨¼íŠ¸ ìºì‹±
    // ==========================
    const $deptName   = $('#deptName');
    const $jobName    = $('#jobName');
    const $empName    = $('#empName');
    const $accountId  = $('#accountId');
    const $btnSearch  = $('#btnEmpSearch');
    const $btnReset   = $('#btnEmpSearchReset');

    const $empAcctId       = $('#empAcctId');
    const $empDeptName     = $('#empDeptName');
    const $empJobName      = $('#empJobName');
    const $empNo           = $('#empNo');
    const $empNameDetail   = $('#empNameDetail');
    const $empPhone        = $('#empPhone');
    const $empEmail        = $('#empEmail');
    const $empCompanyCode  = $('#empCompanyCode');
    const $empLoginId      = $('#empLoginId');
    const $empAcctStatus   = $('#empAcctStatus');
    const $empLoginIdLabel = $('#empLoginIdLabel');

    const $btnSaveAcct   = $('#btnEmpAcctSave');
    const $btnRoleSave   = $('#btnRoleSave');
    const $btnRoleDelete = $('#btnRoleDelete');
    
    const $roleCard     = $('#roleCard');
    const $roleEmptyMsg = $('#roleEmptyMessage');

    if (SESSION_VEND_ID) {
      $empCompanyCode.val(SESSION_VEND_ID);
    }

    // ==========================
    // 4. Grid ì˜µì…˜
    // ==========================
    const rowHeight = 40;

    const empGridOptions = {
      bodyHeight: rowHeight * 3,   // 3ì¤„ ê³ ì • + ìŠ¤í¬ë¡¤
      rowHeight: rowHeight,
      scrollX: false,
      scrollY: true,
      columnOptions: {
        minWidth: 80,
        resizable: true
      }
    };

    const roleGridOptions = {
      ...empGridOptions,
      bodyHeight: rowHeight * 4
    };

    // ==========================
    // 5. ìƒíƒœ ì½”ë“œ â†’ í•œê¸€ ë¼ë²¨
    // ==========================
    function toStatusLabel(code) {
      switch (code) {
        case STATUS_ACTIVE:   return 'ì‚¬ìš©';
        case STATUS_LOCKED:   return 'ì ê¸ˆ';
        case STATUS_INACTIVE: return 'ë¹„í™œì„±';
        case STATUS_END:      return '-';   // TERMINATED ìˆ¨ê¹€
        default:              return '-';
      }
    }

    // ==========================
    // 6. ì‚¬ì› ëª©ë¡ Grid
    // ==========================
    const empGrid = new tui.Grid({
      el: document.getElementById('empGrid'),
      data: [],
      rowHeaders: [],
      ...empGridOptions,
      columns: [
        { header: 'ë¶€ì„œ ëª…',        name: 'deptName',   minWidth: 80 },
        { header: 'ì§ê¸‰ ëª…',        name: 'jobName',    minWidth: 80 },
        { header: 'ì‚¬ë²ˆ',           name: 'empNo',      minWidth: 100 },
        { header: 'ì‚¬ì› ëª…',        name: 'empName',    minWidth: 120 },
        { header: 'ê³„ì • ì¡´ì¬ ìœ ë¬´', name: 'hasAccount', width: 110 },
        { header: 'ê³„ì • ìƒíƒœ',      name: 'status',     minWidth: 100 },
        { header: 'ê¶Œí•œ(ì—­í• ) ìœ ë¬´', name: 'hasRole', width: 110 }
      ]
    });

    // ==========================
    // 7. ê³„ì • ì—­í•  Grid
    // ==========================
    const roleGrid = new tui.Grid({
      el: document.getElementById('roleGrid'),
      data: [],
      rowHeaders: ['checkbox'],
      ...roleGridOptions,
      columns: [
        { header: 'ì—­í•  ID',   name: 'roleId',   hidden: true },
        { header: 'ì—­í•  ëª…',   name: 'roleName', minWidth: 100 },
        { header: 'ì—­í•  ìœ í˜•', name: 'roleType', minWidth: 90 },
        { header: 'ì‚¬ìš© ì—¬ë¶€', name: 'roleYn',   minWidth: 60 }
      ]
    });

    // ì²´í¬ ìƒíƒœë¥¼ ë³„ë„ ì»¬ëŸ¼ì— ìœ ì§€ (í•„ìš” ì‹œ ì‚¬ìš©í•  ìˆ˜ ìˆìŒ)
    roleGrid.on('check', function (ev) {
      roleGrid.setValue(ev.rowKey, 'checked', true, false);
    });
    roleGrid.on('uncheck', function (ev) {
      roleGrid.setValue(ev.rowKey, 'checked', false, false);
    });
    roleGrid.on('checkAll', function () {
      roleGrid.getData().forEach(function (row) {
        roleGrid.setValue(row.rowKey, 'checked', true, false);
      });
    });
    roleGrid.on('uncheckAll', function () {
      roleGrid.getData().forEach(function (row) {
        roleGrid.setValue(row.rowKey, 'checked', false, false);
      });
    });
	
	// ==========================
	// ì—­í•  ì¹´ë“œ í™œì„±/ë¹„í™œì„± í† ê¸€
	// ==========================
	function setRoleCardEnabled(enabled) {
	  if (enabled) {
	    $roleCard.removeClass('disabled-card');
	    $btnRoleSave.prop('disabled', false);
	    $btnRoleDelete.prop('disabled', false);
	  } else {
	    $roleCard.addClass('disabled-card');
	    $btnRoleSave.prop('disabled', true);
	    $btnRoleDelete.prop('disabled', true);
	  }
	}

    // ==========================
    // 8. ìƒì„¸ ì˜ì—­ ì´ˆê¸°í™”
    // ==========================
    function clearEmpDetail() {
      selectedEmpRow = null;
      selectedEmpRowKey = null;

      selectedEmpSnapshot = {
        status: null,
        roleIds: []
      };

      $empAcctId.val('');
      $empDeptName.val('');
      $empJobName.val('');
      $empNo.val('');
      $empNameDetail.val('');
      $empPhone.val('');
      $empEmail.val('');
      $empCompanyCode.val(SESSION_VEND_ID || '');
      $empLoginId.val('');
      $empLoginId.prop('readonly', true);
      $empLoginIdLabel.removeClass('astar');
      $empAcctStatus.val('');
      roleGrid.resetData([]);
      
      setRoleCardEnabled(false);
      $roleEmptyMsg.hide();
    }

    // ==========================
    // 9. ì‚¬ì› ê³„ì • ì—­í•  ëª©ë¡ ì¡°íšŒ
    // ==========================
    function loadEmpRoles(empAcctId) {
	  if (!empAcctId) {
	    roleGrid.resetData([]);
	    selectedEmpSnapshot.roleIds = [];
	    // ê³„ì • ìì²´ê°€ ì—†ìœ¼ë©´ ì•ˆë‚´ ë¬¸êµ¬ë„ ìˆ¨ê²¨ë‘”ë‹¤
	    $roleEmptyMsg.hide();
	    return;
	  }
	
	  $.getJSON(EMP_ROLE_LIST_URL, { empAcctId: empAcctId }, function (list) {
	
	    // ğŸ”¹ ì—­í• ì´ í•˜ë‚˜ë„ ì—†ì„ ë•Œ
	    if (!list || list.length === 0) {
	      roleGrid.resetData([]);
	      selectedEmpSnapshot.roleIds = [];
	      $roleEmptyMsg.show();
	      return;
	    }
	
	    $roleEmptyMsg.hide();
	
	    const rows = (list || []).map(function (r) {
	      return {
	        roleId  : r.roleId,
	        roleName: r.roleNm,
	        roleType: r.roleTyNm,
	        roleYn  : (r.useYn === 'e1') ? 'ì‚¬ìš©' : 'ë¯¸ì‚¬ìš©',
	        checked : true
	      };
	    });
	
	    roleGrid.resetData(rows);
	
	    roleGrid.getData().forEach(function (row) {
	      roleGrid.check(row.rowKey);
	    });
	
	    const roleIds = rows
	      .map(r => r.roleId)
	      .filter(id => !!id);
	
	    selectedEmpSnapshot.roleIds = roleIds;
	
	  }).fail(function (xhr) {
	    console.error('ì‚¬ì› ê³„ì • ì—­í•  ì¡°íšŒ ì‹¤íŒ¨', xhr);
	    roleGrid.resetData([]);
	    selectedEmpSnapshot.roleIds = [];
	    $roleEmptyMsg.hide();
	  });
	}

    // ==========================
    // 10. ì‚¬ì› ëª©ë¡ ì¡°íšŒ
    // ==========================
    function fetchEmpList() {
      const params = {
        vendId:   SESSION_VEND_ID,
        deptName: $deptName.val()  || '',
        jobName:  $jobName.val()   || '',
        empName:  $empName.val()   || '',
        loginId:  $empAcctId.val() || ''
      };

      $.getJSON(EMP_SEARCH_URL, params, function (list) {
        const rows = (list || []).map(function (emp) {
          const hasLogin = !!emp.loginId;
          
          const roleCnt  = emp.roleCnt ?? 0;

          let hasRoleDisp = '-';
          if (hasLogin) {
            hasRoleDisp = (roleCnt > 0) ? 'Y' : 'N';
          }

          return {
            deptName:   emp.deptNm,
            jobName:    emp.jobNm,
            empNo:      emp.empId,
            empName:    emp.nm,
            hasAccount: hasLogin ? 'Y' : 'N',
            hasRole:    hasRoleDisp, 
            status:     hasLogin ? toStatusLabel(emp.acctStatus) : '-',

            empAcctId:  emp.empAcctId || null,
            phone:      emp.cttpc,
            email:      emp.email,
            loginId:    emp.loginId,
            acctStatus: emp.acctStatus,  // r1/r2/r3/r4
            vendId:     emp.vendId
          };
        });

        empGrid.resetData(rows);
        clearEmpDetail();
        
        console.log('rows length=', rows.length);
        setTimeout(()=> console.log('grid data length(after 300ms)=', empGrid.getData().length), 300);
      }).fail(function (xhr) {
        console.error('ì‚¬ì› ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨', xhr);
        empGrid.resetData([]);
        clearEmpDetail();
      });
    }

    $btnSearch.on('click', fetchEmpList);

    $btnReset.on('click', function () {
      $deptName.val('');
      $jobName.val('');
      $empName.val('');
      $accountId.val('');
      empGrid.resetData([]);
      clearEmpDetail();
    });

    // ==========================
    // 11. ì‚¬ì› Grid í–‰ í´ë¦­ â†’ ìƒì„¸ ì±„ìš°ê¸° + ì—­í•  ê·¸ë¦¬ë“œ ì±„ìš°ê¸°
    // ==========================
    empGrid.on('click', function (ev) {
      const row = empGrid.getRow(ev.rowKey);
      if (!row) return;

      selectedEmpRow = row;
      selectedEmpRowKey = ev.rowKey;

      roleGrid.resetData([]);

      $empDeptName.val(row.deptName || '');
      $empJobName.val(row.jobName || '');
      $empNo.val(row.empNo || '');
      $empNameDetail.val(row.empName || '');
      $empPhone.val(row.phone || '');
      $empEmail.val(row.email || '');

      const companyCode = row.vendId || SESSION_VEND_ID || '';
      $empCompanyCode.val(companyCode);

      $empAcctId.val(row.empAcctId || '');

      if (!row.loginId) {
    	  // ==========================
    	  // ê³„ì •ì´ ì•„ì§ ì—†ìŒ â†’ ì‹ ê·œ ìƒì„± ëª¨ë“œ
    	  // ==========================
    	  $empLoginId.val('');
    	  $empLoginId.prop('readonly', false);
    	  $empLoginIdLabel.addClass('astar');

    	  $empAcctStatus.val('r1');      // ê¸°ë³¸ê°’ ì‚¬ìš©(r1)

    	  roleGrid.resetData([]);

    	  // ğŸ”¹ ê³„ì •ì´ ì—†ìœ¼ë¯€ë¡œ ì—­í•  ì¹´ë“œ ë¹„í™œì„± + ì•ˆë‚´ ìˆ¨ê¹€
    	  setRoleCardEnabled(false);
    	  $roleEmptyMsg.hide();

    	  selectedEmpSnapshot = {
    	    status: null,
    	    roleIds: []
    	  };

    	} else {
    	  // ==========================
    	  // ê¸°ì¡´ ê³„ì • ìˆìŒ â†’ ìˆ˜ì • ëª¨ë“œ
    	  // ==========================
    	  $empLoginId.val(row.loginId || '');
    	  $empLoginId.prop('readonly', true);
    	  $empLoginIdLabel.removeClass('astar');

    	  $empAcctStatus.val(row.acctStatus || '');

    	  selectedEmpSnapshot = {
    	    status: row.acctStatus || '',
    	    roleIds: []
    	  };

    	  // ğŸ”¹ ê³„ì •ì´ ìˆìœ¼ë¯€ë¡œ ì—­í•  ì¹´ë“œ í™œì„±í™”
    	  setRoleCardEnabled(true);
    	  $roleEmptyMsg.hide();

    	  // ğŸ”¹ ì´ ê³„ì •(empAcctId)ì˜ ì—­í•  ëª©ë¡ ì¡°íšŒí•´ì„œ ê·¸ë¦¬ë“œì— ì„¸íŒ…
    	  loadEmpRoles(row.empAcctId);
    	}
    });

    // ==========================
    // 12. ì €ì¥ ì „ ì•ˆë‚´ ë©”ì‹œì§€ êµ¬ì„± (ì¼ë°˜ ì €ì¥ìš©)
    // ==========================
    function buildSaveConfirmMessage(
      isNew,
      prevStatus,
      newStatus,
      empName,
      phone,
      vendId,
      loginId,
      roleCount
    ) {
      const prevLabel = prevStatus ? toStatusLabel(prevStatus) : '-';
      const newLabel  = toStatusLabel(newStatus);
      const phoneDisp = phone || 'ì—°ë½ì²˜ ë¯¸ë“±ë¡';

      let msg = '';

      if (isNew) {
        msg += '[ì‹ ê·œ ê³„ì • ìƒì„±]\n';
        msg += 'ì‚¬ì›: ' + empName + '\n';
        msg += 'íšŒì‚¬ì½”ë“œ: ' + vendId + '\n';
        msg += 'ID: ' + loginId + '\n';
        msg += 'ê³„ì • ìƒíƒœ: ' + newLabel + '\n';
        msg += 'ì—­í•  ìˆ˜: ' + roleCount + 'ê°œ\n\n';

        if (newStatus === STATUS_ACTIVE) {
          msg += 'â†’ ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ê°€ ìƒì„±ë˜ë©°,\n';
          msg += '  ì‚¬ì›ì˜ ì—°ë½ì²˜(' + phoneDisp + ')ë¡œ ë¬¸ì ë°œì†¡ë©ë‹ˆë‹¤.\n\n';
        } else {
          msg += 'â†’ ë¬¸ì ë°œì†¡ ì—†ì´ ê³„ì •ë§Œ ìƒì„±ë©ë‹ˆë‹¤.\n\n';
        }
      } else {
        msg += '[ê³„ì • ìƒíƒœ / ì—­í•  ë³€ê²½]\n';
        msg += 'ì‚¬ì›: ' + empName + '\n';
        msg += 'í˜„ì¬ ìƒíƒœ: ' + prevLabel + '\n';
        msg += 'ë³€ê²½ í›„ ìƒíƒœ: ' + newLabel + '\n';
        msg += 'ì—­í•  ìˆ˜: ' + roleCount + 'ê°œ\n\n';

        if (prevStatus !== STATUS_ACTIVE && newStatus === STATUS_ACTIVE) {
          msg += 'â†’ ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ê°€ ìƒˆë¡œ ìƒì„±ë˜ê³ ,\n';
          msg += '  ì‚¬ì›ì˜ ì—°ë½ì²˜(' + phoneDisp + ')ë¡œ ë¬¸ì ë°œì†¡ë©ë‹ˆë‹¤.\n\n';
        } else if (prevStatus === STATUS_ACTIVE && newStatus === STATUS_ACTIVE) {
          msg += 'â†’ ìƒíƒœëŠ” ì´ë¯¸ "ì‚¬ìš©"ì…ë‹ˆë‹¤. ë¹„ë°€ë²ˆí˜¸ëŠ” ë³€ê²½ë˜ì§€ ì•Šê³ ,\n';
          msg += '  ì—­í•  ì •ë³´ë§Œ ë³€ê²½ë©ë‹ˆë‹¤.\n\n';
        } else {
          msg += 'â†’ ë¬¸ì ë°œì†¡ ì—†ì´ ìƒíƒœ/ì—­í• ë§Œ ë³€ê²½ë©ë‹ˆë‹¤.\n\n';
        }
      }

      msg += 'ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
      return msg;
    }

    // ==========================
    // 13. ì—­í•  ID ìˆ˜ì§‘
    // ==========================
    function collectRoleIds() {
      const rows = roleGrid.getData();
      if (!rows || rows.length === 0) {
        return [];
      }

      return rows
        .map(r => r.roleId)
        .filter(id => !!id);
    }

    // ==========================
    // 14. ë³€ê²½ ì—¬ë¶€ ë¹„êµ í•¨ìˆ˜
    // ==========================
    function isNoChange(prevStatus, newStatus, prevRoleIds, newRoleIds) {
      const s1 = prevStatus || '';
      const s2 = newStatus  || '';

      if (s1 !== s2) {
        return false;
      }

      const a1 = (prevRoleIds || []).slice().sort();
      const a2 = (newRoleIds  || []).slice().sort();

      if (a1.length !== a2.length) {
        return false;
      }

      for (let i = 0; i < a1.length; i++) {
        if (a1[i] !== a2[i]) {
          return false;
        }
      }
      return true;
    }

    // ==========================
    // 15. ê³µí†µ ì €ì¥ í•¨ìˆ˜
    //    skipConfirm = true ì´ë©´ confirm/ì•Œë¦¼ ìµœì†Œí™” (ì‚­ì œ ì´í›„ ìë™ ì €ì¥ìš©)
    // ==========================
    function doSave(skipConfirm) {

      if (!selectedEmpRow) {
        alert('ë¨¼ì € ì‚¬ì›ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.');
        return;
      }

      const vendId   = ($empCompanyCode.val() || '').trim();
      const empId    = ($empNo.val() || '').trim();
      const loginId  = ($empLoginId.val() || '').trim();
      const acctSt   = $empAcctStatus.val();

      const empName  = $empNameDetail.val() || selectedEmpRow.empName || '';
      const phone    = $empPhone.val() || selectedEmpRow.phone || '';

      if (!vendId || !empId) {
        alert('íšŒì‚¬ ì½”ë“œ ë˜ëŠ” ì‚¬ë²ˆ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const isNew      = !selectedEmpRow.loginId;
      const prevStatus = selectedEmpSnapshot.status;
      const prevRoles  = selectedEmpSnapshot.roleIds || [];

      if (isNew && !loginId) {
        alert('ì‹ ê·œ ê³„ì • ìƒì„± ì‹œ ê³„ì • IDë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
        return;
      }

      if (!acctSt) {
        alert('ê³„ì • ìƒíƒœë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.');
        return;
      }

      const roleIds = collectRoleIds();

      if (!isNew && isNoChange(prevStatus, acctSt, prevRoles, roleIds)) {
        if (!skipConfirm) {
          alert('ë³€ê²½ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
        }
        return;
      }

      if (!skipConfirm) {
        const confirmMsg = buildSaveConfirmMessage(
          isNew,
          prevStatus,
          acctSt,
          empName,
          phone,
          vendId,
          loginId,
          roleIds.length
        );

        if (!confirm(confirmMsg)) {
          return;
        }
      }

      const payload = {
        empAcctId: $empAcctId.val() || null,
        vendId:    vendId,
        empId:     empId,
        loginId:   loginId,
        acctStatus: acctSt,
        roleIds:   roleIds
      };

      console.log('>>> /api/empAcct/save ìš”ì²­ payload', payload);

      $.ajax({
        url: EMP_SAVE_URL,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(payload)
      }).done(function (res) {

    	  // âœ… ì‹¤íŒ¨ ì‘ë‹µ ì²˜ë¦¬ (ì—ëŸ¬ì½”ë“œ/ë©”ì‹œì§€ ìˆìœ¼ë©´ ê·¸ê±¸ ìš°ì„  ì‚¬ìš©)
    	  if (!res || res.success !== true) {

    	    // ì¤‘ë³µ ì•„ì´ë””(=UQ_EMP_ACCT_VEND_LOGIN)ì¼ ë•Œ ì•ˆë‚´ ë¬¸êµ¬
    	    if (res && res.errorCode === 'DUP_LOGIN_ID') {
    	      alert(res.errorMessage || 'ì¤‘ë³µëœ ì•„ì´ë””ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    	      // ì‹ ê·œ ìƒì„± ëª¨ë“œë©´ ì…ë ¥ì¹¸ì— í¬ì»¤ìŠ¤
    	      $('#empLoginId').focus();
    	      return;
    	    }

    	    // ê·¸ ì™¸ ì‹¤íŒ¨
    	    alert((res && res.errorMessage) ? res.errorMessage : 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
    	    return;
    	  }

    	  // âœ… ì—¬ê¸°ë¶€í„°ëŠ” ê¸°ì¡´ ì„±ê³µ ë¡œì§ ê·¸ëŒ€ë¡œ
    	  const newStatus = res.acctStatus || acctSt;

    	  if (res.empAcctId) {
    	    $empAcctId.val(res.empAcctId);
    	    selectedEmpRow.empAcctId = res.empAcctId;
    	  }

    	  if (selectedEmpRowKey != null) {
    	    empGrid.setValue(selectedEmpRowKey, 'hasAccount', 'Y');
    	    empGrid.setValue(selectedEmpRowKey, 'status', toStatusLabel(newStatus));

    	    const roleCountNow = (payload.roleIds || []).length;
    	    empGrid.setValue(selectedEmpRowKey, 'hasRole', roleCountNow > 0 ? 'Y' : 'N');
    	  }

    	  selectedEmpRow.loginId    = loginId;
    	  selectedEmpRow.acctStatus = newStatus;

    	  selectedEmpSnapshot = {
    	    status: newStatus,
    	    roleIds: roleIds.slice()
    	  };

    	  $empAcctStatus.val(newStatus);
    	  $empLoginId.prop('readonly', true);
    	  $empLoginIdLabel.removeClass('astar');

    	  if (!skipConfirm) {
    	    let msg = 'ê³„ì • ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n';

    	    if (res.smsSent) {
    	      msg += '- ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ ì•ˆë‚´ ë¬¸ìê°€ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.';
    	    } else {
    	      msg += '- ë¬¸ì ë°œì†¡ ì—†ì´ ìƒíƒœ/ì—­í• ë§Œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.';
    	    }

    	    alert(msg);
    	  } else {
    	    console.log('ì—­í• /ê³„ì • ë³€ê²½ ìë™ ì €ì¥ ì™„ë£Œ');
    	  }

    	}).fail(function (xhr) {
    	  console.error('ê³„ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜', xhr);
    	  alert('ê³„ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    	});
      
      if (isNew) {
    	setRoleCardEnabled(true);
      }
    }

    // ==========================
    // 16. ê³„ì • + ì—­í•  ì €ì¥ ë²„íŠ¼
    // ==========================
    if ($btnSaveAcct.length) {
      $btnSaveAcct.on('click', function () {
        doSave(false);   // ì¼ë°˜ ì €ì¥: ì•ˆë‚´/confirm í‘œì‹œ
      });
    }

    // ==========================
    // 17. ê³„ì • ì—­í•  ì €ì¥ ë²„íŠ¼ (ì˜¤ë¥¸ìª½ "ì €ì¥")
    // ==========================
    $btnRoleSave.on('click', function () {

      if (!selectedEmpRow) {
        alert('ë¨¼ì € ì‚¬ì›ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.');
        return;
      }

      if (!$empAcctId.val()) {
        alert('ê³„ì •ì´ ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\nì¢Œì¸¡ [ì‚¬ì› ê³„ì • ì •ë³´]ì—ì„œ ë¨¼ì € ê³„ì •ì„ ì €ì¥í•´ ì£¼ì„¸ìš”.');
        return;
      }

      // doSave ë‚´ë¶€ì—ì„œ ë³€ê²½ ìœ ë¬´ ì²´í¬ í›„ ì•Œì•„ì„œ ì €ì¥
      doSave(false);
    });

    // ==========================
    // 18. ê³„ì • ì—­í•  ì‚­ì œ ë²„íŠ¼
    //     â†’ ê·¸ë¦¬ë“œì—ì„œ ì‚­ì œ í›„, ê³§ë°”ë¡œ DBê¹Œì§€ ì €ì¥(doSave(true))
    // ==========================
    $btnRoleDelete.on('click', function () {

      if (!selectedEmpRow) {
        alert('ë¨¼ì € ì‚¬ì›ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.');
        return;
      }

      if (!$empAcctId.val()) {
        alert('ê³„ì •ì´ ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\nì¢Œì¸¡ [ì‚¬ì› ê³„ì • ì •ë³´]ì—ì„œ ë¨¼ì € ê³„ì •ì„ ì €ì¥í•´ ì£¼ì„¸ìš”.');
        return;
      }

      const checkedRows = roleGrid.getCheckedRows();
      if (!checkedRows || checkedRows.length === 0) {
        alert('ì‚­ì œí•  ì—­í• ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.');
        return;
      }

      if (!confirm('ì„ íƒí•œ ì—­í• ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì‚­ì œ í›„ ë°”ë¡œ DBì— ë°˜ì˜ë©ë‹ˆë‹¤.)')) {
        return;
      }

      // rowKey í° ìˆœì„œëŒ€ë¡œ ì‚­ì œ (ì¸ë±ìŠ¤ ê¼¬ì„ ë°©ì§€)
      const rowKeys = checkedRows
        .map(r => r.rowKey)
        .sort(function (a, b) { return b - a; });

      rowKeys.forEach(function (rowKey) {
        roleGrid.removeRow(rowKey);
      });

      roleGrid.uncheckAll();
      
      const remain = roleGrid.getData();
      $roleEmptyMsg.toggle(!remain || remain.length === 0);

      // ì‚­ì œ ì§í›„ ìë™ ì €ì¥ (ì¶”ê°€ confirm ì—†ìŒ)
      doSave(true);
    });

    // ==========================
    // 19. ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ë ˆì´ì•„ì›ƒ ë³´ì •
    // ==========================
    window.addEventListener('resize', function () {
      empGrid.refreshLayout();
      roleGrid.refreshLayout();
    });

    // ==========================
    // 20. ì—­í•  ì„ íƒ ëª¨ë‹¬(authModal) ì—°ë™
    // ==========================
    const btnRoleSelect = document.getElementById('btnRoleSelectModal');
    if (btnRoleSelect) {
      btnRoleSelect.addEventListener('click', function () {
        const current    = roleGrid.getData() || [];
        const checkedIds = current
          .map(r => r.roleId)
          .filter(Boolean);

        if (!window.authModal) {
          alert('ì—­í•  ì„ íƒ ëª¨ë‹¬ ìŠ¤í¬ë¦½íŠ¸(authModal.js)ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
          return;
        }

        authModal.open({
          checkedRoleIds: checkedIds,
          onSelect: function (roles) {
            const newRows = roles.map(function (r) {
              return {
                roleId:   r.roleId,
                roleName: r.roleNm,
                roleType: r.roleTyNm,
                roleYn:   'ì‚¬ìš©',
                checked:  true
              };
            });

            roleGrid.resetData(newRows);

            roleGrid.getData().forEach(function (row) {
              roleGrid.check(row.rowKey);
            });
          $roleEmptyMsg.toggle(newRows.length === 0);
          }
        });
      });
    }

    // ==========================
    // 21. ìë™ì™„ì„±(ì‚¬ì› ì´ë¦„ / ê³„ì • ID)
    // ==========================
    if (window.TeamCommon && TeamCommon.autocomplete) {

      TeamCommon.autocomplete.init({
        inputSelector: '#empName',
        listSelector:  '#empNameList',
        url:           '/api/empAcct/autocomplete/empName',
        paramName:     'keyword',
        minLength:     1,
        delay:         300,
        mapResponse: function (item) {
       	  return {
	       	    nm: item.nm,
	       	    loginId: item.loginId,
	       	    deptNm: item.deptNm,
	       	    jobNm: item.jobNm,
	       	    clsf: item.clsf,
       		    label: '[' + item.empId + '] ' + item.nm + ' / ' + (item.deptNm || '') + ' / ' + (item.jobNm || ''),
       		    value: item.nm,
       		  };
        },
        onSelect: function (item) {
        	  $('#empName').val(item.nm || '');          // âœ… ì´ë¦„ì€ nm
        	  $('#accountId').val(item.loginId || '');  // âœ… ê³„ì •ì€ loginId

        	  // ë¶€ì„œ/ì§ê¸‰: ì—†ìœ¼ë©´ ì „ì²´ë¡œ
        	  applyDeptJobFromItem(item);
        	  fetchEmpList();
        	}
      });

      TeamCommon.autocomplete.init({
        inputSelector: '#accountId',
        listSelector:  '#accountIdList',
        url:           '/api/empAcct/autocomplete/loginId',
        paramName:     'keyword',
        minLength:     1,
        delay:         300,
        mapResponse: function (item) {
       	  return {
       		    id: item.empId,
       		    label: item.loginId + ' / ' + item.nm + ' / ' + (item.deptNm || '') + ' / ' + (item.jobNm || ''),
       		    value: item.loginId,
       		    empName: item.nm,
       		    deptNm: item.deptNm,
       		    jobNm: item.jobNm
       		  };
        },
        onSelect: function (item) {
          $('#accountId').val(item.loginId || '');  // âœ… ê³„ì •ì€ loginId
          $('#empName').val(item.nm || '');         // âœ… ì´ë¦„ì€ nm
       	  applyDeptJobFromItem(item);
       	  fetchEmpList();
       	}
      });

    } else {
      console.warn('TeamCommon.autocomplete ê°€ ì—†ìŠµë‹ˆë‹¤. teamUtil.js ë¡œë”© ì—¬ë¶€ í™•ì¸');
    }

  });
</script>

<script src="/assets/js/authModal.js"></script>

</body>
</html>
