<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout}">
<head>
<meta charset="UTF-8">
<title>mlss.html</title>
  
<!-- âœ… Date / Time Picker -->
  <link rel="stylesheet"
        href="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.css">
<!-- âœ… Grid -->
  <link rel="stylesheet"
        href="https://uicdn.toast.com/grid/latest/tui-grid.css">
  
<style>
.form-select {
	color: #000 !important;
}
/* ì¶”ê°€ CSS */
.readonly-input[readonly] {
	background-color: #e9ecef; /* Bootstrap ê¸°ë³¸ disabled ìƒ‰ìƒ */
	cursor: not-allowed; /* ë§ˆìš°ìŠ¤ ì»¤ì„œë„ ì…ë ¥ ë¶ˆê°€ ëŠë‚Œ */
}

.stIsShow {
	display: none;
}

.menu-item {
	cursor: pointer; /* ë§ˆìš°ìŠ¤ ì˜¬ë¦¬ë©´ ì†ê°€ë½ ëª¨ì–‘ */
}
</style>
</head>
<body layout:fragment="content">	

	<div class="card mb-3">
		<div
			class="card-header d-flex justify-content-between align-items-center">
			<h5 id="buseo" class="card-title mb-0">ë¶€ì„œ ê´€ë¦¬</h5>
			<div>
				<button id="reset" class="btn btn-outline-dark">ì´ˆê¸°í™”</button>
				<!-- <button id="mlssAdd" class="btn btn-outline-dark">í–‰ ì¶”ê°€</button> -->
				<div th:replace="~{fragments/buttons :: addRowButton('MENU_HR_006', 'mlssAdd')}"></div>
				<!-- <button id="mlssRegist" class="btn btn-outline-dark">ì €ì¥</button> -->
				<div th:replace="~{fragments/buttons :: saveButton('MENU_HR_006', 'mlssRegist')}"></div>
				<!-- <button class="btn btn-outline-dark">ì‚­ì œ</button> -->
				<div th:replace="~{fragments/buttons :: deleteButton('MENU_HR_006', 'del')}"></div>
			</div>
		</div>
		<div class="card-body">
			<div id="toastGrid" style="margin: 20px;"></div>
		</div>
	</div>
	<!-- âœ… Date / Time Picker -->
<script src="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.js"></script>
<!-- âœ… Grid -->
<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>
<script th:inline="javascript">	

	let lastAddedRowKey = null;
	$("#reset").on("click", function () {
		n = 0;
		n2 = 0;
		grid.resetData(deptVOList);
	});
	let buseoBtn = $("#buseo");
	buseoBtn.on("click", function () {
		console.log("ë¦¬í”„ë ˆì‹œë˜ë‚˜?");
		grid.refreshLayout();
	});
	let deptVOList = [[${deptVOList}]];
	let nonManager = [[${nonManagerData}]];	
	console.log(deptVOList);
	console.log(nonManager);
	const grid = new tui.Grid({
		  el: $("#toastGrid")[0],
		  data: deptVOList,		  
		  editingType: 'cell',
		  bodyHeight: 440,
		  scrollX: false,
		  scrollY: true,
		  rowHeaders: ['checkbox'],
		  columnOptions: {
		    minWidth: 80,
		    resizable: true
		  },
		  columns: [
		    { header: 'ë¶€ì„œID', name: 'deptId', hidden: true},
		    { header: 'ì‚¬ì›ID', name: 'empId', hidden: true},		 
		    { header: 'ìƒìœ„ë¶€ì„œID', name: 'uprDeptId', hidden: true },
		    { header: 'ë¶€ì„œ ëª…', name: 'deptNm', editor: 'text'},
		    { header: 'ë¶€ì„œ ì¥', name: 'nm', editor: {
		        type: 'select',
		        options: {
		            listItems: nonManager.map(item => ({
		                text: item.nm,
		                value: item.nm
		            }))
		        }
		    },
		    formatter: ({ value }) => value

			},
		    { header: 'ìƒìœ„ë¶€ì„œ ëª…', name: 'uprDeptNm', editor: {
		        type: 'select',
		        options: {
		            listItems: [
		                { text: "", value: "" },  // â˜… ë¹ˆ ê°’ ì¶”ê°€
		                ...deptVOList.map(item => ({
		                    text: item.deptNm,
		                    value: item.deptNm
		                }))
		            ]
		        }
		    },
		    formatter: ({ value }) => {
		        const found = deptVOList.find(d => d.deptId === value);
		        return found ? found.deptNm : value;
		    }},		    		    
		  ]
		});
	let oldRow = null;
	// ğŸ”¥ 1. ë¹ˆê°’ìœ¼ë¡œ ë°”ë€ŒëŠ” ë¬¸ì œ í•´ê²°: ê°’ì´ '' ì´ë©´ ì›ë˜ ê°’ ìœ ì§€
	grid.on('beforeChange', ev => {
	    ev.changes.forEach(change => {	    	
	        const { rowKey, value, nextValue, columnName } = change;
	        oldRow = grid.getRow(rowKey);
	        // ë¶€ì„œì¥ ì»¬ëŸ¼ì—ì„œ ë¹ˆ ê°’ ì„ íƒ ì‹œ â†’ ê¸°ì¡´ ê°’ ìœ ì§€
	        if (columnName === 'nm' && (nextValue === null || nextValue === '')) {
	            change.nextValue = value;  // ì›ë˜ ê°’ìœ¼ë¡œ ë˜ëŒë¦¼
	        }
	    });
	});


	// ğŸ”¥ 2. ë¶€ì„œì¥ ë³€ê²½ ì‹œ nonManager ëª©ë¡ì—ì„œ ì œê±°
	grid.on('afterChange', ev => {
	    ev.changes.forEach(change => {	    	
	    	const rowdata = grid.getRow(change.rowKey);	    	
	        const {rowKey, value, prevValue, columnName } = change;
	        
	     // ğŸ”¥ ìƒìœ„ë¶€ì„œëª… ë³€ê²½ ì²˜ë¦¬.
	        if (columnName === 'uprDeptNm') {

			    // ì„ íƒëœ uprDeptNm ê°’(=ë¶€ì„œ ì´ë¦„)ìœ¼ë¡œ ê²€ìƒ‰
			    const selected = deptVOList.find(d => d.deptNm === value);
			
			    if (selected) {
			        // ğŸ”¥ uprDeptId ì €ì¥
			        grid.setValue(rowKey, "uprDeptId", selected.deptId);
			
			        // uprDeptNmì€ name ê·¸ëŒ€ë¡œ ë‘¬ë„ ë¨
			        grid.setValue(rowKey, "uprDeptNm", selected.deptNm);
			    } else {
			        // ğŸ”¥ ë¹ˆ ê°’ ì„ íƒ ì‹œ ë‘˜ ë‹¤ ì´ˆê¸°í™”
			        grid.setValue(rowKey, "uprDeptId", null);
			        grid.setValue(rowKey, "uprDeptNm", null);
			    }
			}


	        if (columnName === 'nm' && value !== prevValue) {	
	        	// (A) ì„ íƒí•œ ë¶€ì„œì¥ ì •ë³´ ì°¾ê¸°
	            const selected = nonManager.find(item => item.nm === value);
	            //console.log("ì„ íƒëœ ë¶€ì„œì¥:", selected);

	            // (A) empId ê°’ì„ rowì— ì—…ë°ì´íŠ¸
	            if (selected) {
	                grid.setValue(rowKey, "empId", selected.empId);
	            }
	        	
	            // (1) ìƒˆë¡œ ì„ íƒí•œ ë¶€ì„œì¥ì€ nonManagerì—ì„œ ì œê±°
	            nonManager = nonManager.filter(item => {
	            	return item.nm != value
	            	});	        	
	            // (2) ì˜ˆì „ ë¶€ì„œì¥ì€ ë‹¤ì‹œ nonManagerì— ë„£ê³  ì‹¶ìœ¼ë©´ ì•„ë˜ ì½”ë“œ í™œì„±í™”
	             if (prevValue) {	            	 
	                 nonManager.push({empId:rowdata.empId, nm:rowdata.nm});         	 
	             }

	            // (3) select ì˜µì…˜ ë‹¤ì‹œ ë Œë”ë§
	            grid.refreshLayout();
	        }
	    });
	});
	
	let registBtn = $("#mlssRegist");
	let addBtn = $("#mlssAdd");
	let delBtn = $("#del");
	let n = 0;
	let n2 = 0;
	
	//í–‰ ì¶”ê°€ ëˆŒë €ì„ ë•Œ ì‹¤í–‰ë˜ëŠ” ì½”ë“œ
	addBtn.on("click", () => {
		if(n == n2+1){alert("ë“±ë¡ë²„íŠ¼ ëˆ„ë¥´ê³  ì¶”ê°€í•˜ì„¸ìš”!"); return}
		n++;
		grid.prependRow({
			deptId: null,
			deptNm: "",
		    nm: "",
		    uprDeptNm: null		    
		  }, { focus: true });
		
		// í¬ì»¤ìŠ¤ê°€ ì´ë™í•œ ì…€ì—ì„œ rowKeyë¥¼ ì–»ìŒ
		  const focused = grid.getFocusedCell && grid.getFocusedCell();
		  if (focused && focused.rowKey !== undefined && focused.rowKey !== null) {
		    lastAddedRowKey = focused.rowKey;
		  } else {
		    // ì•ˆì „ì¥ì¹˜: í¬ì»¤ìŠ¤ ì •ë³´ê°€ ì—†ìœ¼ë©´ ì²«ë²ˆì§¸ í–‰ì˜ key ì‚¬ìš© (ëŒ€ê°œ 0 í˜¹ì€ ë‚´ë¶€í‚¤)
		    // grid.getRowKey? ì§ì ‘ APIê°€ ì—†ìœ¼ë©´ getRowAt(0) ë“±ì„ ì‚¬ìš©í•´ì•¼ í•˜ëŠ”ë°, ì—¬ê¸°ì„œëŠ” ì•ˆì „í•˜ê²Œ null ì²˜ë¦¬
		    lastAddedRowKey = null;
		  }
	});
	
	//ë“±ë¡ë²„íŠ¼ ëˆŒëŸ¿ì„ ë•Œ ì‹¤í–‰ë˜ëŠ” ì½”ë“œ
	registBtn.on("click", () =>{	
		
		// ğŸ”¥ 1. ì²´í¬ëœ rowKey ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
	    const checkedRowKeys = grid.getCheckedRowKeys();

	    if (checkedRowKeys.length === 0) {
	        alert("ì„ íƒëœ í–‰ì´ ì—†ìŠµë‹ˆë‹¤.");
	        return;
	    }

	    // ğŸ”¥ 2. ì„ íƒëœ í–‰ì˜ ë°ì´í„°ë§Œ ë°°ì—´ë¡œ êµ¬ì„±
	    const selectedRows = checkedRowKeys.map(key => grid.getRow(key));

	    console.log("ì—¬ê¸°ê¹Œì§€ì˜´?");
	    console.log(selectedRows);
			
				
				
			
		      $.ajax({
			    url: "/mergeDept",                // ìš”ì²­ URL
			    type: "post",                     // GET ë°©ì‹ (fetch ì½”ë“œì™€ ë™ì¼)
			    contentType: "application/json",
			    data: JSON.stringify(selectedRows),     // ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ìë™ ë³€í™˜			        
			})
			.done((result) => {
			    alert(result+"ê±´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");		
			    location.reload();
			})
			.fail((error) => {
			    console.error(error);
			    alert("ë°ì´í„° ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
			});  
			
		    console.log("ë“±ë¡ ì™„ë£Œ!");
		  
	});
	
	//ì‚­ì œë²„íŠ¼ ëˆŒëŸ¿ì„ ë•Œ
	
	delBtn.on("click", () =>{
		console.log("ì‚­ì œë²„íŠ¼ ëˆŒë¦¼");
		let datas = [];		
		const addedRowKey = grid.getCheckedRowKeys();
		for(let val of addedRowKey) {
			const rowData = grid.getRow(val);
			datas.push({deptId : rowData.deptId});
		}		
		console.log(datas);
		$.ajax({
		    url: "/deleteDept",                // ìš”ì²­ URL
		    type: "post",                     // GET ë°©ì‹ (fetch ì½”ë“œì™€ ë™ì¼)
		    contentType: "application/json",
		    data: JSON.stringify(datas),     // ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ìë™ ë³€í™˜			        
		})
		.done((result) => {
		    alert(result+"ê±´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");		
		    location.reload();
		})
		.fail((error) => {
		    console.error(error);
		    alert("ë°ì´í„° ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
		});  
		
	    console.log("ë“±ë¡ ì™„ë£Œ!");
	});
	
		
		
		
		 
	
	</script>

</body>

</html>