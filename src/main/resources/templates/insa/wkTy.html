<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
  <meta charset="UTF-8">
  <title>wkTy</title>

  <!-- âœ… Toast UI ê³µí†µ ìœ í‹¸ -->
  <script src="https://uicdn.toast.com/tui-code-snippet/latest/tui-code-snippet.js"></script>

  <!-- âœ… Date / Time Picker -->
  <link rel="stylesheet"
        href="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.css">
  <link rel="stylesheet"
        href="https://uicdn.toast.com/tui.time-picker/latest/tui-time-picker.css">

  <script src="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.js"></script>
  <script src="https://uicdn.toast.com/tui.time-picker/latest/tui-time-picker.js"></script>

  <!-- âœ… Grid -->
  <link rel="stylesheet"
        href="https://uicdn.toast.com/grid/latest/tui-grid.css">
  <script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>

  <style>
    .wk-panel {
      border: 1px solid #dedede;
      border-radius: 18px;
      padding: 24px 26px;
      background-color: #fff;
    }
    .wk-panel .form-label {
      font-weight: 500;
    }
    .wk-time-range .form-control {
      height: 36px;
      padding-top: 4px;
      padding-bottom: 4px;
    }
    .wk-time-range .input-group-text {
      font-size: 0.85rem;
      cursor: pointer;
    }
    .wk-dot {
      display: inline-block;
      margin: 0 8px;
      font-size: 18px;
      line-height: 36px;
    }

    /* âœ… ìš”ì¼ ë²„íŠ¼ ì¡°ê¸ˆ í‚¤ìš´ ë²„ì „ */
    .wk-day-buttons .btn {
      min-width: 46px;
      padding: 7px 0;
      font-size: 0.9rem;
      border-radius: 0;
    }
    .wk-day-buttons .btn:first-child {
      border-radius: 10px 0 0 10px;
    }
    .wk-day-buttons .btn:last-child {
      border-radius: 0 10px 10px 0;
    }
    .wk-day-buttons .btn.selected {
      background-color: #0d6efd;
      color: #fff;
      border-color: #0d6efd;
    }

    .wk-radio-group {
      display: flex;
      align-items: center;
      gap: 24px;
      margin-top: 4px;
    }
    .wk-radio {
      display: flex;
      align-items: center;
      gap: 6px;
      margin: 0;
    }
    .wk-radio input[type="radio"] {
      margin: 0;
    }

    /* âœ… time ì¸í’‹ ë‚´ë¶€ ê¸°ë³¸ ì‹œê³„ ì•„ì´ì½˜ ì œê±° (í¬ë¡¬/ì—£ì§€ ë“±) */
    input[type="time"]::-webkit-calendar-picker-indicator {
      display: none;
    }
    input[type="time"]::-webkit-inner-spin-button,
    input[type="time"]::-webkit-clear-button {
      display: none;
    }

    /* ===========================
     * íœ´ì¼ ê¸°ì¤€ íƒ­ ìŠ¤íƒ€ì¼ (ì…ì²´ê°)
     * =========================== */
    .nav-tabs {
      display: flex;
      gap: 0;
      margin-bottom: 0;
      border-bottom: none !important;
    }

    .nav-tabs .nav-item {
      margin-bottom: -1px;
    }

    .nav-tabs .nav-link {
      border-radius: 10px 10px 0 0;
      padding: 8px 20px;
      background-color: #f7f8fa;
      color: #a1a6ad;
      font-weight: 500;
      border: 1px solid #d1d5db;
      border-bottom-color: #d1d5db;
      box-shadow: inset 0 -2px 0 rgba(0,0,0,0.03);
      transition: background-color 0.15s ease,
                  color 0.15s ease,
                  box-shadow 0.15s ease;
    }

    .nav-tabs .nav-item + .nav-item .nav-link {
      margin-left: -1px;
    }

    .nav-tabs .nav-link:not(.active):hover {
      background-color: #eff1f4;
      color: #7a7f87;
    }

    .nav-tabs .nav-link.active {
      background-color: #ffffff;
      color: #111111;
      font-weight: 600;
      border-color: #d1d5db;
      border-bottom-color: #ffffff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.06);
      z-index: 2;
    }

    .tab-pane {
      display: none;
      margin-top: 0;
      padding-top: 0;
    }

    .tab-pane.active {
      display: block;
    }

    .card-body > .mt-3 {
      margin-top: 0 !important;
    }

    /* âœ… ë²„íŠ¼ ì˜ì—­ ê³µê°„ì€ ìœ ì§€í•˜ë©´ì„œ ë²„íŠ¼ë§Œ ì•ˆ ë³´ì´ê²Œ */
    .wk-header-hidden {
      visibility: hidden;
    }
  </style>
</head>
<body layout:fragment="content">
<div class="row">

  <!-- ================== íœ´ì¼ ê¸°ì¤€ ê´€ë¦¬ ================== -->
  <div class="col-md-6">
    <div class="card mb-3">
      <div class="card-header">
        <h5 class="card-title">íœ´ì¼ ê¸°ì¤€ ê´€ë¦¬</h5>
        <!-- âœ… ë²„íŠ¼ ì˜ì—­ì— ì•„ì´ë”” ì¶”ê°€ -->
        <div class="card-header-right" id="hldyHeaderBtns">
          <!-- <button class="btn btn-outline-dark" id="btnHldyAdd">í–‰ì¶”ê°€</button> -->
          <div th:replace="~{fragments/buttons :: addRowButton('MENU_HR_010', 'btnHldyAdd')}"></div>
          <!-- <button class="btn btn-outline-dark" id="btnHldySave">ì €ì¥</button> -->
          <div th:replace="~{fragments/buttons :: saveButton('MENU_HR_010', 'btnHldySave')}"></div>
          <!-- <button class="btn btn-danger" id="btnHldyDel">ì‚­ì œ</button> -->
          <div th:replace="~{fragments/buttons :: deleteButton('MENU_HR_010', 'btnHldyDel')}"></div>
        </div>
      </div>
      <div class="card-body">
        <!-- íƒ­ í—¤ë” -->
        <ul class="nav nav-tabs" id="hldyTab">
          <!-- âœ… ì²« ë²ˆì§¸ íƒ­: íšŒì‚¬ ì§€ì • ê³µíœ´ì¼ (ê¸°ë³¸ í™œì„±) -->
          <li class="nav-item">
            <button class="nav-link active" type="button" data-target="#tab-company">
              íšŒì‚¬ ì§€ì • ê³µíœ´ì¼
            </button>
          </li>
          <!-- âœ… ë‘ ë²ˆì§¸ íƒ­: ë²•ì • ê³µíœ´ì¼ -->
          <li class="nav-item">
            <button class="nav-link" type="button" data-target="#tab-legal">
              ë²•ì • ê³µíœ´ì¼
            </button>
          </li>
        </ul>

        <!-- íƒ­ë³„ Grid ì˜ì—­ -->
        <div class="mt-3">
          <!-- íšŒì‚¬ ì§€ì • ê³µíœ´ì¼ (ì¶”ê°€/ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥) -->
          <div id="tab-company" class="tab-pane active">
            <div id="gridHldyCompany"></div>
          </div>

          <!-- ë²•ì • ê³µíœ´ì¼ (ì¡°íšŒ ì „ìš©) -->
          <div id="tab-legal" class="tab-pane">
            <div id="gridHldyLegal"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ================== ê·¼ë¬´í˜•íƒœ ê¸°ì¤€ ê´€ë¦¬ ================== -->
  <div class="col-md-6">
    <div class="card mb-3">
      <div class="card-header mb-3">
        <h5 class="card-title">ê·¼ë¬´í˜•íƒœ ê¸°ì¤€ ê´€ë¦¬</h5>
        <div class="card-header-right">
          <!-- âœ… ë²„íŠ¼ì— id ë¶€ì—¬ -->
          <button class="btn btn-dark"          id="btnWkReset">ì´ˆê¸°í™”</button>
          <button class="btn btn-outline-dark"  id="openGuideModal">ì¡°íšŒ</button>
          <!-- <button class="btn btn-outline-dark"  id="btnWkSave">ì €ì¥</button> -->
          <div th:replace="~{fragments/buttons :: saveButton('MENU_HR_010', 'btnWkSave')}"></div>
          <!-- <button class="btn btn-danger"        id="btnWkDelete">ì‚­ì œ</button> -->
          <div th:replace="~{fragments/buttons :: deleteButton('MENU_HR_010', 'btnWkDelete')}"></div>
        </div>
      </div>

      <div class="card-body">
        <div class="wk-panel">
          <!-- ê¸°ì¤€ëª… / ë¶€ì„œëª… -->
          <div class="row mb-3">
            <div class="col-6">
              <label for="stdNm" class="form-label astar">ê¸°ì¤€ëª…</label>
              <input type="text" id="stdNm" class="form-control" />
            </div>
            <div class="col-6">
              <label for="deptNm" class="form-label astar">ë¶€ì„œëª…</label>
              <select id="deptNm" class="form-select">
                <option value="">ì„ íƒ</option>
              </select>
            </div>
          </div>

          <!-- ì¶œê·¼ì‹œê°„ / í‡´ê·¼ì‹œê°„ -->
          <div class="row mb-4 wk-time-range">
            <div class="col-5">
              <label for="startTime" class="form-label astar">ì¶œê·¼ì‹œê°„</label>
              <div class="input-group">
                <input type="time" id="startTime" class="form-control">
                <span class="input-group-text" id="startTimeIcon">â±</span>
              </div>
            </div>
            <div class="col-2 d-flex align-items-end justify-content-center">
              <span class="wk-dot">~</span>
            </div>
            <div class="col-5">
              <label for="endTime" class="form-label astar">í‡´ê·¼ì‹œê°„</label>
              <div class="input-group">
                <input type="time" id="endTime" class="form-control">
                <span class="input-group-text" id="endTimeIcon">â±</span>
              </div>
            </div>
          </div>

          <!-- âœ… ê·¼ë¬´ìœ í˜• ë¼ë””ì˜¤/ì£¼ê¸° ì‚­ì œí•˜ê³ , íœ´ì¼(ìš”ì¼)ë§Œ í‘œì‹œ -->
          <div class="mb-4">
            <label class="form-label d-block astar">íœ´ì¼</label>
            <div id="weekdaySection" class="wk-day-buttons">
              <div class="btn-group" role="group" aria-label="weekday">
                <button type="button" class="btn btn-outline-primary btn-sm" data-day="MON">ì›”</button>
                <button type="button" class="btn btn-outline-primary btn-sm" data-day="TUE">í™”</button>
                <button type="button" class="btn btn-outline-primary btn-sm" data-day="WED">ìˆ˜</button>
                <button type="button" class="btn btn-outline-primary btn-sm" data-day="THU">ëª©</button>
                <button type="button" class="btn btn-outline-primary btn-sm" data-day="FRI">ê¸ˆ</button>
                <button type="button" class="btn btn-outline-primary btn-sm" data-day="SAT">í† </button>
                <button type="button" class="btn btn-outline-primary btn-sm" data-day="SUN">ì¼</button>
              </div>
            </div>
          </div>

          <!-- âœ… ê¸°ì¤€ë²ˆí˜¸ / ì„ íƒ ìš”ì¼ hidden -->
          <input type="hidden" id="basiNo"           value="">
          <input type="hidden" id="selectedWeekdays" name="selectedWeekdays" value="">
        </div>
      </div>
    </div>
  </div>
</div>

<!-- âœ… ê·¼ë¬´í˜•íƒœ ê¸°ì¤€ ì¡°íšŒ ëª¨ë‹¬ -->
<div th:replace="~{insa/modal/wkTyModal :: wkTyModal}"></div>

<script>
/* =====================================================
 * 1. Grid ê³µí†µ ì˜µì…˜
 * ===================================================== */
const GridOptions = {
  bodyHeight: 580,
  scrollX: false,
  scrollY: true,
  rowHeaders: ['checkbox'],
  columnOptions: {
    minWidth: 80,
    resizable: true
  }
};

/* =====================================================
 * âœ… ì›”ì¼ ì •ë ¬ í•¨ìˆ˜ (ë…„ë„ ë¬´ì‹œ)
 * ===================================================== */
function sortByMmdd(data) {
  return data.sort((a, b) => {
    const aMmdd = (a.hldyMmdd || '').slice(-5); // 2000-01-02 or 01-02 -> 01-02
    const bMmdd = (b.hldyMmdd || '').slice(-5);
    return aMmdd.localeCompare(bMmdd);
  });
}

/* =====================================================
 * âœ… ë¶€ì„œ ì…€ë ‰íŠ¸ ë°•ìŠ¤ ë¡œë”©
 * ===================================================== */
function loadDeptList() {
  const mainSelect  = document.getElementById('deptNm');      // ë©”ì¸
  const modalSelect = document.getElementById('wkTyDept');    // ëª¨ë‹¬

  if (!mainSelect && !modalSelect) return;

  // ê¸°ë³¸ ì´ˆê¸°í™”
  if (mainSelect)  mainSelect.innerHTML  = '<option value="">ì„ íƒ</option>';
  if (modalSelect) modalSelect.innerHTML = '<option value="">ì „ì²´</option>';

  fetch('/insa/edc/inputOption')
    .then(res => res.json())
    .then(data => {
      const deptList = data.dept || [];

      deptList.forEach(dept => {
        // ë©”ì¸ í˜ì´ì§€
        if (mainSelect) {
          const opt1 = document.createElement('option');
          opt1.value = dept.deptId;
          opt1.textContent = dept.deptNm;
          mainSelect.appendChild(opt1);
        }

        // ëª¨ë‹¬
        if (modalSelect) {
          const opt2 = document.createElement('option');
          opt2.value = dept.deptId;
          opt2.textContent = dept.deptNm;
          modalSelect.appendChild(opt2);
        }
      });
    })
    .catch(() => {
      alert('ë¶€ì„œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

/* =====================================================
 * 2. íœ´ì¼ Grid 2ê°œ (ë²•ì • / íšŒì‚¬)
 * ===================================================== */

// ë²•ì • ê³µíœ´ì¼: ì¡°íšŒ ì „ìš©
const legalGrid = new tui.Grid({
  el: document.getElementById('gridHldyLegal'),
  data: [],
  bodyHeight: 560,
  scrollX: false,
  scrollY: true,
  rowHeaders: [],
  columnOptions: {
    minWidth: 80,
    resizable: true
  },
  columns: [
    { header: 'ë²ˆí˜¸', name: 'hldyNo', hidden: true },
    { header: 'ì›”ì¼', name: 'hldyMmdd', align: 'center' },
    { header: 'íœ´ì¼ëª…', name: 'hldyNm' },
    {
      header: 'ì‚¬ìš©ì—¬ë¶€',
      name: 'ynCode',
      formatter: ({ value }) => value === 'e1' ? 'ì‚¬ìš©' : 'ë¯¸ì‚¬ìš©'
    }
  ]
});

// íšŒì‚¬ ì§€ì • ê³µíœ´ì¼
const companyGrid = new tui.Grid({
  el: document.getElementById('gridHldyCompany'),
  data: [],
  ...GridOptions,
  editingType: 'cell',
  columns: [
    { header: 'ë²ˆí˜¸', name: 'hldyNo', hidden: true },
    {
      header: 'ì›”ì¼',
      name: 'hldyMmdd',
      align: 'center',
      editor: { type: 'datePicker', options: { format: 'yyyy-MM-dd', language: 'ko' }},
      formatter: ({ value }) => value ? value.slice(-5) : ''
    },
    { header: 'íœ´ì¼ëª…', name: 'hldyNm', editor: 'text' },
    {
      header: 'ì‚¬ìš©ì—¬ë¶€',
      name: 'ynCode',
      editor: { type: 'select', options: { listItems: [
        { text: 'ì‚¬ìš©', value: 'e1' },
        { text: 'ë¯¸ì‚¬ìš©', value: 'e2' }
      ]}},
      formatter: ({ value }) => value === 'e1' ? 'ì‚¬ìš©' : 'ë¯¸ì‚¬ìš©'
    }
  ]
});

/* =====================================================
 * 3. íƒ­ ì „í™˜
 * ===================================================== */
const tabBtns = document.querySelectorAll('#hldyTab .nav-link');
const panes = {
  '#tab-legal': document.getElementById('tab-legal'),
  '#tab-company': document.getElementById('tab-company')
};
// âœ… íœ´ì¼ ì¹´ë“œ í—¤ë” ë²„íŠ¼ ì˜ì—­
const hldyHeaderBtns = document.getElementById('hldyHeaderBtns');

tabBtns.forEach(btn => {
  btn.addEventListener('click', () => {
    const target = btn.getAttribute('data-target');
    tabBtns.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    for (const key in panes) {
      panes[key].classList.toggle('active', key === target);
    }

    // âœ… íƒ­ì— ë”°ë¼ ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€ (ê³µê°„ì€ ìœ ì§€)
    if (target === '#tab-legal') {
      hldyHeaderBtns.classList.add('wk-header-hidden');
    } else {
      hldyHeaderBtns.classList.remove('wk-header-hidden');
    }

    (target === '#tab-legal' ? legalGrid : companyGrid).refreshLayout();
  });
});

function getActiveHldyGrid() {
  const active = document.querySelector('#hldyTab .nav-link.active');
  const type = active.getAttribute('data-target');
  return type === '#tab-legal'
    ? { grid: legalGrid, type: 'LEGAL' }
    : { grid: companyGrid, type: 'COMPANY' };
}

/* =====================================================
 * 4. íœ´ì¼ ì¡°íšŒ
 * ===================================================== */
function loadLegalHldyList() {
  fetch('/api/hldy/legal/list')
    .then(res => res.json())
    .then(list => {
      let data = list.map(r => ({
        hldyNo: r.hldyNo,
        hldyNm: r.hldyNm,
        hldyMmdd: r.hldyMmdd,
        ynCode: r.ynCode
      }));
      legalGrid.resetData(sortByMmdd(data));
    });
}

function loadCompanyHldyList() {
  fetch('/api/hldy/company/list')
    .then(res => res.json())
    .then(list => {
      let data = list.map(r => ({
        hldyNo: r.hldyNo,
        hldyNm: r.hldyNm,
        hldyMmdd: r.hldyMmdd ? '2000-' + r.hldyMmdd : '',
        ynCode: r.ynCode
      }));
      companyGrid.resetData(sortByMmdd(data));
    });
}

document.addEventListener('DOMContentLoaded', () => {
  loadLegalHldyList();
  loadCompanyHldyList();
  loadDeptList();   // ğŸ”¥ ë¶€ì„œ ì…€ë ‰íŠ¸ ë¡œë”© ì—¬ê¸°ì„œ í˜¸ì¶œ

  // ì´ˆê¸° ìƒíƒœ: íšŒì‚¬ ì§€ì • ê³µíœ´ì¼ íƒ­ì´ë¯€ë¡œ ë²„íŠ¼ ë³´ì´ë„ë¡
  hldyHeaderBtns.classList.remove('wk-header-hidden');
});

/* =====================================================
 * 5. íœ´ì¼ CRUD
 * ===================================================== */
document.getElementById('btnHldyAdd').onclick = () => {
  const { grid } = getActiveHldyGrid();
  grid.prependRow({ hldyNo:null, hldyMmdd:'', hldyNm:'', ynCode:'e1' });
};

document.getElementById('btnHldyDel').onclick = () => {
  const { grid } = getActiveHldyGrid();
  grid.removeRows(grid.getCheckedRowKeys());
};

document.getElementById('btnHldySave').onclick = () => {
  const { grid } = getActiveHldyGrid();

  // âœ…  í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ì…€ ê°’ ê°•ì œ ë°˜ì˜
  grid.finishEditing();
  const { createdRows, updatedRows, deletedRows } = grid.getModifiedRows();

  // âœ… í•„ìˆ˜ê°’(ì›”ì¼, íœ´ì¼ëª…) ìœ íš¨ì„± ê²€ì‚¬
  const rowsToCheck = [...createdRows, ...updatedRows];
  const hasInvalid = rowsToCheck.some(r => {
    const mmdd = (r.hldyMmdd || '').toString().trim();
    const name = (r.hldyNm || '').toString().trim();
    return !mmdd || !name;
  });

  if (hasInvalid) {
    alert('ì›”ì¼ê³¼ íœ´ì¼ëª…ì€ ëª¨ë‘ ì…ë ¥í•´ì•¼ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
    return;
  }

  function norm(rows) {
    return rows.map(r => ({
      hldyNo: r.hldyNo,
      hldyNm: r.hldyNm?.trim(),
      hldyMmdd: r.hldyMmdd?.slice(-5),
      ynCode: r.ynCode || 'e1'
    }));
  }

  const payload = {
    createdRows: norm(createdRows),
    updatedRows: norm(updatedRows),
    deletedRows: deletedRows.map(r => ({ hldyNo: r.hldyNo }))
  };

  fetch('/api/hldy/company/save', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  })
  .then(res => {
    if (!res.ok) throw new Error();
    alert('ì €ì¥ ì™„ë£Œ');
    loadCompanyHldyList();
  })
  .catch(() => alert('ì €ì¥ ì‹¤íŒ¨'));
};

/* =====================================================
 * 6 ~ 16 : ê·¼ë¬´í˜•íƒœ ê¸°ì¤€ ê´€ë ¨ JS (ìš”ì¼ë§Œ ì‚¬ìš©)
 * ===================================================== */

// ì „ì—­ ë³€ìˆ˜
let wkTyGrid = null;          // ëª¨ë‹¬ ê·¸ë¦¬ë“œ
let currentBasiNo = null;     // ì„ íƒëœ ê¸°ì¤€ë²ˆí˜¸ (ìƒì„¸ í¼ìš©)

const stdNmInput     = document.getElementById('stdNm');
const deptNmSelect   = document.getElementById('deptNm');
const startTimeInput = document.getElementById('startTime');
const endTimeInput   = document.getElementById('endTime');
const basiNoInput    = document.getElementById('basiNo');

/* ìš”ì¼ ë²„íŠ¼ + hidden ê°’ */
const dayButtons      = document.querySelectorAll('#weekdaySection button');
const hiddenWeekdays  = document.getElementById('selectedWeekdays');

function updateHiddenWeekdays() {
  const selectedDays = [];
  dayButtons.forEach(btn => {
    if (btn.classList.contains('selected')) {
      selectedDays.push(btn.dataset.day);  // MON, TUE ...
    }
  });
  hiddenWeekdays.value = selectedDays.join(',');
}

dayButtons.forEach(btn => {
  btn.addEventListener('click', () => {
    btn.classList.toggle('selected');
    updateHiddenWeekdays();
  });
});

/* ì‹œê°„ ì•„ì´ì½˜ â†’ time picker ì—´ê¸° */
function bindTimeIcon(inputId, iconId) {
  const input = document.getElementById(inputId);
  const icon  = document.getElementById(iconId);
  if (!input || !icon) return;

  icon.addEventListener('click', () => {
    if (typeof input.showPicker === 'function') {
      input.showPicker();
    } else {
      input.focus();
    }
  });
}

bindTimeIcon('startTime', 'startTimeIcon');
bindTimeIcon('endTime',   'endTimeIcon');

/* í¼ ì´ˆê¸°í™” */
function resetWorkTypeForm() {
  currentBasiNo      = null;
  basiNoInput.value  = '';
  stdNmInput.value   = '';
  deptNmSelect.value = '';

  startTimeInput.value = '';
  endTimeInput.value   = '';

  dayButtons.forEach(btn => btn.classList.remove('selected'));
  updateHiddenWeekdays();
}

document.getElementById('btnWkReset').addEventListener('click', resetWorkTypeForm);

/* ëª¨ë‹¬ìš© Grid ì´ˆê¸°í™” */
function initWkTyGrid() {
  const gridEl = document.getElementById('gridWkTy');
  if (!gridEl || wkTyGrid) return;

  wkTyGrid = new tui.Grid({
    el: gridEl,
    data: [],
    bodyHeight: 260,
    scrollX: false,
    scrollY: true,
    rowHeaders: [],
    columns: [
      {
        header: 'ì„ íƒ',
        name: 'select',
        width: 60,
        align: 'center',
        // âœ… rowKey ëŒ€ì‹  ê¸°ì¤€ë²ˆí˜¸(basiNo)ë¥¼ valueë¡œ ì‚¬ìš©
        formatter: ({ row }) =>
          `<input type="radio" name="wkTySelect" value="${row.basiNo}">`
      },
      { header: 'ê¸°ì¤€ëª…',   name: 'basiNm' },
      { header: 'ë¶€ì„œëª…',   name: 'deptNm',  width: 80, align: 'center' },
      { header: 'ì¶œê·¼ì‹œê°„', name: 'atdcTm',  width: 90, align: 'center' },
      { header: 'í‡´ê·¼ì‹œê°„', name: 'afwkTm',  width: 90, align: 'center' },
      /* âœ… íœ´ì¼ ì»¬ëŸ¼: ì„ íƒ ìš”ì¼ í‘œì‹œ(ì˜ˆ: í† ,ì¼) */
      { header: 'íœ´ì¼', name: 'hldyDesc' }
    ]
  });
}

/* ê¸°ì¤€ ëª©ë¡ ì¡°íšŒ â†’ ëª¨ë‹¬ ê·¸ë¦¬ë“œì— ë°”ì¸ë”© (ê²€ìƒ‰ì¡°ê±´ ì ìš© ë²„ì „) */
function loadWkTyList() {
  if (!wkTyGrid) initWkTyGrid();

  const basiNmInput = document.getElementById('wkTySrchBasiNm');
  const deptSel     = document.getElementById('wkTyDept');

  const basiNm = basiNmInput ? basiNmInput.value.trim() : '';
  const deptId = deptSel ? (deptSel.value || '') : '';

  const params = new URLSearchParams();
  if (basiNm) params.append('basiNm', basiNm);
  if (deptId) params.append('deptId', deptId);

  const url = '/insa/hldyWkBasi/list' + (params.toString() ? ('?' + params.toString()) : '');

  fetch(url)
    .then(res => res.json())
    .then(list => {
      const data = list.map(r => {
        const at = r.atdcTm ? ('' + r.atdcTm).substring(11, 16) : '';
        const af = r.afwkTm ? ('' + r.afwkTm).substring(11, 16) : '';

        return {
          basiNo:   r.basiNo,
          basiNm:   r.basiNm,
          deptNm:   r.deptNm,
          atdcTm:   at,
          afwkTm:   af,
          hldyDesc: ''   // âœ… íœ´ì¼ ë¬¸ìì—´ì€ ì•„ë˜ì—ì„œ ë”°ë¡œ ì±„ì›€
        };
      });
      wkTyGrid.resetData(data);

      /* âœ… ê° ê¸°ì¤€ë³„ ìš”ì¼ ì¡°íšŒí•´ì„œ "í† ,ì¼" í˜•ì‹ìœ¼ë¡œ ì…€ì— ì„¸íŒ… */
      const dayLabelMap = {
        MON: 'ì›”',
        TUE: 'í™”',
        WED: 'ìˆ˜',
        THU: 'ëª©',
        FRI: 'ê¸ˆ',
        SAT: 'í† ',
        SUN: 'ì¼'
      };

      list.forEach((r, idx) => {
        if (!r.basiNo) return;
        const row = wkTyGrid.getRowAt(idx);
        if (!row) return;
        const rowKey = row.rowKey;

        fetch('/insa/hldyWkBasi/day/list?basiNo=' + r.basiNo)
          .then(res => res.json())
          .then(dayList => {
            const txt = (dayList || [])
              .map(d => dayLabelMap[d.dayNm] || d.dayNm)
              .join(',');
            wkTyGrid.setValue(rowKey, 'hldyDesc', txt);
          })
          .catch(() => {
            // ì—ëŸ¬ ì‹œì—ëŠ” ê·¸ëƒ¥ ë¹„ì›Œë‘ 
          });
      });
    });
}

/* ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸° + ì„ íƒ */
// ğŸ”¹ íŒ€ìœ í‹¸ closeModal()ì—ì„œ ì“¸ ìˆ˜ ìˆê²Œ ì „ì—­ modal/back ì„¸íŒ…
const openBtn = document.getElementById('openGuideModal');
const modal   = document.getElementById('wkTyModal');
const back    = document.getElementById('wkTyBackdrop');

function openModal() {
  if (!modal || !back) return;

  modal.classList.add('show');
  modal.style.display = 'block';
  back.style.display  = 'block';

  initWkTyGrid();
  loadWkTyList();
  if (wkTyGrid && wkTyGrid.refreshLayout) {
    wkTyGrid.refreshLayout();
  }
}

openBtn?.addEventListener('click', openModal);

// âœ… ë°±ë“œë¡­ í´ë¦­ ì‹œ: teamUtil ì˜ closeModal ì‚¬ìš©
back?.addEventListener('click', () => {
  if (typeof closeModal === 'function') {
    closeModal();
  } else {
    // í˜¹ì‹œ teamUtilì´ ë¡œë“œ ì•ˆ ëœ ê²½ìš° fallback
    modal.classList.remove('show');
    modal.style.display = 'none';
    back.style.display  = 'none';
  }
});

/* âœ… ì—¬ê¸° ì¶”ê°€: teamUtil.js ë°©ì‹ì˜ ë°”ê¹¥ í´ë¦­ ë‹«ê¸° */
if (typeof modal !== 'undefined' && modal) {
  modal.addEventListener('click', (event) => {
    if (!event.target.closest('.modal-content')) {
      if (typeof closeModal === 'function') {
        closeModal();
      } else {
        modal.classList.remove('show');
        modal.style.display = 'none';
        if (back) back.style.display = 'none';
      }
    }
  });
}

// ğŸ” ëª¨ë‹¬ ê²€ìƒ‰ ë²„íŠ¼ / ì—”í„° / ë¶€ì„œë³€ê²½ â†’ ê²€ìƒ‰
document.getElementById('btnWkTySearch')?.addEventListener('click', () => {
  loadWkTyList();
});

document.getElementById('wkTySrchBasiNm')?.addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    loadWkTyList();
  }
});

document.getElementById('wkTyDept')?.addEventListener('change', () => {
  loadWkTyList();
});

document.getElementById('btnWkTySelect')?.addEventListener('click', () => {
  if (!wkTyGrid) return;
  const checked = document.querySelector('input[name="wkTySelect"]:checked');
  if (!checked) {
    alert('ê¸°ì¤€ì„ ì„ íƒí•˜ì„¸ìš”.');
    return;
  }

  // âœ… rowKeyë¡œ getRow í•˜ì§€ ì•Šê³ , ë¼ë””ì˜¤ì— ì‹¤ë¦° basiNoë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©
  const selectedBasiNo = checked.value;
  if (!selectedBasiNo) {
    alert('ê¸°ì¤€ ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    return;
  }

  loadWorkTypeDetail(selectedBasiNo);

  if (typeof closeModal === 'function') {
    closeModal();
  } else {
    modal.classList.remove('show');
    modal.style.display = 'none';
    if (back) back.style.display = 'none';
  }
});

// í˜¹ì‹œ ëª¨ë‹¬ ë‚´ë¶€ì— ë‹«ê¸° ë²„íŠ¼(id="btnWkTyClose") ìˆìœ¼ë©´ ê±°ê¸°ë„ ì—°ê²°
document.getElementById('btnWkTyClose')?.addEventListener('click', () => {
  if (typeof closeModal === 'function') {
    closeModal();
  } else {
    modal.classList.remove('show');
    modal.style.display = 'none';
    if (back) back.style.display = 'none';
  }
});

/* ê¸°ì¤€ ìƒì„¸ ì¡°íšŒ + ìš”ì¼ ì¡°íšŒ â†’ í¼ ë°”ì¸ë”© */
function loadWorkTypeDetail(basiNo) {
  if (!basiNo) return;

  fetch('/insa/hldyWkBasi/detail?basiNo=' + basiNo)
    .then(res => res.json())
    .then(vo => {
      currentBasiNo     = vo.basiNo;
      basiNoInput.value = vo.basiNo || '';

      stdNmInput.value   = vo.basiNm || '';
      deptNmSelect.value = vo.deptId || '';

      const at = vo.atdcTm ? ('' + vo.atdcTm).substring(11, 16) : '';
      const af = vo.afwkTm ? ('' + vo.afwkTm).substring(11, 16) : '';
      startTimeInput.value = at;
      endTimeInput.value   = af;

      return fetch('/insa/hldyWkBasi/day/list?basiNo=' + basiNo);
    })
    .then(res => res.json())
    .then(dayList => {
      dayButtons.forEach(btn => {
        const cd = btn.dataset.day;
        const exists = dayList.some(d => d.dayNm === cd);
        if (exists) btn.classList.add('selected');
        else        btn.classList.remove('selected');
      });
      updateHiddenWeekdays();
    })
    .catch(() => {
      alert('ê·¼ë¬´í˜•íƒœ ê¸°ì¤€ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

/* ê¸°ì¤€ ì €ì¥ */
document.getElementById('btnWkSave').addEventListener('click', () => {
  const basiNo = basiNoInput.value ? Number(basiNoInput.value) : null;
  const basiNm = (stdNmInput.value || '').trim();
  const deptId = deptNmSelect.value || '';
  const atdcTm = startTimeInput.value || '';
  const afwkTm = endTimeInput.value   || '';

  if (!basiNm) {
    alert('ê¸°ì¤€ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.');
    return;
  }
  if (!deptId) {
    alert('ë¶€ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”.');
    return;
  }
  if (!atdcTm || !afwkTm) {
    alert('ì¶œê·¼/í‡´ê·¼ì‹œê°„ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.');
    return;
  }

  const dayList = (hiddenWeekdays.value || '')
    .split(',')
    .map(s => s.trim())
    .filter(s => s.length > 0);

  /* âœ… ì¶”ê°€: ìš”ì¼ì„ í•˜ë‚˜ë„ ì„ íƒí•˜ì§€ ì•Šì•˜ìœ¼ë©´ ì €ì¥ ë¶ˆê°€ */
  if (dayList.length === 0) {
    alert('íœ´ì¼ì„ í•œ ê°œ ì´ìƒ ì„ íƒí•˜ì„¸ìš”.');
    return;
  }

  const payload = {
    basiNo,
    deptId,
    basiNm,
    atdcTm,
    afwkTm,
    dayList
  };

  fetch('/insa/hldyWkBasi/save', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  })
  .then(res => {
    if (!res.ok) throw new Error();
    return res.json();
  })
  .then(resBody => {
    if (resBody.result !== 'SUCCESS') {
      throw new Error();
    }
    alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    if (resBody.basiNo) {
      currentBasiNo     = resBody.basiNo;
      basiNoInput.value = resBody.basiNo;
    }
  })
  .catch(() => {
    alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  });
});

/* ê¸°ì¤€ ì‚­ì œ */
document.getElementById('btnWkDelete').addEventListener('click', () => {
  const basiNo = basiNoInput.value ? Number(basiNoInput.value) : null;
  if (!basiNo) {
    alert('ì‚­ì œí•  ê¸°ì¤€ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
    return;
  }
  if (!confirm('ì„ íƒí•œ ê·¼ë¬´í˜•íƒœ ê¸°ì¤€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
    return;
  }

  fetch('/insa/hldyWkBasi/delete?basiNo=' + basiNo, {
    method: 'DELETE'
  })
  .then(res => {
    if (!res.ok) throw new Error();
    return res.json();
  })
  .then(resBody => {
    if (resBody.result !== 'SUCCESS') {
      throw new Error();
    }
    alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    resetWorkTypeForm();
  })
  .catch(() => {
    alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  });
});
</script>

</body>
</html>

<!-- /templates/insa/modal/wkTyModal.html -->
<div th:fragment="wkTyModal">
  <!-- âœ… ëª¨ë‹¬ ë°°ê²½ -->
  <div class="modal-backdrop" id="wkTyBackdrop" style="display:none;"></div>

  <!-- âœ… ëª¨ë‹¬ ë³¸ì²´ -->
  <div class="modal" id="wkTyModal" tabindex="-1" style="display:none;">
    <div class="modal-dialog modal-dialog-centered" style="--bs-modal-width: 800px;">
      <div class="modal-content">
        <div class="modal-body">
          <h5 class="modal-title mb-3">ê·¼ë¬´í˜•íƒœê¸°ì¤€ ì¡°íšŒ</h5>

          <div class="row">
            <div class="col-md-12">

              <!-- ğŸ” ì¹´ë“œ 1 : ê²€ìƒ‰ì¡°ê±´ -->
              <div class="card border mb-3">
                <div class="card-header">
                  <h5 class="card-title">ê²€ìƒ‰ì¡°ê±´</h5>
                  <div class="card-header-right">
                    <!-- ê²€ìƒ‰ ë²„íŠ¼ -->
                    <button class="btn btn-outline-dark" id="btnWkTySearch">ì¡°íšŒ</button>
                  </div>
                </div>

                <div class="card-body">
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label class="form-label">ê¸°ì¤€ëª…</label>
                      <input type="text" class="form-control" id="wkTySrchBasiNm">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">ë¶€ì„œëª…</label>
                      <select id="wkTyDept" class="form-select">
                        <option value="">ì „ì²´</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ğŸ“‹ ì¹´ë“œ 2 : ê·¼ë¬´í˜•íƒœ ê¸°ì¤€ ëª©ë¡ ê·¸ë¦¬ë“œ -->
              <div class="card border">
                <div class="card-header">
                  <h5 class="card-title">ê·¼ë¬´í˜•íƒœ ê¸°ì¤€ ëª©ë¡</h5>
                  <div class="card-header-right">
                    <!-- âœ… ì„ íƒ ì ìš© ë²„íŠ¼ -->
                    <button class="btn btn-outline-dark" id="btnWkTySelect">í™•ì¸</button>
                  </div>
                </div>
                <div class="card-body">
                  <div id="gridWkTy" class="mt-2"></div>
                </div>
              </div>

            </div>
          </div><!-- /.row -->

        </div><!-- /.modal-body -->
      </div>
    </div>
  </div>
</div>
