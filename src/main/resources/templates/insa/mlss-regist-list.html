<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout}">
<head>
<meta charset="UTF-8">
<title>mlss.html</title>
  
<!-- ✅ Date / Time Picker -->
  <link rel="stylesheet"
        href="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.css">
<!-- ✅ Grid -->
  <link rel="stylesheet"
        href="https://uicdn.toast.com/grid/latest/tui-grid.css">
  
<style>
.form-select {
	color: #000 !important;
}
/* 추가 CSS */
.readonly-input[readonly] {
	background-color: #e9ecef; /* Bootstrap 기본 disabled 색상 */
	cursor: not-allowed; /* 마우스 커서도 입력 불가 느낌 */
}

.stIsShow {
	display: none;
}

.menu-item {
	cursor: pointer; /* 마우스 올리면 손가락 모양 */
}
</style>
</head>
<body layout:fragment="content">
	<div class="row">
		<div class="col-md-12">
			<div class="card mb-3">
				<!-- 카드 헤더 : 제목 + 조회 버튼 -->
				<div
					class="card-header d-flex justify-content-between align-items-center">
					<h5 class="card-title mb-0">조회</h5>
					<div>
						<button id="joHoe" class="btn btn-outline-dark">조회</button>
					</div>
				</div>

				<!-- 카드 바디 : 검색 폼 -->
				<div class="card-body">
					<div class="row g-3">
						<div class="col-md-3">
							<label for="mlssNm" class="form-label">다면평가 명</label> <input
								type="text" id="mlssNm" class="form-control mlssJohoe"
								placeholder="Value">
						</div>
						<div class="col-md-3">
							<label for="evlBeginDt" class="form-label">평가시작일시</label>
							<div class="input-group date js-date-single">
								<input type="text" class="form-control datepicker js-date-input mlssJohoe"
									placeholder="날짜 선택" id="evlBeginDt"> <span
									class="input-group-text js-date-icon"> <i
									class="bi bi-calendar"></i>
								</span>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="card mb-3">
		<div
			class="card-header d-flex justify-content-between align-items-center">
			<h5 class="card-title mb-0">다면평가 목록</h5>
			<div>
				<!-- <button id="mlssAdd" class="btn btn-outline-dark">행 추가</button> -->
				<div th:replace="~{fragments/buttons :: addRowButton('MENU_HR_006', 'mlssAdd')}"></div>
				<!-- <button id="mlssRegist" class="btn btn-outline-dark">저장</button> -->
				<div th:replace="~{fragments/buttons :: saveButton('MENU_HR_006', 'mlssRegist')}"></div>
				<!-- <button class="btn btn-outline-dark">삭제</button> -->
				<!-- <div th:replace="~{fragments/buttons :: deleteButton('MENU_HR_006', 'del')}"></div> -->
			</div>
		</div>
		<div class="card-body">
			<div id="toastGrid" style="margin: 20px;"></div>
		</div>
	</div>
	<!-- ✅ Date / Time Picker -->
<script src="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.js"></script>
<!-- ✅ Grid -->
<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>
	<script>	

	let lastAddedRowKey = null;
	
	const grid = new tui.Grid({
		  el: $("#toastGrid")[0],
		  data: [],		  
		  editingType: 'cell',
		  bodyHeight: 440,
		  scrollX: false,
		  scrollY: true,
		  rowHeaders: ['checkbox'],
		  columnOptions: {
		    minWidth: 80,
		    resizable: true
		  },
		  columns: [
		    { header: '다면평가ID', name: 'mlssId', hidden: true},
		    { header: '다면평가 명', name: 'mlssNm', editor: 'text'},
		    { header: '평가시작일시', name: 'evlBeginDt', editor: { type: 'datePicker', options: { format: 'yyyy-MM-dd', language: 'ko' }}
		    ,formatter: function({ value }) { return value ? dateFormat(value, 'yyyy-MM-dd') : ''; } },		    
		    { header: '평가종료일시', name: 'evlEndDt', editor: { type: 'datePicker', options: { format: 'yyyy-MM-dd', language: 'ko' }}
		    ,formatter: function({ value }) { return value ? dateFormat(value, 'yyyy-MM-dd') : ''; } },	    
		    { header: '등록일', name: 'creaDt', editor: { type: 'datePicker', options: { format: 'yyyy-MM-dd', language: 'ko' }}
		    ,formatter: function({ value }) { return value ? dateFormat(value, 'yyyy-MM-dd') : ''; } },		    
		  ]
		});
	
	/* =========================
	   ✅ 4. ✅ "추가된 행만 수정 가능" 제어
	========================= */
	grid.on('editingStart', (ev) => {
	  const { rowKey } = ev;

	  // ✅ 마지막 추가 행이 아니면 수정 차단
	  if (rowKey !== lastAddedRowKey) {
	    ev.stop();  // ❌ 수정 막기
	  }
	});
	
	let registBtn = $("#mlssRegist");
	let addBtn = $("#mlssAdd");
	let n = grid.getRowCount();
	let n2 = grid.getRowCount();
	
	//행 추가 눌렀을 때 실행되는 코드
	addBtn.on("click", () => {
		if(n == n2+1){alert("등록버튼 누르고 추가하세요!"); return}
		grid.prependRow({
		    mlssId: ++n,
		    mlssNm: "",
		    evlBeginDt: "",
		    evlEndDt: "",
		    creaDt: dateFormat(new Date(), 'yyyy-MM-dd')
		  }, { focus: true });
		
		// 포커스가 이동한 셀에서 rowKey를 얻음
		  const focused = grid.getFocusedCell && grid.getFocusedCell();
		  if (focused && focused.rowKey !== undefined && focused.rowKey !== null) {
		    lastAddedRowKey = focused.rowKey;
		  } else {
		    // 안전장치: 포커스 정보가 없으면 첫번째 행의 key 사용 (대개 0 혹은 내부키)
		    // grid.getRowKey? 직접 API가 없으면 getRowAt(0) 등을 사용해야 하는데, 여기서는 안전하게 null 처리
		    lastAddedRowKey = null;
		  }
	});
	
	//등록버튼 눌럿을 때 실행되는 코드
	registBtn.on("click", () =>{
		lastAddedRowKey = grid.getCheckedRowKeys();
		if (lastAddedRowKey !== null) {
			console.log(lastAddedRowKey);
			
			// ✅ 추가된 행의 전체 데이터 가져오기
		    const rowData = grid.getRow(lastAddedRowKey[0]);
			console.log(rowData);
		     $.ajax({
			    url: "/mlssRegist",                // 요청 URL
			    type: "post",                     // GET 방식 (fetch 코드와 동일)
			    contentType: "application/json",
			    data: JSON.stringify(rowData),     // 쿼리 파라미터 자동 변환			        
			})
			.done((result) => {
			    alert(result+"건 등록되었습니다.");			    
			})
			.fail((error) => {
			    console.error(error);
			    alert("데이터 요청 중 오류 발생");
			}); 
			
		    //alert("등록 완료!");
		    lastAddedRowKey = null; // 등록 후 다시 전체 수정 잠금
		  } else {
		    alert("등록할 행이 없습니다.");
		  }
	});
	
	//조회버튼 눌럿을 때
	$("#joHoe").on("click", () =>{
		
		let datas = [];
		$(".mlssJohoe").each(function(idx, ele) {
			datas[$(ele).attr("id")] = $(ele).val()
		});
		console.log(datas);
		
		 $.ajax({
		    url: "/mlssListJohoe",                // 요청 URL
		    type: "get",                     // GET 방식 (fetch 코드와 동일)
		    data: datas
		})
		.done((result) => {	
			console.log(result);
		    grid.resetData(result);          // 결과를 grid에 반영
		})
		.fail((error) => {
		    console.error(error);
		    alert("데이터 요청 중 오류 발생");
		}); 
	});
	</script>

</body>

</html>