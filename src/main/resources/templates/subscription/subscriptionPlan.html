<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout}">
<head>
<meta charset="UTF-8">
<title>Subscription Plan</title>
<link rel="stylesheet"
	href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>
<style>
/* 구독 플랜 목록 그리드 높이 조정 (대략 10행 노출) */
#subscriptionGrid {
	height: 400px;
}

/* 두 컬럼이 같은 높이로 늘어나도록 */
.subscription-row-equal .card {
	height: 100%;
}
</style>
</head>
<body layout:fragment="content">

	<div class="row subscription-row-equal">
		<!-- 좌측: 구독 플랜 목록 -->
		<div class="col-md-6 d-flex">
			<div class="card mb-3 flex-fill">
				<div class="card-header">
					<div class="card-header-left">
						<h5 class="card-title">구독 플랜 목록</h5>
					</div>
				</div>
				<div class="card-body">
					<div id="subscriptionGrid" class="mt-3"></div>
				</div>
			</div>
		</div>

		<!-- 우측: 구독 플랜 상세 -->
		<div class="col-md-6 d-flex">
			<div class="card mb-3 flex-fill">
				<div class="card-header">
					<div class="card-header-left">
						<h5 class="card-title">구독 플랜 상세</h5>
					</div>
					<div class="card-header-right">
						<button type="button" id="btnResetPlan"
							class="btn btn-dark">초기화</button>
						<!-- <button type="submit" form="subscriptionPlanForm"
							class="btn btn-outline-dark">저장</button> -->
					    <div th:replace="~{fragments/buttons :: saveButton('MENU_COMM_009', 'btnSavePlan')}"></div>
					</div>
				</div>
				<div class="card-body">
					<form id="subscriptionPlanForm"
						th:action="@{/subscription/plan/save}" method="post">

						<!-- 숨겨진 구독 플랜 ID (수정 시 사용) -->
						<input type="hidden" name="subspPlanId" />

						<!-- 1행: 플랜명, 계정 발급 수 -->
						<div class="row mb-3">
							<div class="col-md-6">
								<label class="form-label">플랜 명</label> <input type="text"
									class="form-control" name="planNm" placeholder="플랜명을 입력하세요" />
							</div>
							<div class="col-md-6">
								<label class="form-label">최대 계정 생성 수</label> <input
									type="number" class="form-control" name="acctIssuCnt"
									placeholder="계정 수를 입력하세요" />
							</div>
						</div>

						<!-- 2행: 월 API 호출 횟수, 적용 일자 -->
						<div class="row mb-3">
							<div class="col-md-6">
								<label class="form-label">월 API 호출 횟수</label> <input
									type="number" class="form-control" name="apiIssuCnt"
									placeholder="월 API 호출 횟수를 입력하세요" />
							</div>

							<div class="col-md-6">
								<label for="userName" class="form-label">적용 일자</label>
								<div class="input-group date js-date-single">
									<input type="text"
										class="form-control datepicker js-date-input" name="applcDt"
										placeholder="       날짜 선택"> <span
										class="input-group-text js-date-icon"> <i
											class="bi bi-calendar"></i>
									</span>
								</div>
							</div>
						</div>

						<!-- 3행: 결제주기, 노출 여부 -->
						<div class="row mb-3">
							<div class="col-md-6">
								<label class="form-label">결제 주기</label>
								<select class="form-select" name="sttlPerd">
									<option value="" selected>선택</option>
									<!-- DB 코드: b1=월, b2=년 -->
									<option value="b1">월</option>
									<option value="b2">연</option>
								</select>
							</div>

							<div class="col-md-6">
								<label class="form-label">가격</label> <input type="number"
									class="form-control" name="amt" placeholder="가격을 입력하세요" />
							</div>
						</div>

						<div class="row mb-3">
							<label class="form-label d-block">노출 여부</label>
							<div class="d-flex align-items-center">
								<label class="me-4 mb-0"> Y <input class="ms-1"
									type="radio" name="ynDisplay" value="Y" checked>
								</label> <label class="mb-0"> N <input class="ms-1" type="radio"
									name="ynDisplay" value="N">
								</label>

								<!-- 실제 서버로 전송될 hidden field (e1/e2 값 저장) -->
								<input type="hidden" name="yn" value="e1" />
							</div>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>

	<script th:inline="javascript">
		/*<![CDATA[*/
		// 서버에서 전달된 구독 플랜 목록을 JavaScript 객체로 변환
		const planList = /*[[${planList}]]*/ [];

		// planList를 그리드에 맞게 매핑 (폼에 필요한 상세 데이터 포함)
		const gridData = planList.map(plan => ({
			// 그리드에 보이는 컬럼용
			planName : plan.planNm,
			// e1/e2 -> Y/N 으로 변환해서 그리드에 표시
			exposureYn : plan.yn === 'e1' ? 'Y'
				: plan.yn === 'e2' ? 'N'
				: plan.yn, // 혹시 다른 값이면 원본 그대로
			// 결제주기: DB 코드(b1/b2)를 월/연 텍스트로 변환해 표시
			billingCycle : plan.sttlPerd === 'b1' ? '월'
				: plan.sttlPerd === 'b2' ? '연'
				: plan.sttlPerd,
			// 상세 폼 세팅용 (숨은 데이터 포함)
			subspPlanId : plan.subspPlanId,
			planNm : plan.planNm,
			acctIssuCnt : plan.acctIssuCnt,
			apiIssuCnt : plan.apiIssuCnt,
			sttlPerd : plan.sttlPerd,
			amt : plan.amt,
			applcDt : plan.applcDt,
			yn : plan.yn
		}));

		// Toast UI Grid 생성
		const subscriptionGrid = new tui.Grid({
			el : document.getElementById('subscriptionGrid'),
			data : gridData,
			scrollX : false,
			scrollY : false,
			bodyHeight : 360,
			rowHeight : 36,
			columns : [ {
				header : '플랜 명',
				name : 'planName',
				align : 'left'
			}, {
				header : '노출 여부',
				name : 'exposureYn',
				align : 'left'
			}, {
				header : '결제 주기',
				name : 'billingCycle',
				align : 'left'
			} ]
		});
		
		// 행 클릭 시 우측 상세 폼에 데이터 바인딩
		subscriptionGrid.on('click', ev => {
			const rowData = subscriptionGrid.getRow(ev.rowKey);
			if (!rowData) return;

			const form = document.getElementById('subscriptionPlanForm');

			// hidden ID
			form.querySelector('input[name="subspPlanId"]').value = rowData.subspPlanId || '';

			// 텍스트/숫자 필드
			form.querySelector('input[name="planNm"]').value = rowData.planNm || '';
			form.querySelector('input[name="acctIssuCnt"]').value = rowData.acctIssuCnt || '';
			form.querySelector('input[name="apiIssuCnt"]').value = rowData.apiIssuCnt || '';

			// 결제 주기 select 박스 설정 (M/Y 코드값 사용)
			const sttlPerdSelect = form.querySelector('select[name="sttlPerd"]');
			if (sttlPerdSelect) {
				// 우선 rowData.sttlPerd 사용, 없으면 billingCycle 사용
				const sttlCode = rowData.sttlPerd || rowData.billingCycle || '';
				sttlPerdSelect.value = sttlCode;
			}

			form.querySelector('input[name="amt"]').value = rowData.amt || '';

			// 적용 일자 (Date -> yyyy-MM-dd 형태로 잘라서 사용)
			const dateInput = form.querySelector('.js-date-input');
			if (dateInput) {
				let dateStr = '';
				if (rowData.applcDt) {
					// plan.applcDt가 문자열일 수도 있고, ISO 문자열일 수도 있으므로 10자리까지 자름
					dateStr = String(rowData.applcDt).substring(0, 10);
				}
				dateInput.value = dateStr;
			}

			// 노출 여부 라디오 버튼 (Y/N)
			if (rowData.yn) {
				const radiosDisplay = form.querySelectorAll('input[name="ynDisplay"]');
				let displayValue = rowData.yn === 'e1' ? 'Y' : (rowData.yn === 'e2' ? 'N' : 'Y');
				radiosDisplay.forEach(radio => {
					radio.checked = (radio.value === displayValue);
				});

				// hidden 필드(실제 값 e1/e2)도 동기화
				const hiddenYn = form.querySelector('input[name="yn"][type="hidden"]');
				if (hiddenYn) {
					hiddenYn.value = rowData.yn;
				}
			}
		});
		
		// 초기화 버튼 클릭 시 폼/선택 상태 리셋 (신규 등록 모드)
		document.getElementById('btnResetPlan').addEventListener('click', function() {
			const form = document.getElementById('subscriptionPlanForm');

			// 기본 form reset으로 텍스트/숫자/라디오 기본값 초기화
			form.reset();

			// hidden ID도 비워서 신규 등록 모드로 전환
			const hiddenId = form.querySelector('input[name="subspPlanId"]');
			if (hiddenId) {
				hiddenId.value = '';
			}

			// datepicker input 값도 비우기
			const dateInput = form.querySelector('.js-date-input');
			if (dateInput) {
				dateInput.value = '';
			}

			// 결제 주기 select 박스 초기화
			const sttlPerdSelect = form.querySelector('select[name="sttlPerd"]');
			if (sttlPerdSelect) {
				sttlPerdSelect.value = '';
			}

			// 노출 여부 기본값을 Y로 재설정
			const ynDisplayRadios = form.querySelectorAll('input[name="ynDisplay"]');
			ynDisplayRadios.forEach(radio => {
				radio.checked = (radio.value === 'Y');
			});

			// hidden yn 값도 기본 e1로 재설정
			const hiddenYnReset = form.querySelector('input[name="yn"][type="hidden"]');
			if (hiddenYnReset) {
				hiddenYnReset.value = 'e1';
			}

			// 그리드 선택 행도 초기화 (선택 해제)
			if (subscriptionGrid) {
				const focused = subscriptionGrid.getFocusedCell();
				if (focused && typeof focused.rowKey === 'number') {
					subscriptionGrid.unfocus();
				}
			}
		});
		
		// 그리드 레이아웃 새로고침 (스크롤바 벗어남 해결)
		window.addEventListener('load', function() {
			subscriptionGrid.refreshLayout();
		});
		
		// 노출 여부 라디오(Y/N) 변경 시 hidden yn(e1/e2) 값 동기화
		const ynDisplayRadiosChange = document.querySelectorAll('input[name="ynDisplay"]');
		ynDisplayRadiosChange.forEach(radio => {
			radio.addEventListener('change', function() {
				const hiddenYn = document.querySelector('input[name="yn"][type="hidden"]');
				if (!hiddenYn) return;
				// Y 선택 시 e1, N 선택 시 e2 저장
				hiddenYn.value = (this.value === 'Y') ? 'e1' : 'e2';
			});
		});
		
		document.addEventListener('DOMContentLoaded', function () {
			  const saveBtn = document.getElementById('btnSavePlan');
			  if (saveBtn) {
			    saveBtn.addEventListener('click', function () {
			      // 권한 없어서 disabled면 클릭 자체가 안 들어오지만, 혹시 몰라 방어
			      if (saveBtn.disabled) {
			        return;
			      }
			      const form = document.getElementById('subscriptionPlanForm');
			      if (form) {
			        form.submit();   // 기존 type="submit" + form="..." 역할을 JS로 수행
			      }
			    });
			  }
			});
		/*]]>*/
	</script>

</body>
</html>