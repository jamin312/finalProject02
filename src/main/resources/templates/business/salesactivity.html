<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout}">
<head>
<meta charset="UTF-8">
<title>salesactivity</title>
<link rel="stylesheet"
	href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>
</head>
<style>
.fixed-photo {
	width: 150px; /* 원하는 가로 크기 */
	height: 200px; /* 원하는 세로 크기 */
	object-fit: cover; /* 비율 유지하며 영역에 맞게 채움 */
}

.form-select {
	color: #000 !important;
}

.btn-group .btn:not(:last-child) {
	border-right-width: 0 !important;
}
</style>
<body layout:fragment="content">
	<form th:action="@{/salesActivity}" method="post">
		<div class="row">
			<div class="col-md-12 mb-3">
				<div class="card">
					<div class="card-header">
						<div class="card-header-left">
							<h5 class="card-title">조회조건</h5>
						</div>
						<div class="card-header-right">
							<form th:action="@{/potential/sync}" method="post" class="mb-2">
								<button class="btn btn-primary">공공데이터조회</button>
							</form>
							<!-- <button class="btn btn-dark">초기화</button> -->
							<button class="btn btn-outline-dark" type="submit">검색조회</button>
						</div>
					</div>
					<div class="card-body">
						<div class="row mb-2">
							<div class="row mb-2">
								<div class="col-md-3">
									<label class="form-label">업종</label> <input type="text"
										class="form-control" placeholder="코딩" name="industryType"
										th:value="${stdrvo != null ? stdrvo.industryType : ''}">
								</div>
								<div class="col-md-3">
									<label class="form-label">업체규모</label> <select
										name="companySize" class="form-select">
										<option value=""
											th:selected="${stdrvo == null || stdrvo.companySize == null || stdrvo.companySize == ''}">규모선택</option>
										<option value="대기업"
											th:selected="${stdrvo != null && stdrvo.companySize == '대기업'}">대기업</option>
										<option value="준대기업"
											th:selected="${stdrvo != null && stdrvo.companySize == '준대기업'}">준대기업</option>
										<option value="중견기업"
											th:selected="${stdrvo != null && stdrvo.companySize == '중견기업'}">중견기업</option>
										<option value="강소기업"
											th:selected="${stdrvo != null && stdrvo.companySize == '강소기업'}">강소기업</option>
										<option value="중소기업"
											th:selected="${stdrvo != null && stdrvo.companySize == '중소기업'}">중소기업</option>
									</select>
								</div>
								<div class="col-md-3">
									<label class="form-label">지역/상권</label><input name="region"
										placeholder="지역" class="form-control"
										th:value="${stdrvo != null ? stdrvo.region : ''}">
								</div>
							</div>
							<!-- <div class="col-md-6">
								<label class="form-label">설립일</label>
								<div class="d-flex align-items-center js-date-range">
									<div class="input-group date">
										<input type="text"
											class="form-control datepicker js-date-range-start"
											placeholder="시작일" name="startEstablishDate"> <span
											class="input-group-text js-date-range-icon-start"> <i
											class="bi bi-calendar"></i>
										</span>
									</div>
									<span class="mx-1 fw-bold fs-5">~</span>
									<div class="input-group date ms-2">
										<input type="text"
											class="form-control datepicker js-date-range-end"
											placeholder="종료일" name="endEstablishDate"> <span
											class="input-group-text js-date-range-icon-end"> <i
											class="bi bi-calendar"></i>
										</span>
									</div>
								</div>
							</div> -->
						</div>
					</div>
				</div>
			</div>
		</div>
	</form>
	<form th:action="@{/potentialCustList}" method="post">
		<div class="card mb-3">
			<div class="card-header">
				<div class="card-header-left">
					<h5 class="card-title">잠재고객목록</h5>
				</div>
			</div>
			<div class="card-body">
				<div class="tab-pane-custom">
					<div id="potentialgrid" style="height: 150px;"></div>
				</div>
			</div>
		</div>
	</form>
	<form th:action="@{/salesActivity/contact}" method="post">
		<div class="card mb-3">
			<div class="card-header">
				<!-- 탭 -->
				<div class="card-header-left">
					<div class="btn-group" role="group" aria-label="영업활동 탭">
						<input type="radio" class="btn-check" name="salesTab" id="salesTab1" autocomplete="off" checked> 
							<label class="btn btn-outline-primary fw-bold" for="salesTab1" data-target="#tabContact"> 
								<i class="fa fa-edit me-1"></i>접촉사항</label> 
							<input type="radio" class="btn-check" name="salesTab" id="salesTab2" autocomplete="off"> 
								<label class="btn btn-outline-primary fw-bold" for="salesTab2" data-target="#tabLead">
									<i class="fa fa-edit me-1"> </i>리드분석</label>
							<input type="radio" class="btn-check" name="salesTab" id="salesTab3" autocomplete="off">
								<label class="btn btn-outline-primary fw-bold" for="salesTab3" data-target="#tabDemo">
									<i class="fa fa-edit me-1"></i>견적 및 데모활동</label>
					</div>
				</div>
				<!-- 버튼 -->
				<div class="card-header-right">
					<!-- <button type="button" class="btn btn-outline-dark"
						id="btnContactAdd">추가</button> -->
					<div
						th:replace="~{fragments/buttons :: addRowButton('MENU_SALES_014', 'btnContactAdd')}"></div>
					<!-- <button type="button" class="btn btn-primary" id="btnContactSave">저장</button> -->
					<div
						th:replace="~{fragments/buttons :: saveButton('MENU_SALES_014', 'btnContactSave')}"></div>
				</div>
			</div>
			<!-- 탭 내용 -->
			<div class="card-body" style="height: 300px;">
				<!-- 접촉사항 탭 -->
				<div id="tabContact" class="tab-pane-custom">
					<div id="contactGrid" style="height: 280px;"></div>
				</div>
				<!-- 리드분석 탭 -->
				<div id="tabLead" class="tab-pane-custom" style="display: none;">
					<div id="leadgrid" style="height: 280px;"></div>
				</div>
				<!-- 견적 및 데모활동 탭 -->
				<div id="tabDemo" class="tab-pane-custom" style="display: none;">
					<div id="demoGrid" style="height: 280px;"></div>
				</div>
			</div>
		</div>
	</form>










	<script th:inline="javascript">
   // 공통 테마
   tui.Grid.applyTheme('default', {
       cell: {
           normal: {
               border: '#ccc',
               background: "#fff",
               showVerticalBorder: true,
           },
           header: {
               border: '#ccc',
               background: '#E3E6ED',
               showVerticalBorder: true,
           },
           editable: {
               background: '#FFFDF0',
               text: '#000'
           },
           selectedHeader: {
               background: '#E3E6ED'
           },
           selected: {
               background: '#ffffff'
           }
       }
   });
   
// ✅ 서버 데이터
	const rawData = /*[[${potentialstdrList}]]*/ [];
	const safeRawData = Array.isArray(rawData) ? rawData : [];
	
	const sorted = safeRawData
	  .map(row => ({
	    ...row,
	    leadScore: row.leadScore == null ? 0 : Number(row.leadScore)
	  }))
	  .sort((a, b) => b.leadScore - a.leadScore);
	
	let currentRank = 0;
	let prevScore = null;
	
	const potentialData = sorted.map((row, index) => {
	  if (prevScore === row.leadScore) {
	    row.rank = currentRank;
	  } else {
	    currentRank = index + 1;
	    row.rank = currentRank;
	    prevScore = row.leadScore;
	  }
	  return row;
	});
   
   
    // 잠재고객 Grid
   console.log("potentialData", potentialData);
   const potentialgrid = new tui.Grid({
       el: document.getElementById('potentialgrid'),
       data: potentialData,
       scrollX: false,
       scrollY: true,
       minBodyHeight : 0,
       bodyHeight: 110,
       autoWidth: true,
       columns : [ {
			header : '순위',
			name : 'rank',
			sortable : 'true',
			align : 'center',
			width: 150
		}, {
			  header: '접촉건수',
			  name: 'contactCnt',
			  align: 'center',
			  sortable: true,
			  width: 120
		},{
			header : '업체명',
			name : 'vendNm',
			align  : 'center',
		}, {
			header : '업종',
			name : 'industryType',
			sortable : 'true',
		}, {
			header : '규모',
			name : 'companySize',
			align : 'center',
			width: 150
		}, {
           header: '설립일',
           name: 'establishDate',
           formatter: ({ value }) => {
               const d = new Date(value);
               return `${d.getFullYear()}년 ${String(d.getMonth()+1).padStart(2,'0')}월 ${String(d.getDate()).padStart(2,'0')}일`;
           },
           width: 150,
           align : 'center'
       }, {
			header : '지역/상권',
			name : 'region',
			align : 'center',
			width: 150,
		},{
		    header : '리드점수',
		    name   : 'leadScore',   // leadscore → leadScore 로 수정
		    align  : 'center',
		    sortable : 'true',
		    width: 150,
		    className: 'col-emphasize'
		} ]
	});
   //
   //
   // 접촉 Grid
   const contactData = /*[[${contactrList}]]*/ [];
   const safeContactData = Array.isArray(contactData) ? contactData : [];
   console.log("contactData", contactData);
   const contactGrid = new tui.Grid({
       el: document.getElementById('contactGrid'),
       data: contactData,
       scrollX: false,
       scrollY: true,
       bodyHeight: 240,
       columns: [
           {
               header: '날짜',
               name: 'contactDt',
               formatter: ({ value }) => {
                   if (!value) return '';
                   const d = new Date(value);
                   if (isNaN(d.getTime())) return '';
                   return `${d.getFullYear()}년 ${String(d.getMonth() + 1).padStart(2, '0')}월 ${String(d.getDate()).padStart(2, '0')}일`;
               },
               align: 'center',
               width: 200
           },
           { header: '담당자', name: 'contactManager', width: 150, align: 'center', editor: {
	    	      type: 'select',
	    	      options: {
	    	        listItems: [
	    	          { text: '홍길동', value: '홍길동' },
	    	          { text: '정우진', value: '정우진' },
	    	          { text: '김현우', value: '김현우' },
	    	          { text: '서우진', value: '서우진' },
	    	          { text: '최도윤', value: '최도윤' },
	    	          { text: '이민아', value: '이민아' }
	    	        ]
	    	      }
	    	    }},
           { header: '방법', name: 'contactWay', 
           	editor: {
	    	      type: 'select',
	    	      options: {
	    	        listItems: [
	    	          { text: '대면', value: '대면' },
	    	          { text: '전화', value: '전화' },
	    	          { text: '이메일', value: '이메일' }
	    	        ]
	    	      }
	    	    },
	    	    width: 150, align: 'center'},
           { header: '내용', name: 'contactCntn', editor: 'text' }
       ]
   });
   //
   // 리드
   const leadData = /*[[${leadList}]]*/ [];
   const safeLeadData = Array.isArray(leadData) ? leadData : [];
   console.log("leadData", leadData);
   
   const leadgrid = new tui.Grid({
       el: document.getElementById('leadgrid'),
       data: leadData,
       scrollX: true,
       scrollY: true,
       minBodyHeight: 0,
       bodyHeight: 240,
       autoWidth: true,
       columns: [
           {
               header: '리드일자',
               name: 'leadDt', 
               width: 200,
               formatter: ({ value }) => {
                   if (!value) return '';
                   const d = new Date(value);
                   if (isNaN(d.getTime())) return '';
                   return `${d.getFullYear()}년 ${String(d.getMonth() + 1).padStart(2, '0')}월 ${String(d.getDate()).padStart(2, '0')}일`;
               },
               align: 'center',
               sortable: true
           },
           { header: '담당자', name: 'leadManager',align: 'center', width: 150, editor: {
	    	      type: 'select',
	    	      options: {
	    	        listItems: [
	    	          { text: '홍길동', value: '홍길동' },
	    	          { text: '정우진', value: '정우진' },
	    	          { text: '김현우', value: '김현우' },
	    	          { text: '서우진', value: '서우진' },
	    	          { text: '최도윤', value: '최도윤' },
	    	          { text: '이민아', value: '이민아' }
	    	        ]
	    	      }
	    	    }},
           { header: '요청기한', name: 'requiredDt', align: 'center', editor: 'text' },
           { header: '경쟁사 존재여부', name: 'competitorYn', align: 'center', editor: {
	    	      type: 'select',
	    	      options: {
	    	        listItems: [
	    	          { text: 'Y', value: 'Y' },
	    	          { text: 'N', value: 'N' },
	    	        ]
	    	      }
	    	    }  },
           { header: '예산확보 여부', name: 'budgetAvailYn', align: 'center', editor: {
	    	      type: 'select',
	    	      options: {
	    	        listItems: [
	    	          { text: 'Y', value: 'Y' },
	    	          { text: 'N', value: 'N' },
	    	        ]
	    	      }
	    	    }  }
       ]
   });
   //
   // 견적/데모 Grid
   const demoData = /*[[${demoList}]]*/ [];
   const safeDemoData = Array.isArray(demoData) ? demoData : [];
   console.log("demoData", demoData);
   const demoGrid = new tui.Grid({
       el: document.getElementById('demoGrid'),
       data: demoData,
       scrollX: true,
       scrollY: true,
       minBodyHeight: 0,
       bodyHeight: 240,
       autoWidth: true,
       columns: [
           { header: '날짜', name: 'demoQuotatioDt', width: 200, formatter: ({ value }) => {
               if (!value) return '';
               const d = new Date(value);
               if (isNaN(d.getTime())) return '';
               return `${d.getFullYear()}년 ${String(d.getMonth() + 1).padStart(2, '0')}월 ${String(d.getDate()).padStart(2, '0')}일`;
           }, align: 'center'},
           { header: '담당자', name: 'demoManager', width: 150, align: 'center',editor: {
	    	      type: 'select',
	    	      options: {
	    	        listItems: [
	    	          { text: '홍길동', value: '홍길동' },
	    	          { text: '정우진', value: '정우진' },
	    	          { text: '김현우', value: '김현우' },
	    	          { text: '서우진', value: '서우진' },
	    	          { text: '최도윤', value: '최도윤' },
	    	          { text: '이민아', value: '이민아' }
	    	        ]
	    	      }
	    	    } },
           { header: '설명', name: 'demoDc', width: 400, editor: 'text' },
           { header: '고객반응', name: 'custReaction', align : "center", editor: {
	    	      type: 'select',
	    	      options: {
	    	        listItems: [
	    	          { text: '매우 좋음', value: '매우 좋음' },
	    	          { text: '좋음', value: '좋음' },
	    	          { text: '보통', value: '보통' },
	    	          { text: '나쁨', value: '나쁨' },
	    	          { text: '매우 나쁨', value: '매우 나쁨' }
	    	        ]
	    	      }
	    	    }
	    	    },
           { header: '샘플여부', name: 'samplePrivide', align : "center", editor: {
	    	      type: 'select',
	    	      options: {
	    	        listItems: [
	    	          { text: 'Y', value: 'Y' },
	    	          { text: 'N', value: 'N' },
	    	        ]
	    	      }
	    	    } },
           { header: '수량', name: 'custQy', align : "center", editor: 'text' },
           { header: '할인', name: 'custDiscount', align : "center", editor: 'text' },
           { header: '납기', name: 'custDelivery', align : "center", formatter: ({ value }) => {
               if (!value) return '';
               const d = new Date(value);
               if (isNaN(d.getTime())) return '';
               return `${d.getFullYear()}년 ${String(d.getMonth() + 1).padStart(2, '0')}월 ${String(d.getDate()).padStart(2, '0')}일`;
           }, editor: 'text', align: 'center', }
       ]
   });
   //
   //
   //
   //
   // 잠재고객 클릭 시 접촉/리드/데모 조회
   potentialgrid.on('click', function (ev) {
       const row = potentialgrid.getRow(ev.rowKey);
       if (!row) return;
       const potentialInfoNo = row.potentialInfoNo;
       if (!potentialInfoNo) {
           console.warn('potentialInfoNo 없음', row);
           return;
       }
       console.log('접촉/리드내역 조회, potentialInfoNo =', potentialInfoNo);
       // 접촉내역
       fetch('/salesActivity/contactByVend?potentialInfoNo=' + encodeURIComponent(potentialInfoNo))
           .then(res => res.json())
           .then(data => {
               console.log('받은 접촉내역', data);
               contactGrid.resetData(data);
           })
           .catch(err => console.error('접촉내역 조회 오류', err));
       // 리드내역
       fetch('/salesActivity/LeadByVend?potentialInfoNo=' + encodeURIComponent(potentialInfoNo))
           .then(res => res.json())
           .then(data => {
               console.log('받은 데모내역', data);
               leadgrid.resetData(data);
           })
           .catch(err => console.error('리드내역 조회 오류', err));
      
      // 데모내역
       fetch('/salesActivity/DemoByVend?potentialInfoNo=' + encodeURIComponent(potentialInfoNo))
           .then(res => res.json())
           .then(data => {
               console.log('받은 데모내역', data);
               demoGrid.resetData(data);
           })
           .catch(err => console.error('데모내역 조회 오류', err));
   });
   // 저장 버튼
   document.getElementById('btnContactSave').addEventListener('click', function (e) {
	   
	   function isEmpty(v) {
		   return v === null || v === undefined || String(v).trim() === '';
		 }
		  e.preventDefault();
		
		  contactGrid.finishEditing();
		  leadgrid.finishEditing();
		  demoGrid.finishEditing();
		
		  const contactModified = contactGrid.getModifiedRows();
		  const leadModified = leadgrid.getModifiedRows();
		  const demoModified = demoGrid.getModifiedRows();
		
		  // ✅ 변경된 rowKey로 "전체 row 데이터" 다시 뽑기
		  const contactList = [
		    ...contactModified.createdRows,
		    ...contactModified.updatedRows.map(r => contactGrid.getRow(r.rowKey))
		  ];
		
		  const leadList = [
		    ...leadModified.createdRows,
		    ...leadModified.updatedRows.map(r => leadgrid.getRow(r.rowKey))
		  ];
		
		  const demoList = [
		    ...demoModified.createdRows,
		    ...demoModified.updatedRows.map(r => demoGrid.getRow(r.rowKey))
		  ];
		
		  // ✅ 데모 유효성 체크 (custReaction도 넣어라)
		  for (const demo of demoList) {
			  if (
			    isEmpty(demo.demoQuotatioDt) ||
			    isEmpty(demo.demoManager) ||
			    isEmpty(demo.demoDc) ||
			    isEmpty(demo.custReaction) ||
			    isEmpty(demo.samplePrivide) ||
			    isEmpty(demo.custQy) ||        // 수량은 0이면 안 되는 정책이면 따로 체크
			    isEmpty(demo.custDiscount) ||  // ✅ 0이면 통과됨
			    isEmpty(demo.custDelivery)
			  ) {
			    alert("데모 내용을 모두 입력하십시오.");
			    console.log('검증 실패 demo row = ', demo); // 어떤 값이 비었는지 찾기 쉬움
			    return;
			  }
			}
       // 날짜 포맷 정리
       contactList.forEach(row => {
           if (row.contactDt) {
               row.contactDt = row.contactDt.toString().substring(0, 10);
           }
       });
       leadList.forEach(row => {
           if (row.leadDt) {
               row.leadDt = row.leadDt.toString().substring(0, 10);
           }
       });
       // 잠재고객 선택 체크
       const focusedCell = potentialgrid.getFocusedCell();
       if (!focusedCell) {
           alert("잠재고객을 먼저 선택해.");
           return;
       }
       const selected = potentialgrid.getRow(focusedCell.rowKey);
       const vendId = selected.vendId;
       const potentialInfoNo = selected.potentialInfoNo;
       fetch('/salesActivity/contact/saveAll', {
           method: 'POST',
           headers: { 'Content-Type': 'application/json' },
           body: JSON.stringify({
               vendId: vendId,
               potentialInfoNo: potentialInfoNo,
               contactList: contactList,
               leadList: leadList,
               demoList: demoList
           })
       })
           .then(res => res.text())
           .then(msg => {
               alert("저장되었습니다.");
           })
           .catch(err => console.error(err));
   });
   // 행 추가 버튼
   document.getElementById('btnContactAdd').addEventListener('click', function () {
   	console.log('typeof contactGrid = ', typeof contactGrid);
   	console.log('typeof leadGrid = ', typeof leadgrid);
   	console.log('typeof demoGrid = ', typeof demoGrid);
   	console.log('>>> 추가 버튼 클릭됨');
   	
       const today = new Date();
       const yyyy = today.getFullYear();
       const mm = String(today.getMonth() + 1).padStart(2, '0');
       const dd = String(today.getDate()).padStart(2, '0');
       const todayStr = `${yyyy}-${mm}-${dd}`;
    // 현재 선택된 탭 찾기(라디오 버튼 방식)
       const target = $('.btn-group label[for="' + $('input[name="salesTab"]:checked').attr('id') + '"]').data('target') || '#tabContact';
       console.log('target = ', target);
       
       // 1) 접촉사항 탭인 경우 → contactGrid 에 행 추가
       if (target === '#tabContact') {
           console.log('contactGrid에 행 추가');
           contactGrid.prependRow({
               contactDt: todayStr,
               contactManager: '',
               contactWay: '',
               contactCntn: ''
           });
           contactGrid.focus(0, 'contactDt');
       } else if (target === '#tabLead') {
       	   console.log('leadgrid에 행 추가');
           leadgrid.prependRow({
               leadDt: todayStr,
               leadManager: '',
               requiredDt: '',
               competitorYn: '',
               budgetAvailYn: '',
               leadScore: null
           });
           leadgrid.focus(0, 'leadDt');
       } else if (target === '#tabDemo') {
           demoGrid.prependRow({
	            demoQuotatioDt: todayStr,
	            demoManager: '',
	            demoDc: '',
	            custReaction: '',
	            samplePrivide: '',
	            custQy: '',
	            custDiscount: '',
	            custDelivery: ''
           });
           demoGrid.focus(0, 'demoQuotatioDt');
       }
   });
   
   demoGrid.on('afterChange', (ev) => {
	   console.log('demoGrid afterChange:', ev.changes);
	 });
  // 버튼형 탭 전환 (mlss 방식)
	$('.btn-group label').on('click', function () {

	  // ✅ 탭 전환 전에 편집값 확정
	  contactGrid.finishEditing();
	  leadgrid.finishEditing();
	  demoGrid.finishEditing();
	
	  const targetSelector = $(this).data('target');
	
	  $('#tabContact, #tabLead, #tabDemo').hide();
	  $(targetSelector).show();
	
	  setTimeout(() => {
	    contactGrid.refreshLayout();
	    leadgrid.refreshLayout();
	    demoGrid.refreshLayout();
	  }, 0);
	});

</script>
</body>
</html>



