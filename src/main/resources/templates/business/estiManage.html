<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout}">
<head>
<meta charset="UTF-8">
<title>ê²¬ì ì„œ ê´€ë¦¬</title>
<style>
.ui-autocomplete {
  z-index: 9999 !important;
}
.approve-btn,
.reject-btn,
.order-btn {
  padding: 6px 8px;
  font-size: 14px;
  line-height: 1;
  min-width: 50px;
  border-radius: 4px;
}

/* ë²„íŠ¼ ì‚¬ì´ ê°„ê²© */
.approve-btn + .reject-btn {
  margin-left: 4px; 
}

/* ëª¨ë‹¬ í•©ê³„ css */
.order-summary-bar {
  margin-top: 8px;
  padding: 10px 16px;
  border-radius: 6px;
  background-color: #fff9e6;   /* ì˜…ì€ ë…¸ë‘ */
  display: flex;
  justify-content: flex-end;
  gap: 32px;
  font-size: 14px;
}

.order-summary-item {
  display: flex;
  align-items: baseline;
  gap: 6px;
}

.order-summary-label {
  color: #666;
  font-weight: 500;
}

.order-summary-value {
  color: #222;
  font-weight: 700;
}

/* === Grid ì „ì²´ íšŒìƒ‰ ì²˜ë¦¬ === */
.grid-readonly .tui-grid-body-area,
.grid-readonly .tui-grid-cell {
  background-color: #f5f5f5 !important;
  color: #777 !important;
}

/* === ì„ íƒëœ ì…€ í…Œë‘ë¦¬ ì œê±° === */
.grid-readonly .tui-grid-cell-selected,
.grid-readonly .tui-grid-cell-focused {
  background-color: #f5f5f5 !important;
  border-color: #ddd !important;
  box-shadow: none !important;
}

/* === í¸ì§‘ ì…€(ì£¼í™© í…Œë‘ë¦¬) ì œê±° === */
.grid-readonly .tui-grid-cell-editing {
  background-color: #f5f5f5 !important;
  border: none !important;
}

/* === í—¤ë” ì˜ì—­ë„ íšŒìƒ‰ === */
.grid-readonly .tui-grid-header-area {
  background-color: #f0f0f0;
}

/* === ì²´í¬ë°•ìŠ¤ í´ë¦­ ì°¨ë‹¨ + íë¦¬ê²Œ === */
.grid-readonly .tui-grid-row-header-checkbox {
  pointer-events: none;
  opacity: 0.4;
}

/* === ë§ˆìš°ìŠ¤ ì»¤ì„œë„ ê¸°ë³¸ê°’ìœ¼ë¡œ === */
.grid-readonly .tui-grid-cell {
  cursor: default !important;
}

.esti-history-table {
  width: 90%;
  margin: 0 auto;
}

.esti-history-table th,
.esti-history-table td {
  padding: 0.5em 1.2em;
  font-size: 1.2em;
}

.esti-history-table .btn {
  padding: 10px 30px;
  font-size: 20px;
}
.esti-history-table .col-version { width: 60px; }
.esti-history-table .col-view { width: 50px; }
.esti-history-table .col-amount { width: 100px; white-space: nowrap; }

.esti-info {
  display: flex;
  gap: 32px;
}
</style>

</head>
<body layout:fragment="content">
	<div class="esti-manage-wrapper" th:data-can-write-esti="${@authView.canWrite('MENU_SALES_002')}">
		<!-- ê²¬ì  ì¡°íšŒ ì¹´ë“œ -->
		<div class="row mb-3">
			<div class="col-md-12">
				<div class="card">

					<!-- ì¹´ë“œ í—¤ë” : ì œëª© + ì´ˆê¸°í™”/ì¡°íšŒ ë²„íŠ¼ -->
					<div class="card-header">
						<div class="card-header-left">
							<h5 class="card-title">ê²¬ì ì„œ ì¡°íšŒ</h5>
						</div>
						<div class="card-header-right">
							<button type="button" class="btn btn-dark" id="btnReset">ì´ˆê¸°í™”</button>
							<button type="button" class="btn btn-outline-dark" id="btnSearch">ì¡°íšŒ</button>
						</div>
					</div>
					<!-- end card-header -->

					<div class="card-body">
						<div class="row g-2">
							<div class="col-md-3">
								<label for="custcomName" class="form-label">ê³ ê°ì‚¬ëª…</label>
								<input id="custcomName" type="text" class="form-control" placeholder="ê³ ê°ì‚¬ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”">
							</div>
							
							<div class="col-1"></div>

							<div class="col-md-6">
								<label class="form-label">ë‚©ê¸°ì¼</label>
								<div class="d-flex align-items-center js-date-range">

									<!-- ì‹œì‘ì¼ -->
									<div class="input-group date">
										<input type="text" class="form-control datepicker js-date-range-start" placeholder="ì‹œì‘ì¼">
										<span class="input-group-text js-date-range-icon-start">
										<i class="bi bi-calendar"></i>
										</span>
									</div>

									<span class="mx-1 fw-bold fs-5">~</span>

									<!-- ì¢…ë£Œì¼ -->
									<div class="input-group date ms-2">
										<input type="text" class="form-control datepicker js-date-range-end" placeholder="ì¢…ë£Œì¼">
										<span class="input-group-text js-date-range-icon-end">
										<i class="bi bi-calendar"></i>
										</span>
									</div>

								</div>
							</div>

						</div>
					</div>
					<!-- card-body -->
				</div>
				<!-- end card -->
			</div>
		</div>
		<!-- end row -->

		<!-- ê²¬ì ì„œëª©ë¡ ì¹´ë“œ -->
		<div class="row">

			<!-- ê²¬ì ì„œëª©ë¡ ê·¸ë¦¬ë“œ -->
			<div class="col-md-12 d-flex">
				<div class="card w-100 h-100">

					<!-- ì¹´ë“œ í—¤ë” : ì œëª© + ì ê¸ˆ í•´ì œ ë²„íŠ¼ -->
					<div class="card-header with-actions">
						<div class="card-header-left">
							<h5 class="card-title">ê²¬ì ì„œ ëª©ë¡</h5>
						</div>
						<div class="card-header-right">

							<!-- <button type="button" class="btn btn-outline-dark" id="newEstiBtn">ì‹ ê·œ</button> -->
							<div th:replace="~{fragments/buttons :: newButton('MENU_SALES_002', 'newEstiBtn')}"></div>

							<button type="button" class="btn btn-outline-dark" id="editEstiBtn">ìˆ˜ì •</button>
							<button type="button" class="btn btn-outline-dark" id="openEstiHistoryModal">ì´ë ¥ë³´ê¸°</button>

						</div>
					</div>

					<div class="card-body">
						<div class="estiGridWrap">
							<div id="estiGrid"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- end ê²¬ì ì„œëª©ë¡ ì¹´ë“œ -->
	</div>
	<!-- end esti-manage-wrapper -->

<div th:replace="business/modal/newEstiModal :: newEstiModal"></div>
<div th:replace="business/modal/newSoModal :: newSoModal"></div>
<div th:replace="business/modal/estiHistoryModal :: estiHistoryModal"></div>

<script>

let estiGridReadonly = false;

/* ì •ì¬ë¯¼ ì¶”ê°€í•¨  */
	const wrapper = document.querySelector('.esti-manage-wrapper');
	const CAN_WRITE_ESTI = wrapper && wrapper.dataset.canWriteEsti === 'true';

//ìˆ«ì ë³€í™˜ ìœ í‹¸ (ê¸°ì¡´ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
function toNumber(val) {
  if (val === null || val === undefined) return 0;
  const str = String(val).replace(/,/g, '').trim();
  if (str === '') return 0;
  return Number(str) || 0;
}



	// 0. ë°ì´í„°
	const estiData = [];
	let searchForm = {
		    custcomName: "",
		    dueStart: "",
		    dueEnd: ""
	};

	// 1-1. Grid ê³µí†µ ì˜µì…˜
	const estiGridOptions = {
	    bodyHeight: 400,
	    scrollX: true,
	    scrollY: true,  // ì„¸ë¡œ
	    rowHeaders: ['checkbox'],     // ì¢Œì¸¡ ì²´í¬ë°•ìŠ¤
	    columnOptions: {
	        minWidth: 80,
	        resizable: true
	    }
	}; // 1-1. ë

	// 1-2. ê²¬ì ì„œ ëª©ë¡ ê·¸ë¦¬ë“œ ìƒì„±
	const estiGrid = new tui.Grid({
		el: document.getElementById('estiGrid'),
		data: estiData,
		...estiGridOptions,
		columns: [
			{ header: 'ê²¬ì ì„œì½”ë“œ', name: 'estiId', width: 150, align: 'center' },
			{ header: 'ë²„ì „', name: 'version', width: 100, align: 'center' },
			{ header: 'ê³ ê°ì‚¬ëª…', name: 'custcomNameResult' },
			{ header: 'ì—¬ì‹ í•œë„', name: 'cdtlnLmt', width: 150, align: 'right',
				formatter: ({ value }) => {
                   const num = toNumber(value);
                   return num ? num.toLocaleString() : '';
               }
			},
			{ header: 'ìƒí’ˆëª…', name: 'productName' },
			{ header: 'ê¸ˆì•¡í•©ê³„(ì›)', name: 'totalAmount', width: 150, align: 'right',
				formatter: ({ value }) => {
                   const num = toNumber(value);
                   return num ? num.toLocaleString() : '';
               }
			},
			/* { header: 'ì£¼ë¬¸ì¼', name: 'soDt', align: 'right'  }, */
			{ header: 'ë‚©ê¸°ì¼', name: 'dueDt', width: 120, align: 'center'  },
			{
				  header: 'ìŠ¹ì¸ / ë°˜ë ¤',
				  name: 'apRj',
				  width: 170,
				  align: 'center',
				  formatter: ({ row }) => {
				    const estiId = row.estiId;

				    // ëŒ€ê¸° (es1) â†’ ìŠ¹ì¸/ë°˜ë ¤
				    if (row.estiSt === 'es1') {
				      if (CAN_WRITE_ESTI) {
				        return `
				          <button class="btn btn-success approve-btn" data-id="${estiId}">ìŠ¹ì¸</button>
				          <button class="btn btn-danger reject-btn" data-id="${estiId}">ë°˜ë ¤</button>
				        `;
				      } else {
				        return `
				          <button class="btn btn-success approve-btn btn-disabled" data-id="${estiId}" disabled>ìŠ¹ì¸</button>
				          <button class="btn btn-danger reject-btn btn-disabled" data-id="${estiId}" disabled>ë°˜ë ¤</button>
				        `;
				      }
				    }

				    // ìŠ¹ì¸ë¨ (es2) â†’ ì£¼ë¬¸ì„œ ë“±ë¡
				    if (row.estiSt === 'es2') {
				      if (CAN_WRITE_ESTI) {
				        return `
				          <button class="btn btn-primary order-btn" data-id="${estiId}">ì£¼ë¬¸ì„œ ë“±ë¡</button>
				        `;
				      } else {
				        return `
				          <button class="btn btn-primary order-btn btn-disabled" data-id="${estiId}" disabled>ì£¼ë¬¸ì„œ ë“±ë¡</button>
				        `;
				      }
				    }

				    // ë°˜ë ¤ (es3) â†’ ê·¸ëƒ¥ disabled
				    if (row.estiSt === 'es3') {
				      return `
				        <button class="btn btn-success approve-btn btn-disabled" disabled>ìŠ¹ì¸</button>
				        <button class="btn btn-danger reject-btn btn-disabled" disabled>ë°˜ë ¤</button>
				      `;
				    }

				    return "";
				  }
			},
			{ 
				  header: 'ìƒíƒœ', 
				  name: 'estiStNm', 
				  align: 'center',
				  width: 150,
				  formatter: ({ row }) => {

				    if (row.estiSt === 'es3') {
				      return `
				        <div style="line-height:1.2;">
				          <div style="color:#dc3545;">${row.estiStNm}</div>
				          <div style="color:#dc3545; font-size:12px;">
				            ${row.recallResn || ''}
				          </div>
				        </div>
				      `;
				    }

				    let color = '';
				    if (row.estiSt === 'es2') {
				      color = 'green';
				    } else if (row.estiSt === 'es4') {
				      color = 'blue';
				    }

				    if (color) {
				      return `<span style="color:${color}; font-weight:500;">${row.estiStNm}</span>`;
				    }

				    // 3ï¸âƒ£ ë‚˜ë¨¸ì§€ëŠ” ê¸°ë³¸
				    return row.estiStNm;
				  }
				},
			/* { 
	    		header: 'ìƒíƒœ', 
	    		name: 'estiStNm', 
	    		align: 'center',
	    		width: 150,
	    		formatter: ({ row }) => {
	    		    // ë°˜ë ¤ì¼ ê²½ìš° ë¹„ê³ ë„ ë³´ì—¬ì¤Œ
	    		    if (row.estiSt === 'es3') {
	    		      return `
	    		        <div style="line-height:1.2;">
	    		          <div>${row.estiStNm}</div> 
	    		          <div style="color:#dc3545; font-size:12px;">${row.recallResn || ''}</div>
	    		        </div>
	    		      `;
	    		    }
	    		  return row.estiStNm;   // ìŠ¹ì¸/ëŒ€ê¸° ë“±ì€ ì›ë˜ ê·¸ëŒ€ë¡œ
    		    } 
			}, */
		]
	}); // 1-2. ê²¬ì ì„œëª©ë¡ ê·¸ë¦¬ë“œ ìƒì„± ë
	
	// 2. ë²„íŠ¼ ì´ë²¤íŠ¸
	// 2-1. ì´ˆê¸°í™” ë²„íŠ¼ ì´ë²¤íŠ¸
	document.getElementById("btnReset").addEventListener("click", function () {
	
	    // 1) searchForm ê°ì²´ ì´ˆê¸°í™”
	    searchForm = {
	        custcomName: "",
	        dueStart: "",
	        dueEnd: ""
	    };
	
	    // 2) í™”ë©´ Input ê°’ ì´ˆê¸°í™”
	    document.querySelector("#custcomName").value = "";
	    document.querySelector(".js-date-range-start").value = "";
	    document.querySelector(".js-date-range-end").value = "";
	
	    // datepicker ë¥¼ ì“°ëŠ” ê²½ìš° UI ë¦¬í”„ë ˆì‹œ
	    $('.js-date-range-start').datepicker('update', '');
	    $('.js-date-range-end').datepicker('update', '');
	
	    console.log("ê²€ìƒ‰ì¡°ê±´ ì´ˆê¸°í™”:", searchForm);
	});
	
	// 2-2. ì¡°íšŒ ë²„íŠ¼ ì´ë²¤íŠ¸
	document.getElementById("btnSearch").addEventListener("click", function () {
	
	    // 1) í™”ë©´ ì…ë ¥ê°’ â†’ searchForm ì— ì„¸íŒ…
	    searchForm.custcomName = document.querySelector("#custcomName").value.trim();
	    searchForm.dueStart = document.querySelector(".js-date-range-start").value;
	    searchForm.dueEnd = document.querySelector(".js-date-range-end").value;
	
	    console.log("ë³´ë‚¼ searchForm >>> ", searchForm);
	
	    // 2) ë°±ì—”ë“œ ì¡°íšŒ ìš”ì²­ (POST /esti/list)
	    axios.post("/esti/list", searchForm)
	        .then(res => {
	            console.log("ì¡°íšŒê²°ê³¼ >>> ", res.data);
	
	            // 3) ê·¸ë¦¬ë“œ ë°ì´í„° ë°˜ì˜
	            estiGrid.resetData(res.data);
	        })
	        .catch(err => console.error("ì¡°íšŒ ì¤‘ ì˜¤ë¥˜:", err));
	});
	
	
	
	// 2-3. ìŠ¹ì¸ ë²„íŠ¼ ì´ë²¤íŠ¸
	$(document).on('click', '.approve-btn', function () {
	
	  const estiId = $(this).data('id');   // data-id
	  const row = estiGrid.getData().find(r => r.estiId == estiId);  // rowKey = estiId ê°€ì •
	
	  if (!row) {
	    console.warn('í–‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. estiId =', estiId);
	    return;
	  }
	
	  const limit = Number(row.cdtlnLmt ?? 0);      // ì—¬ì‹ í•œë„
	  const total = Number(row.totalAmount ?? 0);  // ê¸ˆì•¡í•©ê³„
	  const version = row.version;
	
	  if (limit < total) {
	    const confirmed = confirm("ì—¬ì‹ í•œë„ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.\nê·¸ë˜ë„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
	    if (!confirmed) return;
	  }
	
	  // jQuery AJAXë¡œ ìƒíƒœ ì—…ë°ì´íŠ¸ í˜¸ì¶œ
	  $.ajax({
	    url: '/esti/updateStatus',
	    method: 'POST',
	    contentType: 'application/json',
	    data: JSON.stringify({
	      estiId: estiId,
	      version: version,
	      estiSt: 'es2'   // ìŠ¹ì¸ ì½”ë“œ
	    })
	  })
	  .done(function () {
	    alert('ìŠ¹ì¸ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
	    // ê·¸ë¦¬ë“œ ìƒíƒœ ê°±ì‹ 
	    const rowKey = row.rowKey ?? estiId;
	    estiGrid.setValue(rowKey, 'estiSt', 'es2');
	    estiGrid.setValue(rowKey, 'estiStNm', 'ìŠ¹ì¸');
	  })
	  .fail(function () {
    	alert('ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
	  });
	}); // 2-3 ìŠ¹ì¸ ë²„íŠ¼ ì´ë²¤íŠ¸ ë
	
	
	
	// 2-4. ë°˜ë ¤ ë²„íŠ¼ ì´ë²¤íŠ¸
	$(document).on('click', '.reject-btn', function () {
	
	  const estiId = $(this).data('id');
	  const row = estiGrid.getData().find(r => r.estiId == estiId);
	
	  if (!row) return;
	
	  // ë°˜ë ¤ ì‚¬ìœ  ì…ë ¥
	  const reason = prompt("ë°˜ë ¤ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
	  if (!reason) return;
	
	  $.ajax({
	    url: '/esti/updateStatus',
	    method: 'POST',
	    contentType: 'application/json',
	    data: JSON.stringify({
	      estiId: estiId,
	      estiSt: 'es3',
	      version: row.version,     // â˜… version í¬í•¨í•´ì•¼ í•¨
	      recallResn: reason        // â˜… ë°˜ë ¤ ì‚¬ìœ  í•„ë“œ
	    })
	  })
	  .done(function () {
	    alert('ë°˜ë ¤ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
	
	    // ê·¸ë¦¬ë“œ ì¦‰ì‹œ ê°±ì‹ 
	    estiGrid.setValue(row.rowKey ?? estiId, 'estiSt', 'es3');
	    estiGrid.setValue(row.rowKey ?? estiId, 'estiStNm', 'ë°˜ë ¤');
	    estiGrid.setValue(row.rowKey ?? estiId, 'recallResn', reason);
	  })
	  .fail(function (xhr) {
	    console.error(xhr);
	    alert('ë°˜ë ¤ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
	  });
	  
	  /* console.log("row.rowKey : ", row.rowKey); */
	}); // 2-4. ë°˜ë ¤ ë²„íŠ¼ ì´ë²¤íŠ¸ ë

	
// ===================================================================================================ì‹ ê·œ ê²¬ì ì„œ ëª¨ë‹¬
	// 0-1. ê³ ê°ì‚¬Id ìë™ì™„ì„±
	if (window.TeamCommon && TeamCommon.autocomplete && typeof TeamCommon.autocomplete.init === 'function') {

      TeamCommon.autocomplete.init({
        inputSelector: '#autoCustcomId',
        listSelector: '#autoCustcomIdSuggest',
        url: '/esti/custcomIdSearch',
        paramName: 'keyword',
        minLength: 1,
        delay: 300,
        preventClose: true,
        mapResponse: item => ({
            id: item.custcomId,
            label: item.custcomId,      // ìë™ì™„ì„± ëª©ë¡ì— ì‹¤ì œë¡œ ë³´ì´ëŠ” ê°’
            value: item.custcomId,      // inputì— ì…ë ¥ë  ê¸°ë³¸ê°’
            name: item.custcomName      // ì¶”ê°€ ì €ì¥ëœ ê³ ê°ì‚¬ëª…
        }),
        onSelect: item => {
            $('#autoCustcomId').val(item.value);
            $('#autoCustcomName').val(item.name);
        }
      });

    } else {
      console.warn('TeamCommon.autocomplete.init ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. teamUtil.js / autocomplete ìœ í‹¸ ë¡œë”© í™•ì¸');
    }



    // 0-2. ê³ ê°ì‚¬ëª… ìë™ì™„ì„± (ê³µí†µ ìœ í‹¸ ì‚¬ìš©)

    if (window.TeamCommon && TeamCommon.autocomplete && typeof TeamCommon.autocomplete.init === 'function') {

      TeamCommon.autocomplete.init({
        inputSelector: '#autoCustcomName',
        listSelector: '#autoCustcomNameSuggest',
        url: '/esti/custcomSearch',
        paramName: 'keyword',
        minLength: 1,
        delay: 300,
        preventClose: true,
        mapResponse: item => ({
            id: item.custcomId,
            label: item.custcomName,
            value: item.custcomName
        }),
        onSelect: item => {
            $('#autoCustcomName').val(item.value);
            $('#autoCustcomId').val(item.id);
        }
      });

    } else {
      console.warn('TeamCommon.autocomplete.init ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. teamUtil.js / autocomplete ìœ í‹¸ ë¡œë”© í™•ì¸');
    }


	
// 1. ëª¨ë‹¬ ë‚´ë¶€ ìƒí’ˆëª… auto complete
class ProductAutoComplete {
  constructor(props) {
    const el = document.createElement('input');
    el.type = 'text';
    el.className = 'tui-grid-content-input';
    el.value = props.value;

    // autocomplete ì„¤ì •
    $(el).autocomplete({
      minLength: 1,
      source: function(request, response) {
        $.ajax({
          url: '/esti/productSearch',
          data: { keyword: request.term },
          success: function(data) {
        	  response(data.map(item => ({
        	        label: item.productName,
        	        value: item.productName,
        	        productId: item.productId,
        	        basisSaleAmt: item.basisSaleAmt
       	      })));
          },
        });
      },

	      // ì‚¬ìš©ìê°€ ì„ íƒí–ˆì„ ë•Œ ì‹¤í–‰
	      select: function(event, ui) {
			  const grid = window.newEstiGrid;
			  const rowKey = props.rowKey;
			
			  grid.setValue(rowKey, 'productId', ui.item.productId);
			  grid.setValue(rowKey, 'productName', ui.item.value);
			  grid.setValue(rowKey, 'basisSaleAmt', ui.item.basisSaleAmt);
			
			  const custcomId = $('#autoCustcomId').val();
			  if (!custcomId) return;
			
			  fetch('/price/discount', {
			    method: 'POST',
			    headers: { 'Content-Type': 'application/json' },
			    body: JSON.stringify({
			      custcomId,
			      productId: ui.item.productId
			    })
			  })
			  .then(res => res.json())
			  .then(data => {
			    if (!data || !data.dcRate) return;
			    grid.setValue(rowKey, 'dcRate', data.dcRate);
			  });
		}
    });

    this.el = el;
  }

  getElement() {
    return this.el;
  }

  getValue() {
    return this.el.value;
  }

  mounted() {
    this.el.focus();
  }
}
	
	
// ============================================================= í• ì¸ìœ¨ ì¡°íšŒ í•¨ìˆ˜
function fetchDiscountRate(rowKey, productId) {
  const custcomId = $('#autoCustcomId').val();
  if (!custcomId) return;

  fetch(`/price/discount`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      custcomId,
      productId
    })
  })
  .then(res => res.json())
  .then(result => {
    const dcRate = result.dcRate || 0;

    window.newEstiGrid.setValue(rowKey, 'dcRate', dcRate);

    // ìˆ˜ëŸ‰ ìˆìœ¼ë©´ ë°”ë¡œ ê³„ì‚°
    recalcRow(rowKey);
  });
}	

	
// ìˆ˜ì • ëª¨ë‹¬ ì—´ ë•Œ í˜¸ì¶œ
function fillNewEstiModal(data) {

  // ê¸°ì¡´ ë°ì´í„° ì„¸íŒ…
  $('#autoCustcomId').val(data.custcomId);
  $('#autoCustcomName').val(data.custcomNameResult);

  // ê·¸ë¦¬ë“œ ë°ì´í„° ì„¸íŒ…
  window.newEstiGrid.resetData(data.detailList);

  // í• ì¸ìœ¨ ì¬ì¡°íšŒ
  setTimeout(() => {
	  applyDiscountRatesOnEdit();
	}, 0);
}

// ëª¨ë“  í–‰ í• ì¸ìœ¨ ì¬ì¡°íšŒ
function applyDiscountRatesOnEdit() {
	if (!window.newEstiGrid) return;
	
	const rows = window.newEstiGrid.getData();
	
	rows.forEach(row => {
	  if (!row.productId) return;
	  fetchDiscountRate(row.rowKey, row.productId);
	});
}

	

	
// ---------------------------- ì‹ ê·œ ê²¬ì ì„œ ëª¨ë‹¬ ìŠ¤í¬ë¦½íŠ¸
	//1. ê·¸ë¦¬ë“œ ìƒì„±
	window.newEstiGrid = null;

	function loadNewEstiGrid(data = []) {
	  if (window.newEstiGrid) {
	    window.newEstiGrid.resetData(data);
	    return;
	  }
	
	  window.newEstiGrid = new tui.Grid({
	    el: document.getElementById('newEstiGridDiv'),
	    scrollX: true,
	    scrollY: true,
	    bodyHeight: 350,
	    columnOptions: {
	        resizable: false,   // ì»¬ëŸ¼ ë¦¬ì‚¬ì´ì¦ˆ ê°€ëŠ¥
	        minWidth: 80      // ê¸°ë³¸ ìµœì†Œ í­
	    },
	    rowHeaders: ['checkbox'],
	    columns: [
	      { name: 'productId', hidden: true },   // â† PK ì €ì¥
    	  {
    	    header: 'ìƒí’ˆëª…*',
    	    name: 'productName',
    	    width: 200,
    	    editor: {
    	      type: ProductAutoComplete
    	    }
    	  },
	      { header: 'ìˆ˜ëŸ‰(EA)*', 
	    	  name: 'qy',  
	    	  width: 90,
	    	  align: 'right',
	    	  editor: {
    		    type: 'text',
    		    options: { inputType: 'number' } // ëª¨ë°”ì¼ í‚¤íŒ¨ë“œ ìœ ë„ìš©(PCì—ì„  ì™„ë²½ ì°¨ë‹¨ X)
    		  },
    		  validation: {
    		    required: true,
    		    regExp: /^[0-9]+$/   // ì •ìˆ˜ë§Œ í—ˆìš©
    		  },
			  formatter: ({ value }) => {
                   const num = toNumber(value);
                   return num ? num.toLocaleString() : '';
              }
    	  	
    	  },
	      { header: 'íŒë§¤ë‹¨ê°€(ì›)', name: 'basisSaleAmt',  width: 180, align:'right',
				formatter: ({ value }) => {
	                   const num = toNumber(value);
	                   return num ? num.toLocaleString() : '';
	            } 
		  },
	      { header: 'í• ì¸ìœ¨(%)', name: 'dcRate',  width: 90, align:'right' },
	      { header: 'í• ì¸ê¸ˆì•¡(ì›)', name: 'saleAmt',  width: 180, align:'right',
				formatter: ({ value }) => {
	                   const num = toNumber(value);
	                   return num ? num.toLocaleString() : '';
	               } },
	      { 
	    	  header: 'ìµœì¢…ê¸ˆì•¡(ì›)', 
	    	  name: 'finalAmt',  
	    	  width: 222, 
	    	  align:'right',
	    	  whiteSpace: 'normal',     // ì¤„ë°”ê¿ˆ ê°€ëŠ¥
	    	  formatter({ value }) {
	    	    return value ? value.toLocaleString() : '';
	    	  }
	      },
	      { name: 'soDt', hidden: true },
	    ]
	  });
	  
	  
	  // ìˆ«ìë§Œ ì…ë ¥
	  window.newEstiGrid.on('editingStart', (ev) => {
		  if (estiGridReadonly) {
			    grid.finishEditing(); // â­ í¸ì§‘ ê°•ì œ ì¢…ë£Œ
			    return;
			  }
		  
		    if (ev.columnName !== 'qy') return;

		    const rowKey = ev.rowKey;
		    const value = window.newEstiGrid.getValue(rowKey, 'qy');

		    if (!/^\d+$/.test(String(value))) {
		      window.newEstiGrid.setValue(rowKey, 'qy', '');
		    }

		    // UX ì „ì²´ì„ íƒ (ì•„ë˜ ì„¤ëª… ì°¸ê³ )
		    setTimeout(() => {
		      const input = document.querySelector('.tui-grid-cell-editor input');
		      if (input) input.select();
		    });
		  });
	  
	  newEstiGrid.on('editingFinish', (ev) => {
		  if (estiGridReadonly) return;
		  
		  if (!['mrtggLmt', 'creditLmt'].includes(ev.columnName)) return;

		  const rowKey = ev.rowKey;
		  const col = ev.columnName;
		  let value = newEstiGrid.getValue(rowKey, col);

		  // í¸ì§‘ ëë‚˜ê³  ìˆ«ìë§Œ ë‚¨ê¸°ê¸°
		  value = String(value ?? '').replace(/[^\d]/g, '');

		  newEstiGrid.setValue(rowKey, col, value);
		});
		
	  
	  
	  
	  window.newEstiGrid.on('afterChange', (ev) => {
		  ev.changes.forEach(change => {
		    const rowKey = change.rowKey;

		    const qty   = Number(window.newEstiGrid.getValue(rowKey, 'qy') || 0);
		    const price = Number(window.newEstiGrid.getValue(rowKey, 'basisSaleAmt') || 0);
		    const dcRate = Number(window.newEstiGrid.getValue(rowKey, 'dcRate') || 0);

		    if (!qty || !price) return;

		    const grossAmt = qty * price;
		    const saleAmt  = Math.floor(grossAmt * dcRate / 100);
		    const finalAmt = grossAmt - saleAmt;

		    window.newEstiGrid.setValue(rowKey, 'saleAmt', saleAmt);
		    window.newEstiGrid.setValue(rowKey, 'finalAmt', finalAmt);
		  });
		});
	}

	
	// í–‰ë‹¨ìœ„ ê³„ì‚° í•¨ìˆ˜
	function recalcRow(rowKey) {
	  const grid = window.newEstiGrid;
	
	  const qty   = Number(grid.getValue(rowKey, 'qy') || 0);
	  const price = Number(grid.getValue(rowKey, 'basisSaleAmt') || 0);
	  const rate  = Number(grid.getValue(rowKey, 'dcRate') || 0);
	
	  if (qty === 0 || price === 0) return;
	
	  const supplyAmt = qty * price;
	  const saleAmt   = Math.floor(supplyAmt * rate / 100);
	  const finalAmt  = supplyAmt - saleAmt;
	
	  grid.setValue(rowKey, 'saleAmt', saleAmt);
	  grid.setValue(rowKey, 'finalAmt', finalAmt);
	}
	
// ================== í• ì¸ì¡°íšŒ í•¨ìˆ˜
	function fetchMaxDiscount({ custcomId, productId }) {
		  if (!custcomId || !productId) {
		    return Promise.resolve({ dcRate: 0 });
		  }

		  return fetch('/price/discount', {
		    method: 'POST',
		    headers: { 'Content-Type': 'application/json' },
		    body: JSON.stringify({ custcomId, productId })
		  })
		  .then(res => res.json())
		  .catch(err => {
		    console.error('í• ì¸ ì¡°íšŒ ì‹¤íŒ¨', err);
		    return { dcRate: 0 };
		  });
		}
	
	
// -------------------------------- ì‹ ê·œê²¬ì ì„œ ëª¨ë‹¬ì˜¤í”ˆ ë²„íŠ¼ì´ë²¤íŠ¸
	// ì‹ ê·œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
	$(document).on("click", "#newEstiBtn", function () {
	  openNewEstiModal();
	});


    // 1-1 ì‹ ê·œ ê²¬ì ì„œ ëª¨ë‹¬
	const openBtn = document.getElementById("newEstiBtn");
	const modal   = document.getElementById("newEstiModal");
	const back    = document.getElementById("newEstiBackdrop");
	
	function openNewEstiModal() {
		
	    
		modal.classList.add("show");
		modal.style.display = "block";
		back.style.display = "block";
		
		if (!window.newEstiGrid) {
		  loadNewEstiGrid();
	      window.newEstiGrid.refreshLayout();
		} 
		
		
	} // openNewEstiModal

	// ë‹«ê¸° í•¨ìˆ˜ì— í¬í•¨í•  ì´ˆê¸°í™” í•¨ìˆ˜
	function resetEstiModalState() {
		  $("#newEstiModal").data("mode", "new");
		  setEstiModalReadonly(false);
		  $("#newEstiModal .modal-title").text("ê²¬ì ì„œ ë“±ë¡/ìˆ˜ì •");
	}
	// ë‹«ê¸° í•¨ìˆ˜
	function closeNewEstiModal() {
		modal.classList.remove("show");
		modal.style.display = "none";
		back.style.display = "none";
		
		// ëª¨ë‹¬ ë‹«ì„ ë•Œ ì…ë ¥ê°’ ì´ˆê¸°í™”
		resetNewEstiForm();
		resetEstiModalState();
	} // closeNewEstiModal
	
	function resetNewEstiForm() {

		// 1) ëª¨ë‹¬ ì…ë ¥ì°½ ì´ˆê¸°í™”
		$('#autoCustcomId').val('');
		$('#autoCustcomName').val('');
		$('#mDueDt').val('');
		$('#mDueDt').datepicker('setDate', null);
		$('#autoRemark').val('');
		$('#applyDate').val('');
		
		// 2) ê·¸ë¦¬ë“œ ë°ì´í„° ì´ˆê¸°í™”
		if (window.newEstiGrid) {
		  window.newEstiGrid.resetData([]);   // ë¹ˆ ë°°ì—´ë¡œ ì´ˆê¸°í™”
		}
	} // resetNewEstiForm
	
	// ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
	modal.addEventListener("click", (event) => {
		if (!event.target.closest(".modal-content")) {
		  closeNewEstiModal();
		}
	});

// end ì‹ ê·œ ê²¬ì ì„œ ëª¨ë‹¬

	// 2. ëª¨ë‹¬ í–‰ì¶”ê°€ ë²„íŠ¼ ì´ë²¤íŠ¸
	$('#addRowBtn').on('click', function () {
	    
	    // ì‹ ê·œ í–‰ ê¸°ë³¸ê°’
	    const newRow = {
	        productName: '',
	        qy: '',
	        unit: '',
	        basisSaleAmt: '',
	        discountAmt: '',
	        finalAmt: ''
	    };
	
	    // ê·¸ë¦¬ë“œì— í–‰ ì¶”ê°€ (ë§¨ ë§ˆì§€ë§‰ì— ì¶”ê°€)
	    window.newEstiGrid.appendRow(newRow, { at: 0 });
	
	});
	
	// 3. ëª¨ë‹¬ í–‰ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
	$('#deleteRowBtn').on('click', function () {
	    const rowKeys = window.newEstiGrid.getCheckedRowKeys();   // ì²´í¬ëœ row key ëª©ë¡
	
	    if (rowKeys.length === 0) {
	        alert("ì‚­ì œí•  í–‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
	        return;
	    }
	
	    // ì„ íƒëœ row ì œê±°
	    window.newEstiGrid.removeRows(rowKeys);
	});
	
	// 4. ëª¨ë‹¬ ì €ì¥ë²„íŠ¼ ì´ë²¤íŠ¸
	document.getElementById("btnEstiSave").addEventListener("click", function () {
	
	  // ê³ ê°ì‚¬ ì²´í¬
	  const custcomId = document.getElementById("autoCustcomId").value;
	  if (!custcomId || custcomId.trim() === "") {
	    alert("ê³ ê°ì‚¬ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
	    return;
	  }
	
	  // ë‚©ê¸°ì¼ ì²´í¬
	  const dueDt = document.getElementById("mDueDt").value;
	  if (!dueDt || dueDt.trim() === "") {
	    alert("ë‚©ê¸°ì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
	    return;
	  }
	
	  // ê·¸ë¦¬ë“œ ë°ì´í„°
	  const rows = window.newEstiGrid.getData();
	  if (!rows || rows.length === 0) {
	    alert("ìƒí’ˆì´ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\nìƒí’ˆì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.");
	    return;
	  }
	
	  // ìƒì„¸ ë¦¬ìŠ¤íŠ¸ êµ¬ì„±
	  const detailList = rows.map(row => ({
	    productId: row.productId,
	    qy: Number(row.qy || 0),
	    price: Number(row.basisSaleAmt || 0),
	    supplyAmt: Number(row.finalAmt || 0),
	    rm: row.rm || null
	  }));
	
	  // ìˆ˜ì • / ì‹ ê·œ êµ¬ë¶„
	  const estiIdHidden = document.getElementById("estiIdHidden").value;
	
	  
	  console.log("ê³ ê°ì‚¬ID:", custcomId);
	  console.log("ê³ ê°ì‚¬ëª…:", custcomName);
	  
	  // payload
	  const payload = {
	    estiId: estiIdHidden ? estiIdHidden : null, // âœ” ìˆìœ¼ë©´ ë‹¤ìŒ ver INSERT
	    custcomId: custcomId,
	    custcomName: document.getElementById("autoCustcomName").value,
	    dueDt: dueDt,
	    estiSt: "es1",          // ì„œë²„ì—ì„œ ê¸°ë³¸ê°’ ì²˜ë¦¬í•´ë„ OK
	    detailList: detailList
	  };
	
	  console.log("esti save payload >>>", payload);
	
	  // ì €ì¥ ìš”ì²­
	  fetch("/esti/save", {
	    method: "POST",
	    headers: { "Content-Type": "application/json" },
	    body: JSON.stringify(payload)
	  })
	    .then(res => res.json())
	    .then(result => {
		  console.log("save result:", result);
		
		  if (!result.success) {
		    alert(result.message || "ì €ì¥ ì‹¤íŒ¨");
		    return;
		  }
		
		  alert("ì €ì¥ ì™„ë£Œ\nê²¬ì ì„œ ë²ˆí˜¸ : " + result.estiId);
		
		  const estiIdHidden = document.getElementById("estiIdHidden");
		  console.log("estiIdHidden:", estiIdHidden);
		
		  if (estiIdHidden) {
		    estiIdHidden.value = result.estiId;
		  }
		
		  closeNewEstiModal();
		
		  const btnSearch = document.getElementById("btnSearch");
		  if (btnSearch) {
		    btnSearch.click();
		  }
		})
		.catch(err => {
		  console.error("âŒ catch error:", err);
		  alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
		});
	    /* .then(result => {
	      if (result.success) {
	        alert("ì €ì¥ ì™„ë£Œ\nê²¬ì ì„œ ë²ˆí˜¸ : " + result.estiId);
	
	        // ë‹¤ìŒ ì €ì¥ë¶€í„° ê°™ì€ estiIdë¡œ ë²„ì „ì—…
	        document.getElementById("estiIdHidden").value = result.estiId;
	
	        closeNewEstiModal();
	
	        // ë©”ì¸ ê·¸ë¦¬ë“œ ì¬ì¡°íšŒ
	        document.getElementById("btnSearch").click();
	      } else {
	        alert(result.message || "ì €ì¥ ì‹¤íŒ¨");
	      }
	    })
	    .catch(err => {
	      console.error(err);
	      alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
	    }); */
	});
	
	
	
// ============================================================== ê²¬ì ì„œ ìˆ˜ì •ë²„íŠ¼
	// ìˆ˜ì •ë²„íŠ¼ ì´ë²¤íŠ¸
	$("#editEstiBtn").on("click", function () {
	
	  const checked = estiGrid.getCheckedRows();
	
	  if (checked.length !== 1) {
	    alert("ìˆ˜ì •í•  ê²¬ì ì„œë¥¼ 1ê±´ë§Œ ì„ íƒí•˜ì„¸ìš”.");
	    return;
	  }
	
	  const row = checked[0];
	
	  // ìŠ¹ì¸ ì™„ë£Œ ê²¬ì ì€ ìˆ˜ì • ë¶ˆê°€
	  if (row.estiSt === 'es2' || row.estiSt === 'es4') {
	  alert("ìŠ¹ì¸ ì™„ë£Œë˜ì—ˆê±°ë‚˜ ì£¼ë¬¸ì„œê°€ ë“±ë¡ëœ ê²¬ì ì„œëŠ” ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
	  return;
	}
	
	  openEditEstiModal(row.estiId);
	});
	
	
	// ìˆ˜ì •ë²„íŠ¼ ëª¨ë‹¬ì˜¤í”ˆ ì´ë²¤íŠ¸
	function openEditEstiModal(estiId) {
	
	  // ëª¨ë‹¬ ì œëª© ë³€ê²½
	  $("#newEstiModal .modal-title").text("ê²¬ì ì„œ ìˆ˜ì • (ì‹ ê·œ ë²„ì „ ìƒì„±)");
	
	  // ìˆ˜ì • ëª¨ë“œ í”Œë˜ê·¸
	  $("#newEstiModal").data("mode", "edit");
	
	  // estiId hidden ì„¸íŒ…
	  $("#estiIdHidden").val(estiId);
	
	  // ëª¨ë‹¬ ì—´ê¸°
	  openNewEstiModal();
	
	  // ê¸°ì¡´ ê²¬ì  ë°ì´í„° ì¡°íšŒ
	  fetch(`/esti/${estiId}`)
	    .then(res => res.json())
	    .then(data => {
	      fillEstiModal(data);
	      openNewEstiModal();
	    })
	    .catch(err => {
	      console.error(err);
	      alert("ê²¬ì ì„œ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
	    });
	}
	
	// ê²¬ì ì„œ ëª¨ë‹¬ ì±„ìš°ê¸° í•¨ìˆ˜
	function fillEstiModal(data) {

		console.log("ê²¬ì  header:", data);
		console.log("ê²¬ì  detailList:", data.detailList);
		
		// í—¤ë” ì„¸íŒ…
		$("#autoCustcomId").val(data.custcomId);
		$("#autoCustcomName").val(data.custcomNameResult);
		$("#mDueDt").val(data.dueDt);
		$("#autoRemark").val(data.rm || "");
		
		$('#estiIdText').text(data.estiId);
		$('#custcomNameText').text(data.custcomNameResult);

	  // ê·¸ë¦¬ë“œ ë°ì´í„° ë³€í™˜
	  const gridData = data.detailList.map(d => ({
	    productId: d.productId,
	    productName: d.productName,
	    qy: d.qy,
	    basisSaleAmt: d.price,
	    finalAmt: d.supplyAmt
	  }));

	  // ê·¸ë¦¬ë“œ ë¡œë”©
	  loadNewEstiGrid(gridData);
	  
	  applyDiscountRatesOnEdit();
	}
	
	// ê²¬ì ì„œ ëª¨ë‹¬ ë‹«ì„ë•Œ ì´ˆê¸°í™”
	function resetNewEstiForm() {

	  $('#autoCustcomId').val('');
	  $('#autoCustcomName').val('');
	  $('#applyDate').val('');
	  $('#autoRemark').val('');

		
	  
	  // estiId ì´ˆê¸°í™” (ì•ˆ í•˜ë©´ ë‹¤ìŒì— ê¼¬ì„)
	  $("#estiIdHidden").val('');

	  if (window.newEstiGrid) {
	    window.newEstiGrid.resetData([]);
	  }
	}
	
	
// ==================================================================== ì´ë ¥ë³´ê¸° ëª¨ë‹¬
	// ì´ë ¥ë³´ê¸° ë²„íŠ¼ í´ë¦­
	document.getElementById("openEstiHistoryModal").addEventListener("click", function () {
	
	  // âœ” Toast Gridì—ì„œ ì„ íƒëœ í–‰ ê°€ì ¸ì˜¤ê¸°
	  const checkedRows = estiGrid.getCheckedRows(); 
	  // ë˜ëŠ” ë‹¨ì¼ ì„ íƒì´ë©´ getFocusedCell ì‚¬ìš© ê°€ëŠ¥
	
	  if (!checkedRows || checkedRows.length === 0) {
	    alert("ì´ë ¥ì„ í™•ì¸í•  ê²¬ì ì„œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
	    return;
	  }
	
	  if (checkedRows.length > 1) {
	    alert("ì´ë ¥ë³´ê¸°ëŠ” í•˜ë‚˜ì˜ ê²¬ì ì„œë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
	    return;
	  }
	
	  const estiId = checkedRows[0].estiId;
	
	  // ê¸°ì¡´ì— ë§Œë“¤ì–´ë‘” í•¨ìˆ˜ ì¬ì‚¬ìš©
	  openEstiHistoryModal(estiId);
	});
	
	function renderStatusBadge(statusNm) {
	  switch (statusNm) {
	    case 'ìŠ¹ì¸':
	      return '<span class="badge bg-success">ìŠ¹ì¸</span>';
	    case 'ë°˜ë ¤':
	      return '<span class="badge bg-danger">ë°˜ë ¤</span>';
	    default:
	      return '<span class="badge bg-secondary">ëŒ€ê¸°</span>';
	  }
	}
	
	function openEstiHistoryModal(estiId) {
		  fetch(`/esti/history/${estiId}`)
		    .then(res => res.json())
		    .then(list => {
		    	 // ìƒë‹¨ í…ìŠ¤íŠ¸ ì„¸íŒ…
		        document.getElementById('estiIdText').innerText = estiId;

		        if (list.length > 0) {
		          document.getElementById('custcomNameText').innerText =
		            list[0].custcomNameText || '';
		        }
		    	
		      const tbody = document.getElementById("estiHistoryTbody");
		      tbody.innerHTML = "";

		      list.forEach(row => {
		        tbody.innerHTML += `
		          <tr>
		            <td>${row.version}</td>
		            <td>${row.creaDt}</td>
		            <td class="text-end">${Number(row.ttSupplyAmt).toLocaleString()}</td>
		            <td>${row.creaBy}</td>
		            <td>
		            	<button class="btn btn-outline-dark" onclick="openEstiDetail('${row.estiId}', '${row.version}')" >ë³´ê¸°</button>
		            </td>
		          </tr>
		        `;
		      });

		      new bootstrap.Modal(document.getElementById("estiHistoryModal")).show();
		    });
		}
	
	
	// ì´ë ¥ë³´ê¸° ëª¨ë‹¬ì˜ "ë³´ê¸°" ë²„íŠ¼ì—ì„œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜
	function openEstiDetail(estiId, version) {
		  // í¬ì»¤ìŠ¤ ì œê±°
		  document.activeElement?.blur();

		  // ì´ë ¥ ëª¨ë‹¬ ë‹«ê¸°
		  const historyModalEl = document.getElementById("estiHistoryModal");
		  const historyModal = bootstrap.Modal.getInstance(historyModalEl);
		  historyModal?.hide();
		
	  fetch(`/esti/detail/${estiId}/${version}`)
	    .then(res => res.json())
	    .then(data => {
	      // 1) ê¸°ì¡´ ì‹ ê·œ/ìˆ˜ì • ëª¨ë‹¬ì„ "ì½ê¸°ì „ìš© ë³´ê¸°" ëª¨ë“œë¡œ ì—´ê¸°
	      $("#newEstiModal .modal-title").text(`ê²¬ì ì„œ ë³´ê¸° (${version})`);
	      $("#newEstiModal").data("mode", "view");

	      

	      // 3) ì½ê¸°ì „ìš© ì²˜ë¦¬(ì…ë ¥ ë§‰ê¸°)
	      setEstiModalReadonly(true);

	      // 4) ëª¨ë‹¬ ì—´ê¸°
	      openNewEstiModal();
	      
	  	  // 2) ê°’ ì±„ìš°ê¸°
	      fillEstiModal(data);

	      // 5) ì´ë ¥ ëª¨ë‹¬ ë‹«ê¸°(ì›í•˜ë©´)
	      const hist = bootstrap.Modal.getInstance(document.getElementById("estiHistoryModal"));
	      if (hist) hist.hide();
	    })
	    .catch(err => {
	      console.error(err);
	      alert("ê²¬ì ì„œ ìƒì„¸ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
	    });
	}

	// ì…ë ¥/ê·¸ë¦¬ë“œ ì½ê¸°ì „ìš© í† ê¸€
	function setEstiModalReadonly(readonly) {
		estiGridReadonly = readonly;
		
		
	  $("#autoCustcomId").prop("disabled", readonly);
	  $("#autoCustcomName").prop("disabled", readonly);
	  $("#applyDate").prop("disabled", readonly);
	  $("#autoRemark").prop("disabled", readonly);
	  // ì €ì¥ ë²„íŠ¼ ìˆ¨ê¹€/ë¹„í™œì„±
	  // $("#btnEstiSave").prop("disabled", readonly);
	  // í–‰ì¶”ê°€/ì‚­ì œ ë²„íŠ¼ë„ ë§‰ê¸°
	  // $("#addRowBtn, #deleteRowBtn, #maxDcBtn").prop("disabled", readonly);

	  // ë²„íŠ¼ ì œì–´
	  if (readonly) {
	    $("#btnEstiSave").hide();
	    $("#addRowBtn, #deleteRowBtn, #maxDcBtn").hide();
	  } else {
	    $("#btnEstiSave").show();
	    $("#addRowBtn, #deleteRowBtn, #maxDcBtn").show();
	  }
	  
	  // grid í¸ì§‘ ë§‰ê¸°
/* 	  if (window.newEstiGrid) {
		  window.newEstiGrid.getColumns().forEach(col => {
		    window.newEstiGrid.setColumnOptions(col.name, {
		      editable: !readonly
		    });
		  });
		} */
	  if (window.newEstiGrid) {
	    window.newEstiGrid.setColumns(
	      window.newEstiGrid.getColumns().map(col => ({
	        ...col,
	        editor: readonly ? null : col.editor
	      }))
	    );
	  }
	}
	
	
// ========================================================================== ì£¼ë¬¸ì„œ ë“±ë¡ ë²„íŠ¼ ëª¨ë‹¬
	// 0. ì£¼ë¬¸ì„œ ê·¸ë¦¬ë“œ ì „ì—­
	window.newSoGrid = null;
	
	// 0-1. ì£¼ë¬¸ì„œ ìƒì„¸ ê·¸ë¦¬ë“œ ìƒì„±
	function loadNewSoGrid(data = []) {
	  if (window.newSoGrid) {
	    window.newSoGrid.resetData(data);
	    return;
	  }
	
	  window.newSoGrid = new tui.Grid({
	    el: document.getElementById("newSoGrid"),
	    data: data,
	    scrollX: true,
	    scrollY: true,
	    bodyHeight: 180,
	    rowHeaders: [],    // ì½ê¸° ì „ìš©ì´ë©´ ì²´í¬ë°•ìŠ¤ ì—†ì–´ë„ ë¨
	    columns: [
	      { name: 'productId', header: 'ìƒí’ˆID', hidden: true },
	      { name: 'productName', header: 'ìƒí’ˆëª…', width: 302 },
	      { name: 'qy', header: 'ìˆ˜ëŸ‰', width: 100, align: 'right',
				formatter: ({ value }) => {
	                   const num = toNumber(value);
	                   return num ? num.toLocaleString() : '';
	            }  },
	      { name: 'price', header: 'ë‹¨ê°€', width: 200, align: 'right',
					formatter: ({ value }) => {
		                   const num = toNumber(value);
		                   return num ? num.toLocaleString() : '';
		            }  },
	      { name: 'supplyAmt', header: 'ê³µê¸‰ê°€ì•¡', width: 200, align: 'right',
						formatter: ({ value }) => {
			                   const num = toNumber(value);
			                   return num ? num.toLocaleString() : '';
			            }  }
	    ]
	  });
	}
	
	// 1. ê²¬ì  ê·¸ë¦¬ë“œ - ì£¼ë¬¸ì„œ ë“±ë¡ ë²„íŠ¼ í´ë¦­
	$(document).on("click", ".order-btn", function () {
	  const estiId = $(this).data("id");
	
	  fetch(`/so/fromEsti/${estiId}`)
	    .then(res => {
	      if (!res.ok) {
	        return res.text().then(text => {
	          console.error("GET /so/fromEsti ì—ëŸ¬ ì‘ë‹µ >>>", text);
	          throw new Error("server error");
	        });
	      }
	      return res.json();
	    })
	    .then(data => {
		  const header = data.header;
		  const detailList = data.detailList || [];
		  
		  console.log("ğŸ“Œ header.soDt =", header.soDt);
		
		  $("#newSoEstiId").val(header.estiId);
		  $("#newSoEstiIdView").val(header.estiId);
		  $("#newSoVersion").val(header.version);
		  $("#newSoCustcomId").val(header.custcomId);
		  $("#newSoCustcomName").val(header.custcomNameResult);
		  $("#newSoDueDt").val(header.dueDt);
		  $("#newSoDt").val(header.soDt);
		
		  // â–¶ ê³µê¸‰ê°€ í•©ê³„ ê³„ì‚°
		  const totalSupply = detailList.reduce((sum, row) => {
		    return sum + (Number(row.supplyAmt || 0));
		  }, 0);
/* 		  $("#newSoTtSupplyPrice").val(
		    totalSupply ? totalSupply.toLocaleString() : ""
		  ); */
		
		  loadNewSoGrid(detailList);
		  
		  // í•˜ë‹¨ í•©ê³„ ê°±ì‹ 
	      updateOrderSummary(detailList);
		  
		  openNewSoModal();
		})
	    .catch(err => {
	      console.error(err);
	      alert("ì£¼ë¬¸ì„œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
	    });
	});
	
	
	  
	// 2. ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
	function openNewSoModal() {
	  const modal = document.getElementById("newSoModal");
	  const back  = document.getElementById("newSoBackdrop");
	
	  modal.classList.add("show");
	  modal.style.display = "block";
	  back.style.display  = "block";
	
	  if (window.newSoGrid) window.newSoGrid.refreshLayout();
	}
	
	function closeNewSoModal() {
	  document.getElementById("newSoModal").classList.remove("show");
	  document.getElementById("newSoModal").style.display = "none";
	  document.getElementById("newSoBackdrop").style.display = "none";
	
	  resetNewSoForm();
	}
	
	function resetNewSoForm() {
	  $("#newSoEstiId").val("");
	  $("#newSoId").val("");
	  $("#newSoEstiIdView").val("");
	  $("#newSoVersion").val("");
	  $("#newSoCustcomName").val("");
	  $("#newSoDueDt").val("");
	  $("#newSoShipAddr").val("");
	  $("#newSoRm").val("");
	
	  if (window.newSoGrid) {
	    window.newSoGrid.resetData([]);
	  }
	}
	
	// ëª¨ë‹¬ ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
	document.getElementById("newSoModal")
	  .addEventListener("click", (event) => {
	    if (!event.target.closest(".modal-content")) {
	      closeNewSoModal();
	    }
	  });
	
	// 3. ëª¨ë‹¬ ì´ˆê¸°í™” ë²„íŠ¼
	$("#newSoModalInit").on("click", function () {
	  resetNewSoForm();
	});
	
	// 4. ëª¨ë‹¬ ì €ì¥ ë²„íŠ¼
	$("#newSoModalSaveBtn").on("click", function () {
		
	  // id ì´ë¦„ newSoXXX ë¡œ ë§ì¶”ê¸°
	  const estiId   = $("#newSoEstiId").val();
	  const version  = $("#newSoVersion").val();  // ê²¬ì  ë²„ì „
	  const custcomId = $("#newSoCustcomId").val();
	  const dueDt     = $("#newSoDueDt").val();
	  const soDt = $("#newSoDt").val();
	  const shipAddr = $("#newSoShipAddr").val();
	  const orderRm  = $("#newSoRm").val();
	  
	  // grid ê°ì²´ ì´ë¦„ newSoGrid ì‚¬ìš©
	  const rows = window.newSoGrid ? window.newSoGrid.getData() : [];
	
	  const detailList = rows.map(r => ({
	    productId: r.productId,
	    qy: Number(r.qy || 0),
	    price: Number(r.price || 0),
	    supplyAmt: Number(r.supplyAmt || 0)
	  }));
	
	  const payload = {
	    estiId: estiId,
	    version: version,     // tb_so.version â† ê²¬ì  ë²„ì „
	    custcomId: custcomId,
	    dueDt: dueDt,
	    shipAddr: shipAddr,
	    rm: orderRm,
	    
	    detailList: detailList
	  };
	
	  fetch("/so/fromEsti/save", {
	    method: "POST",
	    headers: { "Content-Type": "application/json" },
	    body: JSON.stringify(payload)
	  })
	    .then(res => res.json())
	    .then(result => {
	      if (result.success) {
	        alert("ì£¼ë¬¸ì„œ ë“±ë¡ ì™„ë£Œ\nì£¼ë¬¸ë²ˆí˜¸ : " + result.soId);
	        closeNewSoModal();          // í•¨ìˆ˜ ì´ë¦„ë„ newSoModalë¡œ
	
	        // ê²¬ì  ëª©ë¡ ì¬ì¡°íšŒ
	        $("#btnSearch").click();
	      } else {
	        alert("ì €ì¥ ì‹¤íŒ¨");
	      }
	    })
	    .catch(err => {
	      console.error(err);
	      alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
	    });
	});
	
	// ì£¼ë¬¸ì„œë“±ë¡ ëª¨ë‹¬ í•©ê³„ë“±ë¡ í•¨ìˆ˜
	function updateOrderSummary(detailList) {
	  const supplyTotal = detailList.reduce((sum, row) => {
	    return sum + Number(row.supplyAmt || 0);
	  }, 0);
	
	  const vatTotal = Math.floor(supplyTotal * 0.1);
	  const grandTotal = supplyTotal + vatTotal;
	
	  $("#sumSupply").text(
	    supplyTotal ? supplyTotal.toLocaleString() : "0"
	  );
	  $("#sumVat").text(
	    vatTotal ? vatTotal.toLocaleString() : "0"
	  );
	  $("#sumTotal").text(
	    grandTotal ? grandTotal.toLocaleString() : "0"
	  );
	}
	
</script>

</body>
</html>