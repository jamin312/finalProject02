<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout}">
<head>
<meta charset="UTF-8">
<title>주문서 관리</title>
<style>
.so-link {
  color: #0d6efd;
  cursor: pointer;
  text-decoration: underline;
}
</style>
</head>
<body layout:fragment="content">
	<div class="so-manage-wrapper">
		<!-- 주문 조회 카드 -->
		<div class="row mb-3">
			<div class="col-md-12">
				<div class="card">

					<!-- 카드 헤더 : 제목 + 초기화/조회 버튼 -->
					<div class="card-header">
						<div class="card-header-left">
							<h5 class="card-title">주문서 조회</h5>
						</div>
						<div class="card-header-right">
							<button type="button" class="btn btn-dark" id="SearchInitBtn">초기화</button>
							<button type="button" class="btn btn-outline-dark" id="SearchBtn">조회</button>
						</div>
					</div>
					<!-- end card-header -->

					<div class="card-body">
						<div class="row g-2">
							<div class="col-md-3">
								<label for="custcomName" class="form-label">고객사명</label>
								<input id="custcomName" type="text" class="form-control" placeholder="고객사명을 입력해주세요">
							</div>

							<div class="col-md-6">
								<label class="form-label">납기일</label>
								<div class="d-flex align-items-center js-date-range">

									<!-- 시작일 -->
									<div class="input-group date">
										<input type="text"
											class="form-control datepicker js-date-range-start"
											placeholder="시작일"> <span
											class="input-group-text js-date-range-icon-start"> <i
											class="bi bi-calendar"></i>
										</span>
									</div>

									<span class="mx-1 fw-bold fs-5">~</span>

									<!-- 종료일 -->
									<div class="input-group date ms-2">
										<input type="text"
											class="form-control datepicker js-date-range-end"
											placeholder="종료일"> <span
											class="input-group-text js-date-range-icon-end"> <i
											class="bi bi-calendar"></i>
										</span>
									</div>

								</div>
							</div>

						</div>
					</div>
					<!-- card-body -->
				</div>
				<!-- end card -->
			</div>
		</div>
		<!-- end row -->

		<!-- 주문서목록 카드 -->
		<div class="row">

			<!-- 주문서목록 그리드 -->
			<div class="col-md-12 d-flex">
				<div class="card w-100 h-100">

					<!-- 카드 헤더 : 제목 + 잠금 해제 버튼 -->
					<div class="card-header with-actions">
						<div class="card-header-left">
							<h5 class="card-title">주문서 목록</h5>
						</div>
						<div class="card-header-right">
							<!-- <button type="button" class="btn btn-outline-dark" id="addOustBtn">출하지시서 작성</button> -->
							<div th:replace="~{fragments/buttons :: oustButton('MENU_SALES_003', 'addOustBtn')}"></div>
							<!-- <button type="button" class="btn btn-outline-dark" id="approveSoBtn">승인</button> -->
							<div th:replace="~{fragments/buttons :: approveButton('MENU_SALES_003', 'approveSoBtn')}"></div>
							<!-- <button type="button" class="btn btn-outline-dark" id="rejectSoBtn">보류</button> -->
							<div th:replace="~{fragments/buttons :: rejectButton('MENU_SALES_003', 'rejectSoBtn')}"></div>
							<!-- <button type="button" class="btn btn-danger" id="deleteSoBtn">주문취소</button> -->
							<div th:replace="~{fragments/buttons :: deleteSoButton('MENU_SALES_003', 'deleteSoBtn')}"></div>
						</div>
					</div>

					<div class="card-body">
						<div class="soGridWrap">
							<div id="soGrid"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- end 주문서목록 카드 -->
	</div>
	<!-- end so-manage-wrapper -->

<div th:replace="business/modal/addOustModal :: addOustModal"></div>
<div th:replace="business/modal/jumunseoModal :: jumunseoModal"></div>

<script>
//숫자 변환 유틸
function toNumber(val) {
  if (val === null || val === undefined) return 0;
  const str = String(val).replace(/,/g, '').trim();
  if (str === '') return 0;
  return Number(str) || 0;
}
	// 0. 데이터
	const soData = [];
	const loadedSoSet = new Set();  // 어떤 so_id 의 상세를 이미 불러왔는지 체크용
	let searchForm = {
		    custcomName: "",
		    dueStart: "",
		    dueEnd: ""
	};

	// 1-1. Grid 공통 옵션
	const soGridOptions = {
	    bodyHeight: 400,
	    scrollX: true,
	    scrollY: true,  // 세로
	    rowHeaders: ['checkbox'],     // 좌측 체크박스
	    columnOptions: {
	        minWidth: 80,
	        resizable: true
	    }
	}; // 1-1. 끝

	// 1-2. 주문서 목록 그리드 생성
	const soGrid = new tui.Grid({
		el: document.getElementById('soGrid'),
		data: soData,
		...soGridOptions,
		treeColumnOptions: {
		  name: 'productName',        // 이 컬럼에 펼침/접기 아이콘 표시
		  useIcon: true,
		  indentWidth: 20 // 들여쓰기 간격인데 확인하고 수정
		},
		columns: [
			{ header: '주문서코드', name: 'soId', align: 'center',
				formatter: ({ value }) => {
				    if (!value) return '';
				    return `
				      <a href="javascript:void(0)" 
				         class="so-link" 
				         data-so-id="${value}">
				         ${value}
				      </a>
				    `;
				  }
			},
			{ header: '고객사명', name: 'custcomName' },
			{ header: '담당자', name: 'psch', width: 100, align: 'center' },
			{ header: '연락처', name: 'pschTel', align: 'center'  },
			{ header: '주문일', name: 'soDt', align: 'center' },
			{ header: '납기일', name: 'dueDt', align: 'center' },
			{ header: '상품명', name: 'productName', width: 250 },
			{ header: '금액합계(원)', name: 'ttSupplyAmt', align: 'right',
				formatter: ({ value }) => {
	                   const num = toNumber(value);
	                   return num ? num.toLocaleString() : '';
	               }
			},
			{ header: '총 주문수량(EA)', name: 'ttSoQy', width: 120, align: 'right',
				formatter: ({ value }) => {
	                   const num = toNumber(value);
	                   return num ? num.toLocaleString() : '';
	               } 
			},
			{ header: '현 재고수량(EA)', name: 'currStockQy', width: 120, align: 'right',
	   				formatter: ({ value }) => {
		                   const num = toNumber(value);
		                   return num ? num.toLocaleString() : '';
		               } 
	   		},
	   		{
	   		  header: '진행상태',
	   		  name: 'codeNm',
	   		  align: 'center',
	   		  formatter: ({ row }) => {
	   		    if (!row.codeNm) return '';

	   		    // 상태별 색상
	   		    let color = '';
	   		    if (row.codeId === 'es6') {
	   		      color = 'blue';
	   		    } else if (row.codeId === 'es2') {
	   		      color = 'green';
	   		    }

	   		    const codeNmHtml = color
	   		      ? `<span style="color:${color}">${row.codeNm}</span>`
	   		      : row.codeNm;

	   		    if (row.stResn) {
	   		      return `
	   		        ${codeNmHtml}<br>
	   		        <span style="color:red">${row.stResn}</span>
	   		      `;
	   		    }

	   		    return codeNmHtml;
	   		  }
	   		},
			/* { 
			  header: '진행상태',
			  name: 'codeNm',
			  align: 'center',
			  formatter: ({ row }) => {
			      if (!row.codeNm) return '';
			      if (row.stResn) {
			          return `${row.codeNm}<br><span style="color:red">${row.stResn}</span>`;
			      }
			      return row.codeNm;
			  }
			}, */
			{ name: 'header', hidden: true },
			{ name: 'stResn', hidden: true },
			{ name: 'progrsSt', hidden: true },
			{ name: 'soDetailNo', hidden: true },
			{ name: 'rm', hidden: true },
			{ name: 'shipAddr', hidden: true }
		]	
	}); // 1-2. 주문서목록 그리드 생성 끝
	
	// 주문서 번호 PdfController로 넘기기
	document.getElementById('soGrid').addEventListener('click', function (e) {
	  const target = e.target;
	
	  if (target.classList.contains('so-link')) {
	    const soId = target.dataset.soId;
	
	    const iframe = document.getElementById('jumunseoFrame');
	    iframe.src = `/jumunseo?soId=${soId}`;
	
	    const modalEl = document.getElementById('jumunseoModal');
	    const modal = new bootstrap.Modal(modalEl);
	
	    modal.show();
	  }
	});
	
	// 모달 iframe 초기화
	document.getElementById('jumunseoModal')
	  .addEventListener('hidden.bs.modal', function () {
	    document.getElementById('jumunseoFrame').src = '';
	  });
	/* document.getElementById('soGrid').addEventListener('click', function (e) {
	  const target = e.target;
	
	  if (target.classList.contains('so-link')) {
	    const soId = target.dataset.soId;
	
	    // 새 창으로 PDF 열기
	    window.open(`/jumunseo?soId=${soId}`, '_blank');
	  }
	}); */
	
	
	// ===================================  1-3. 출하지시서등록 모달
    // 1-1 출하지시서 모달
	const openBtn = document.getElementById("addOustBtn");
	const modal   = document.getElementById("addOustModal");
	const back    = document.getElementById("addOustBackdrop");
	
	function openAddOustModal() {
		modal.classList.add("show");
		modal.style.display = "block";
		back.style.display = "block";
		
	} // openAddOustModal
	
	function closeAddOustModal() {
		modal.classList.remove("show");
		modal.style.display = "none";
		back.style.display = "none";
		
		// 모달 닫을 때 입력값 초기화
		resetAddOustForm();
	} // closeAddOustModal
	
	function resetAddOustForm() {

		// 모달 입력창 초기화
		$('#applyDate').val('');
		
	} // resetNewEstiForm
	
	// 바깥 클릭 시 닫기
	modal.addEventListener("click", (event) => {
		if (!event.target.closest(".modal-content")) {
			closeAddOustModal();
		}
	}); // end 출하지시서작성 모달
	
	
	// 1-2. 출하지시서 작성 버튼 클릭 이벤트
	document.getElementById('addOustBtn').addEventListener('click', () => {
	
	    const checked = soGrid.getCheckedRowKeys();
	    if (checked.length === 0) {
	        alert("출하지시서를 작성할 주문서를 선택해주세요.");
	        return;
	    }
	
	    const parentKeys = checked.filter(key => {
	        const row = soGrid.getRow(key);
	        return row._children && row._children.length > 0; // 부모만
	    });
	
	    if (parentKeys.length !== 1) {
	        alert("출하지시서는 한 건씩만 작성할 수 있습니다.");
	        return;
	    }
	
	    const row = soGrid.getRow(parentKeys[0]);
	
	    // 승인된 (es2) 상태만 가능
	    if (row.progrsSt !== 'es2') {
	        alert("승인 완료된 주문서가 아닙니다.");
	        return;
	    }
	    
	    if (row.progrsSt === 'es5') {
		    alert("보류된 주문서입니다.");
		    return;
		  }
	    
	    if (row.progrsSt === 'es6') {
		    alert("이미 출하지시서가 작성된 주문서입니다.");
		    return;
		  }
	    
	    if (row.progrsSt === 'es9') {
		    alert("취소된 주문서입니다.");
		    return;
		  }
	
	    // --- 모달 데이터 세팅 ---
	    document.getElementById("viewSoId").value = row.soId;
	    document.getElementById("viewCustcom").value = row.custcomName;
	    document.getElementById("viewDueDt").value = row.dueDt;
	
	    // 출하예정일 = 납기일 - 3일
	    const dueDate = new Date(row.dueDt);
	    dueDate.setDate(dueDate.getDate() - 3);
	    document.getElementById("viewPlanDt").value = dueDate.toISOString().slice(0, 10);
	
	    // 출하요청일 초기값
	    document.getElementById("applyDate").value = "";
	
	    document.getElementById("viewAddr").value = row.shipAddr || "";
	    document.getElementById("viewRm").value = row.rm || "";
	
	    // 모달 열기
	    document.getElementById("addOustModal").style.display = "block";
	    document.getElementById("addOustBackdrop").style.display = "block";
	});
	
	
	
	// 1-3. 출하지시서 작성 초기화 버튼 이벤트
	document.getElementById("addOustInit").addEventListener("click", () => {
		document.querySelector(".oust-request-datepicker").value = "";
	});
	
	
	// 1-4. 출하시지서 작성 저장 버튼 이벤트
	document.getElementById("addOustSaveBtn").addEventListener("click", async () => {
	
	    const soId = document.getElementById("viewSoId").value;
	    const dueDt = document.getElementById("viewDueDt").value;
	    const planDt = document.getElementById("viewPlanDt").value;
	    const requestDt = document.getElementById("applyDate").value;
	    const addr = document.getElementById("viewAddr").value;
	    const rm = document.getElementById("viewRm").value;
	
	    // --- 필수값 체크 ---
	    if (!requestDt) {
	        alert("출하요청일을 입력해주세요.");
	        return;
	    }
	
	    if (!addr.trim()) {
	        alert("배송지 주소를 입력해주세요.");
	        return;
	    }
	
	    const payload = {
	        soId,
	        oustPlanDt: planDt,
	        oustRequestDt: requestDt,
	        shipAddr: addr,
	        rm
	    };
	
	    if (!confirm("출하지시서를 저장하시겠습니까?")) return;
	
	    try {
	        const res = await axios.post("/so/oust/save", payload);
	
	        if (res.data.success) {
	            alert("출하지시서가 저장되었습니다.");
	
	            // 모달 닫기
	            document.getElementById("addOustModal").style.display = "none";
	            document.getElementById("addOustBackdrop").style.display = "none";
	
	            // 목록 재조회
	            document.getElementById("SearchBtn").click();
	        } else {
	            alert(res.data.message || "저장에 실패했습니다.");
	        }
	    } catch (e) {
	        console.error(e);
	        alert("저장 중 오류가 발생했습니다.");
	    }
	});


	
	
	
	// ======================================================================== 2. 버튼 이벤트
	// 2-1. 초기화 버튼 이벤트
	document.getElementById("SearchInitBtn").addEventListener("click", function () {
	
	    // 1) searchForm 객체 초기화
	    searchForm = {
	        custcomName: "",
	        dueStart: "",
	        dueEnd: ""
	    };
	
	    // 2) 화면 Input 값 초기화
	    document.querySelector("#custcomName").value = "";
	    document.querySelector(".js-date-range-start").value = "";
	    document.querySelector(".js-date-range-end").value = "";
	
	    // datepicker 를 쓰는 경우 UI 리프레시
	    $('.js-date-range-start').datepicker('update', '');
	    $('.js-date-range-end').datepicker('update', '');
	
	    console.log("검색조건 초기화:", searchForm);
	});
	
	// 2-2. 조회 버튼 이벤트
	document.getElementById("SearchBtn").addEventListener("click", function () {
	
	    // 1) 화면 입력값 → searchForm 에 세팅
	    searchForm.custcomName = document.querySelector("#custcomName").value.trim();
	    searchForm.dueStart = document.querySelector(".js-date-range-start").value;
	    searchForm.dueEnd = document.querySelector(".js-date-range-end").value;
	
	    console.log("보낼 searchForm >>> ", searchForm);
	
	    // 2) 백엔드 조회 요청 (POST /esti/list)
	    axios.post("/so/list", searchForm)
	    .then(res => {
	    	console.log("서버에서 받은 원본 데이터 >>> ", res.data);
	        const treeData = res.data.map(header => ({
	            ...header,
	            _children: header.detailList
	        }));
	        console.log("트리 구조로 만든 데이터 >>> ", treeData);
	        soGrid.resetData(treeData);
	        console.log("첫 번째 행 row 데이터 >>> ", soGrid.getRow(0));
	    });
	});
	
	
	
	// 2-3. 승인버튼 이벤트
	document.getElementById("approveSoBtn").addEventListener("click", () => {
	
	    // 1) 사용자 체크한 전체 row
	    const checkedRows = soGrid.getCheckedRows();
	
	    if (checkedRows.length === 0) {
	        alert("승인할 주문서를 선택해주세요.");
	        return;
	    }
	
	    // 2) 부모(row.header == 'h')만 필터링
	    const parentRows = checkedRows.filter(r => r.header === 'h');
	
	    if (parentRows.length === 0) {
	        alert("승인은 주문서 기준으로만 가능합니다. 주문서를 선택한 후 다시 시도해주세요.");
	        return;
	    }
	
	    // 3) 각 부모별 자식 재고 검사 수행
	    for (const parent of parentRows) {
	
	        // 해당 부모의 모든 자식 가져오기
	        const childRows = soGrid.getChildRows(parent.rowKey);
	
	        for (const child of childRows) {
	
	            // 재고 < 주문수량 → 승인 불가
	            if (child.currStockQy < child.ttSoQy) {
	                alert(
	                    `주문서 ${parent.soId} 승인 불가\n` +
	                    `상품명: ${child.productName}\n` +
	                    `재고(${child.currStockQy}) < 주문수량(${child.ttSoQy})`
	                );
	                return; // 승인 중단
	            }
	        }
	    }
	
	    // 4) 서버에 승인 요청 (부모만 보냄)
	    const payload = parentRows.map(p => ({
	        soId: p.soId
	    }));
	
	    fetch("/so/approve", {
	        method: "POST",
	        headers: {"Content-Type": "application/json"},
	        body: JSON.stringify(payload)
	    })
	    .then(r => r.json())
	    .then(res => {
	        if (res.success) {
	            alert("승인 완료되었습니다.");
	            document.getElementById("SearchBtn").click();
	        } else {
	            alert(res.message || "승인 실패");
	        }
	    });
	}); // 승인버튼 end
	
	
	// 2-4. 보류버튼 이벤트
	// 보류 버튼 클릭 (단건만 가능)
	document.getElementById('rejectSoBtn').addEventListener('click', async () => {

	  const checkedKeys = soGrid.getCheckedRowKeys();
	
	  // 부모행만 선택
	  const parentKeys = checkedKeys.filter(key => {
	    const row = soGrid.getRow(key);
	    return row._children && row._children.length > 0;
	  });
	
	  if (parentKeys.length === 0) {
	    alert("보류 할 주문서를 선택하세요.");
	    return;
	  }
	
	  if (parentKeys.length > 1) {
	    alert("보류는 한 건씩만 처리할 수 있습니다.\n하나만 선택해주세요.");
	    return;
	  }
	  
	
	  const row = soGrid.getRow(parentKeys[0]);
	  const soId = row.soId;
	  
	  if (row.progrsSt === 'es2') {
	    alert("이미 승인된 주문서입니다.");
	    return;
	  }
	  
	  if (row.progrsSt === 'es5') {
	    alert("이미 보류된 주문서입니다.");
	    return;
	  }
	  
	  if (row.progrsSt === 'es6') {
	    alert("출하지시서가 작성된 주문서입니다.");
	    return;
	  }
	  
	  if (row.progrsSt === 'es9') {
	    alert("이미 취소된 주문서입니다.");
	    return;
	  }
	  
	  const reason = prompt(`[${soId}] 보류 사유를 입력하세요:`);
	  
	  if (reason === null) return;
	  if (reason.trim() === "") {
	    alert("보류 사유는 필수입니다.");
	    return;
	  }
	
	  if (!confirm(`${soId} 주문서를 보류 처리하시겠습니까?`)) {
	    return;
	  }
	
	  try {
	    const res = await axios.post("/so/reject", { soId, reason });
	    alert(res.data.message || "보류 처리되었습니다.");
	    document.getElementById("SearchBtn").click();
	  } catch (err) {
	    console.error(err);
	    alert("보류 처리 중 오류가 발생했습니다.");
	  }
	});
	
	
	
	// 2-5. 주문취소버튼 이벤트
	document.getElementById('deleteSoBtn').addEventListener('click', async () => {

	  const checkedKeys = soGrid.getCheckedRowKeys();
	
	  // 부모행만 선택
	  const parentKeys = checkedKeys.filter(key => {
	    const row = soGrid.getRow(key);
	    return row._children && row._children.length > 0;
	  });
	
	  if (parentKeys.length === 0) {
	    alert("취소 할 주문서를 선택하세요.");
	    return;
	  }
	
	  if (parentKeys.length > 1) {
	    alert("취소는 한 건씩만 처리할 수 있습니다.\n하나만 선택해주세요.");
	    return;
	  }
	
	  const row = soGrid.getRow(parentKeys[0]);
	  const soId = row.soId;
	  
	  
	  if (row.progrsSt === 'es6') {
	    alert("출하지시서가 작성된 주문서입니다.");
	    return;
	  }
	  
	  if (row.progrsSt === 'es9') {
	    alert("이미 취소된 주문서입니다.");
	    return;
	  }
	  
	  const reason = prompt(`[${soId}] 취소 사유를 입력하세요:`);
	  if (reason === null) return;
	  if (reason.trim() === "") {
	    alert("취소 사유는 필수입니다.");
	    return;
	  }
	
	  if (!confirm(`${soId} 주문서를 취소 처리하시겠습니까?`)) {
	    return;
	  }
	
	  try {
	    const res = await axios.post("/so/cancel", { soId, reason });
	    alert(res.data.message || "취소 처리되었습니다.");
	    document.getElementById("SearchBtn").click();
	  } catch (err) {
	    console.error(err);
	    alert("취소 처리 중 오류가 발생했습니다.");
	  }
	});
	
	// 2-6. 출하지시서작성 모달 저장버튼 이벤트
	
	
</script>

</body>
</html>