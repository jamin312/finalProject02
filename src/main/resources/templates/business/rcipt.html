<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout}">
<head>
<meta charset="UTF-8">
<link rel="stylesheet"
	href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>

<title>채권관리</title>
<style>
.form-select {
	color: #000 !important;
}
</style>
</head>
<body layout:fragment="content">
	<div class="row">
	
		<!-- 채권관리 조회 -->
		<div class="col-md-12">
			<div class="card mb-3 searchdiv">
				<div class="card-header">
					<h5 class="card-title">채권 조회</h5>
					<div class="card-header-right">
						<button type="button" class="btn btn-dark" id="searchInitBtn">초기화</button>
						<button class="btn btn-outline-dark" id="searchBtn">조회</button>
					</div>
				</div>
				
				<!-- /card-body start -->
				<div class="card-body">
					<div class="row">
						<div class="col-md-3">
							<label for="custcomId" class="form-label">고객사코드</label>
							<input id="custcomId" type="text" class="form-control">
						</div>
						<div class="col-md-3">
							<label for="custcomName" class="form-label">고객사명</label>
							<input id="custcomName" type="text" class="form-control">
						</div>
<!-- 						<div class="col-md-2">
							<label class="form-label">결제방법</label>
							<select id="pmtMtd" class="form-control">
								<option value="">전체</option>
								<option>현금</option>
								<option>카드</option>
								<option>계좌이체</option>
								<option>어음</option>
							</select>
						</div> -->
						<div class="col-md-4">
							<label class="form-label">채권발생일</label>
								<div class="d-flex align-items-center js-date-range">

									<!-- 시작일 -->
									<div class="input-group date">
										<input type="text" class="form-control datepicker js-date-range-start" placeholder="시작일"> 
										<span class="input-group-text js-date-range-icon-start"> 
										<i class="bi bi-calendar"></i>
										</span>
									</div>

									<span class="mx-1 fw-bold fs-5">~</span>

									<!-- 종료일 -->
									<div class="input-group date ms-2">
										<input type="text" class="form-control datepicker js-date-range-end" placeholder="종료일"> 
										<span class="input-group-text js-date-range-icon-end"> 
										<i class="bi bi-calendar"></i>
										</span>
									</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			
			<div class="card w-100 h-80">
				<div class="card-header">
					<h5 class="card-title">채권 목록</h5>
					<div class="card-header-right">
						<div style="margin-top: 1em; font-size: 12px;">
							<span class="badge bg-secondary"> ※ 정렬 기준 : 최근입금일, 채권발생일</span>
						</div>
						<button class="btn btn-outline-dark" id="rciptListBtn">입금내역</button>
						<div th:replace="~{fragments/buttons :: rciptButton('MENU_SALES_007', 'openRciptTretModal')}"></div>
					</div>
				</div>
				<div class="card-body">
					<div id="grid"></div>
				</div>
			</div>
		</div>
	</div>

<div th:replace="business/modal/rciptTretModal :: rciptTretModal"></div>
<div th:replace="business/modal/rciptListModal :: rciptListModal"></div>
	
<script>
		function toNumber(val) {
		    if (val === null || val === undefined) return 0;
		    const str = String(val).replace(/,/g, '').trim();
		    if (str === '') return 0;
		    return Number(str) || 0;
		}
		
		// 모달 금액입력 천단위 자동 콤마
		$('#rciptAmt').on('input', function () {
		    let val = $(this).val().replace(/[^0-9]/g, '');
		    $(this).val(val.replace(/\B(?=(\d{3})+(?!\d))/g, ','));
		});


		let searchForm = {
				custcomId: "",
			    custcomName: "",
			    //pmtMtd: "",
			    startDt: "",
			    endDt: ""
		};
	
	    const gridData = [];
    
    
        // Grid 생성
        const grid = new tui.Grid({
            el: document.getElementById('grid'),
            bodyHeight: 400,
            data: gridData,
            columnOptions: {
            	minWidth: 80,
            	resizable: true
            },
            scrollX: true,
            scrollY: true,
            autoWidth: true,
            columns: [
            	{header: '채권ID', name: 'rciptId', width: 130, align: 'center'},
                {header: '고객ID', name: 'custcomId', width: 130, align: 'center'},
                {header: '고객사명', name: 'custcomName', width: 300, align: 'left'},
                {header: '채권발생일', name: 'trnsDt', width: 160, align: 'center'},
                {
                    header: '채권금액(원)',
                    name: 'bondAmt',
                    width: 180,
                    align: 'right',
                    formatter: ({value}) => {
                        const num = toNumber(value);
                        return num ? num.toLocaleString() : '';
                    }
                },
                {header: '입금액(원)', name: 'rciptAmt', width: 180, align: 'right',
                    formatter: ({value}) => {
                        const num = toNumber(value);
                        return num ? num.toLocaleString() : '';
                    }
                },
/*                 {
                    header: '누적입금액(원)',
                    name: 'rciptAmtSum',
                    width: 180,
                    align: 'right',
                    formatter: ({value}) => {
                        const num = toNumber(value);
                        return num ? num.toLocaleString() : '';
                    }
                }, */
                {
                    header: '채권잔액(원)',
                    name: 'bondBaln',
                    width: 180,
                    align: 'right',
                    formatter: ({value}) => {
                        const num = toNumber(value);
                        return num ? num.toLocaleString() : '';
                    }
                },
                {header: '최근입금일', name: 'ltstRciptDt', width: 160, align: 'center'},
                {header: '상환여부', name: 'rpayYn', width: 130, align: 'center'},
                //{header: '연체구분', name: 'delayFg', width: 100, align: 'center'},
                //{header: '비고', name: 'rm', width: 150, align: 'center'},
            ]
        });
        
	// =============== 버튼 이벤트
	// 2-1. 초기화 버튼 이벤트
	document.getElementById("searchInitBtn").addEventListener("click", function () {
	
	    // 1) searchForm 객체 초기화
	    searchForm = {
			custcomId: "",
		    custcomName: "",
		    //pmtMtd: "",
		    startDt: "",
		    endDt: ""
	    };
	    const searchdiv = document.querySelector(".searchdiv")
	
	    // 2) 화면 Input 값 초기화
	    searchdiv.querySelector("#custcomId").value = "";
	    searchdiv.querySelector("#custcomName").value = "";
	    //searchdiv.querySelector("#pmtMtd").value = "";
	    searchdiv.querySelector(".js-date-range-start").value = "";
	    searchdiv.querySelector(".js-date-range-end").value = "";
	
	    // datepicker 를 쓰는 경우 UI 리프레시
	    $('.js-date-range-start').datepicker('update', '');
	    $('.js-date-range-end').datepicker('update', '');
	
	    console.log("검색조건 초기화:", searchForm);
	});

	// 조회 함수
	function seacrchRcipt(){
		// 1) 화면 입력값 → searchForm 에 세팅
	    searchForm.custcomId = document.querySelector("#custcomId").value.trim();
	    searchForm.custcomName = document.querySelector("#custcomName").value.trim();
	    //searchForm.pmtMtd = document.querySelector("#pmtMtd").value.trim(); 
	    searchForm.startDt = document.querySelector(".js-date-range-start").value;
	    searchForm.endDt = document.querySelector(".js-date-range-end").value;
	
	    console.log("보낼 searchForm >>> ", searchForm);
	
	    // 2) 백엔드 조회 요청 (POST /esti/list)
	    axios.post("/rcipt/list", searchForm)
	        .then(res => {
	            console.log("조회결과 >>> ", res.data);
	
	            // 3) 그리드 데이터 반영
	            grid.resetData(res.data);
	        })
	        .catch(err => console.error("조회 중 오류:", err));
	}
	
	// 2-2. 조회 버튼 이벤트
	document.getElementById("searchBtn").addEventListener("click", function () {

		seacrchRcipt();
	});
        
        
    	// 입금처리 모달창
        const openRciptTretBtn = document.getElementById("openRciptTretModal");
        const modal = document.getElementById("rciptTretModal");
        const rciptTretBackdrop = document.getElementById("rciptTretBackdrop");

        
        
        // 입금처리 열기
        openRciptTretBtn.addEventListener("click", () => {
	        //그리드에 선택된 고객사 정보
	        const rowKey = grid.getFocusedCell().rowKey;
	        if (rowKey == null || rowKey < 0){
	        	alert("고객사가 선택되지 않았습니다.")
	        	return ;
	        }
	        
	        const custcomId = grid.getValue(rowKey,'custcomId');
	        const custcomName =  grid.getValue(rowKey,'custcomName');
	        const rciptId = grid.getValue(rowKey, 'rciptId');
	            
	        
	        //document.getElementById('custcomIdHidden').value = custcomId;
	        //document.getElementById('mCustcomName').value = custcomName;
	        $('#custcomIdHidden').val(custcomId);
	        $('#mCustcomName').val(custcomName);
	        $('#rciptIdHidden').val(rciptId);
	        
	        
	        rciptTretModal.classList.add("show");
	        rciptTretModal.style.display = "block";
	        rciptTretBackdrop.style.display = "block";
	        document.body.classList.add("modal-open");
	       
        });
        
    	// 바깥 클릭 시 닫기
    	function closeRciptTretModal() {
    		resetRciptTretModal();
    		
    		modal.classList.remove("show");
    		modal.style.display = "none";
    		rciptTretBackdrop.style.display = "none";
    	}
    	
    	modal.addEventListener("click", (event) => {
    		if (!event.target.closest(".modal-content")) {
    			closeRciptTretModal();
    		}
    	});
    	
    	
    	// 모달 초기화 함수
    	function resetRciptTretModal() {

    	    // hidden 값 초기화
    	    $('#custcomIdHidden').val('');
    	    $('#rciptIdHidden').val('');

    	    // 표시용 input 초기화
    	    $('#mCustcomName').val('');

    	    // 입력 필드 초기화
    	    $('#rciptDt').val('');
    	    $('#rciptAmt').val('');
    	    $('#pmtMtd').val('');
    	    $('#rm').val('');
    	}
    	

    	
// ==============================================  입금처리 저장버튼 이벤트
    	$(document).ready(function () { // 이 줄은 html 로딩이 끝난 뒤 실행됨

	    $('#modalSaveBtn').on('click', function () {
	
	        // 모달 입력 값 가져오기
	        const custcomId = $('#custcomIdHidden').val();
	        const rciptDt   = $('#rciptDt').val();
	        const rciptAmt  = $('#rciptAmt').val().replace(/,/g, '');
	        const pmtMtd    = $('#pmtMtd').val();
	        const rm        = $('#rm').val();
	
	        // 기본 검증 (UX)
	        if (!custcomId) {
	            alert('고객사를 선택해주세요.');
	            return;
	        }
	
	        if (!rciptDt) {
	            alert('입금일자를 선택해주세요.');
	            return;
	        }
	
	        if (!rciptAmt || Number(rciptAmt) <= 0) {
	            alert('입금금액을 입력해주세요.');
	            return;
	        }
	
	        if (!pmtMtd) {
	            alert('결제방법을 선택해주세요.');
	            return;
	        }
	
	        // payload 구성
	        const payload = {
			    rciptId: $('#rciptIdHidden').val(),
			    custcomId: $('#custcomIdHidden').val(),
			    rciptDt: $('#rciptDt').val(),
			    rciptAmt: $('#rciptAmt').val().replace(/,/g, ''),
			    pmtMtd: $('#pmtMtd option:selected').val(),
			    rm: $('#rm').val()
			};
	
	        // 중복 클릭 방지
	        $('#modalSaveBtn').prop('disabled', true);
	
	        // 서버 호출
	        $.ajax({
	            url: '/rcipt/save',
	            type: 'POST',
	            contentType: 'application/json; charset=UTF-8',
	            dataType: 'json',
	            data: JSON.stringify(payload),
	            success: function (res) {
	
	                if (res.success) {
	                    alert(res.message || '입금 처리가 완료되었습니다.');
	
	                    // 모달 닫기
	                    closeRciptTretModal();
	
	                    // 필요 시 목록 재조회
	                    seacrchRcipt();
	
	                } else {
	                    alert(res.message || '입금 처리에 실패했습니다.');
	                }
	            },
	            error: function (xhr, status, error) {
	                console.error(error);
	                alert('서버 오류가 발생했습니다.');
	            },
	            complete: function () {
	                // 버튼 다시 활성화
	                $('#modalSaveBtn').prop('disabled', false);
	            }
	        });
	    });
	
	}); // 입금처리 저장 end
        
// ======================================================입금 상세내역
// 입금내역 버튼 클릭 (행 선택 기준)
$(document).on("click", "#rciptListBtn", function () {

  const focused = grid.getFocusedCell();

  // 행 선택 여부 체크
  if (!focused || focused.rowKey == null || focused.rowKey < 0) {
    alert('입금내역을 조회할 채권을 선택하세요.');
    return;
  }

  const rowKey = focused.rowKey;

  const rowData = grid.getRow(rowKey);

  if (!rowData || !rowData.rciptId) {
    alert('채권 ID가 없습니다.');
    return;
  }

  openRciptListModal(rowData);
});


	// 입금내역 모달 DOM
	const rciptListModal    = document.getElementById("rciptListModal");
	const rciptListBackdrop = document.getElementById("rciptListBackdrop");
	
	
	// 입금내역 모달 오픈
	function openRciptListModal(rowData) {
	
	  // 상단 텍스트 세팅
	  document.getElementById('rciptIdText').innerText = rowData.rciptId;
	  document.getElementById('mCustcomNameText').innerText = rowData.custcomName || '';
	
	  // 모달 오픈
	  rciptListModal.classList.add("show");
	  rciptListModal.style.display = "block";
	  rciptListBackdrop.style.display = "block";
	  document.body.classList.add("modal-open");
	
	  // 기존 데이터 초기화
	  if (window.rciptListGrid) {
	    window.rciptListGrid.resetData([]);
	  }
	
	  // 입금내역 조회
	  fetch(`/rcipt/detail/list?rciptId=${rowData.rciptId}`)
	    .then(res => res.json())
	    .then(data => {
	      window.rciptListGrid.resetData(data || []);
	      window.rciptListGrid.refreshLayout();
	    })
	    .catch(err => {
	      console.error(err);
	      alert('입금 내역 조회 중 오류가 발생했습니다.');
	    });
	}
	
	
	// 입금내역 모달 닫기
	function closeRciptListModal() {
	  rciptListModal.classList.remove("show");
	  rciptListModal.style.display = "none";
	  rciptListBackdrop.style.display = "none";
	  document.body.classList.remove("modal-open");
	}
	
	
	// 바깥 클릭 시 모달 닫기
	rciptListModal.addEventListener("click", (event) => {
	  if (!event.target.closest(".modal-content")) {
	    closeRciptListModal();
	  }
	});
	
	rciptListBackdrop.addEventListener("click", () => {
	  closeRciptListModal();
	});
	
	
	
	// 입금 상세내역 모달 그리드
	window.rciptListGrid = new tui.Grid({
	    el: document.getElementById('rciptListGrid'),
	    data: [],
	    scrollX: false,
	    scrollY: true,
	    bodyHeight: 300,
	    columnOptions: { resizable: true },
	    columns: [
	        { header: '입금일자', name: 'rciptDt', align: 'center', width: 120,
	        	formatter: ({ value }) => {
					if (!value) return '';
					const d = new Date(value);
					return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        		}
	        },
	        {
	            header: '입금금액',
	            name: 'rciptAmt',
	            align: 'right',
	            width: 150,
	            formatter: ({ value }) => value ? Number(value).toLocaleString() : ''
	        },
	        { header: '결제방법', name: 'pmtMtd', align: 'center', width: 120 },
	        { header: '비고', name: 'rm', align: 'left' }
	    ]
	}); 
	
	
    </script>
</body>
</html>
