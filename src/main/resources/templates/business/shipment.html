<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout}">
<head>
<meta charset="UTF-8">
<!-- <link rel="stylesheet"
	href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script> -->

<title>출하관리</title>
<style>
.form-select {
	color: #000 !important;
}
</style>
</head>
<body layout:fragment="content">
	<div class="row">
		<!-- 검색조건 -->
		<div class="col-md-12">
			<div class="card mb-3">
				<div class="card-header">
					<h5 class="card-title">출하지시 조회</h5>
					<div class="card-header-right">
					    <button type="button" class="btn btn-dark" id="btnReset">초기화</button>
						<button class="btn btn-outline-dark" id="searchBtn">조회</button>
					</div>
				</div>
				<div class="card-body">
					<div class="row">
						<div class="col-md-2">
							<label for="custcomId" class="form-label">고객사 코드</label> 
							<input id="custcomId" type="text" class="form-control"  placeholder="고객사코드를 입력해주세요" >
						
						</div>
						<div class="col-md-3">
							<label for="custcomName" class="form-label">고객사명</label>
							<input id="custcomName" type="text" class="form-control" placeholder="고객사명을 입력해주세요" >
						</div>
						<div class="col-md-4">
								<label class="form-label">출하요청일</label>
								<div class="d-flex align-items-center js-date-range">

									<!-- 시작일 -->
									<div class="input-group date">
										<input type="text" class="form-control datepicker js-date-range-start" placeholder="시작일">
										<span class="input-group-text js-date-range-icon-start">
										<i class="bi bi-calendar"></i>
										</span>
									</div>

									<span class="mx-1 fw-bold fs-5">~</span>

									<!-- 종료일 -->
									<div class="input-group date ms-2">
										<input type="text" class="form-control datepicker js-date-range-end" placeholder="종료일">
										<span class="input-group-text js-date-range-icon-end">
										<i class="bi bi-calendar"></i>
										</span>
									</div>

								</div>
							</div>
					</div>
				</div>
			</div>

			<!-- 사원목록 -->
			<div class="card">
				<div class="card-header">
					<h5 class="card-title">출하목록</h5>
					<div class="card-header-right">

						<!-- <button id="addRowBtn" class="btn btn-outline-dark">행추가</button> -->
						<!-- <div th:replace="~{fragments/buttons :: addRowButton('MENU_SALES_009', 'addRowBtn')}"></div> -->
						<!-- <button type="button" class="btn btn-dark">반려</button> -->
						<!-- <button class="btn btn-outline-dark" id="openRciptTretModal">출하처리</button> -->
						<div th:replace="~{fragments/buttons :: tretButton('MENU_SALES_009', 'openRciptTretModal')}"></div>
						<!-- 출하취소의 id 값 : deleteShipmntBtn -->
						<div th:replace="~{fragments/buttons :: deleteShipmntButton('MENU_SALES_009', 'deleteShipmntBtn')}"></div>
					</div>
				</div>
				<div class="card-body">
					<div id="oustGrid"></div>
				</div>
			</div>
		</div>
	</div>
	<!--<div th:replace="business/modal/rciptTretModal :: rciptTretModal"></div>
	<div th:replace="business/modal/delayModal :: delayModal"></div>
	-->
	
	
<script>

//숫자 변환 유틸 (기존 그대로 사용)
function toNumber(val) {
  if (val === null || val === undefined) return 0;
  const str = String(val).replace(/,/g, '').trim();
  if (str === '') return 0;
  return Number(str) || 0;
}

// 전역
const searchForm = {
    custcomId: "",
    custcomName: "",
    nm: "",
    dueStart: "",
    dueEnd: ""
};

// 그리드 데이터
    const oustData = [];
    	
    	
// Grid 생성
        const oustGrid = new tui.Grid({
            el: document.getElementById('oustGrid'),
            data: oustData,
            rowHeaders: ['checkbox'],
            scrollX: true,
            scrollY: true,
            bodyHeight: 400,
            autoWidth: true,
            columns: [
            	  { header: '출하지시ID', name: 'oustId', width: 130, align: 'center' },
            	  { header: '고객사', name: 'custcomName', align: 'left' },
            	  { header: '담당자', name: 'psch', width: 120, align: 'center'  },
            	  { header: '담당자연락처', name: 'pschTel', width: 130, align: 'center'  },
            	  { header: '출하완료일', name: 'shipmntDt', width: 130, align: 'center' },
            	  { header: '출하요청일', name: 'oustRequestDt', width: 130, align: 'center' },
            	  { header: '상품명', name: 'productName' },
            	  { header: '금액합계(원)', name: 'ttPrice', width: 150, align: 'right',
      				formatter: ({ value }) => {
                        const num = toNumber(value);
                        return num ? num.toLocaleString() : '';
                    }
      			  },
            	  //{ header: '작업자', name: 'empId' },
             	  //{ header: '주문수량(EA)', name: 'ttSoQy' }, 
            	  { 
             		  header: '출하상태', 
             		  name: 'shipmntSt', 
             		  width: 120, 
             		  align: 'center',
             		  formatter: ({ value }) => {
             		    if (value === '출하취소') {
             		      return `<span style="color:red;font-weight:bold;">출하취소</span>`;
             		    }
             		    if (value === '출하완료') {
             		      return `<span style="color:green;">출하완료</span>`;
             		    }
             		    return value || '';
             		  }
/* 	       			  formatter: ({ row }) => {
	     			      if (!row.codeNm) return '';
	     			      if (row.stResn) {
	     			          return `${row.codeNm}<br><span style="color:red">${row.stResn}</span>`;
	     			      }
	     			      return row.codeNm;
	       			 	} */
             		  }, 
            	]
        });


// =================================== 버튼 이벤트
	// 1. 초기화버튼 이벤트
	document.getElementById("btnReset").addEventListener("click", function () {
	
	    // 화면 Input 값 초기화
	    document.querySelector("#custcomId").value = "";
	    document.querySelector("#custcomName").value = "";
	    document.querySelector("#nm").value = "";
	    document.querySelector(".js-date-range-start").value = "";
	    document.querySelector(".js-date-range-end").value = "";
	
	    // datepicker 를 쓰는 경우 UI 리프레시
	    $('.js-date-range-start').datepicker('update', '');
	    $('.js-date-range-end').datepicker('update', '');
	
    console.log("검색조건 초기화:", searchForm);
	});

	// 2-1. 출하목록조회함수
	function searchShipmentList() {

	    searchForm.custcomId   = document.querySelector("#custcomId").value.trim();
	    searchForm.custcomName = document.querySelector("#custcomName").value.trim();
	    //searchForm.nm          = document.querySelector("#nm").value.trim();
	    searchForm.dueStart    = document.querySelector(".js-date-range-start").value;
	    searchForm.dueEnd      = document.querySelector(".js-date-range-end").value;

	    axios.post("/shipment/list", searchForm)
	        .then(res => {
	            console.log("조회결과 >>> ", res.data);
	            oustGrid.resetData(res.data);
	        })
	        .catch(err => console.error("조회 중 오류:", err));
	}

	// 2-2. 조회 버튼 이벤트
	document.getElementById("searchBtn").addEventListener("click", function () {
		
		searchShipmentList();
	
	});


//================================================================== <출하처리 버튼 이벤트>

document.getElementById("openRciptTretModal").addEventListener("click", function () {

    const checkedRows = oustGrid.getCheckedRows();

    if (checkedRows.length === 0) {
        alert("출하처리할 항목을 선택하세요.");
        return;
    }
    
    // 이미 출하완료된 항목 존재 여부 체크
    const completedRows = checkedRows.filter(row => row.shipmntSt === "출하완료");

    if (completedRows.length > 0) {
        alert("이미 출하완료된 항목이 포함되어 있습니다.");
        return;
    }

    // oustId 배열 추출
    const oustIds = checkedRows.map(row => row.oustId);
    
    axios.post("/shipment/complete", oustIds, {
        headers: { "Content-Type": "application/json" }
    })
    .then(() => {
        alert("출하처리가 완료되었습니다.");

    
        // 출하대기 그리드 새로고침
        searchShipmentList();
    })
    .catch(err => {
        console.error(err);
        alert("출하처리 중 오류가 발생했습니다.");
    });



});

//2-3. 출하취소버튼 이벤트
document.getElementById('deleteShipmntBtn').addEventListener('click', async () => {

  const checkedRows = oustGrid.getCheckedRows();

  if (checkedRows.length === 0) {
    alert("취소 할 항목을 선택하세요.");
    return;
  }

  if (checkedRows.length > 1) {
    alert("취소는 한 건씩만 처리할 수 있습니다.");
    return;
  }

  const row = checkedRows[0];

  if (row.shipmntSt === '출하완료') {
    alert("이미 출하완료된 건은 취소할 수 없습니다.");
    return;
  }

  const reason = prompt(`[${row.oustId}] 취소 사유를 입력하세요:`);
  if (!reason || reason.trim() === '') {
    alert("취소 사유는 필수입니다.");
    return;
  }

  if (!confirm(`${row.oustId} 출하 취소 처리하시겠습니까?`)) {
    return;
  }

  try {
	  await axios.post("/shipment/cancel",
			  {
			    oustId: row.oustId,
			    cancelReason: reason 
			  },
			  {
			    headers: { "Content-Type": "application/json" }
			  }
			);

    alert("출하 취소 처리되었습니다.");

    // 상태 즉시 반영
    oustGrid.setValue(row.rowKey, 'shipmntSt', '출하취소');

  } catch (err) {
    console.error(err);
    alert("취소 처리 중 오류가 발생했습니다.");
  }
});



       
    </script>
</body>
</html>
