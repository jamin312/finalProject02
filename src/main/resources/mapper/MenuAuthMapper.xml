<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="store.yd2team.common.mapper.MenuAuthMapper">

  <resultMap id="MenuAuthResultMap" type="store.yd2team.common.dto.MenuAuthDto">
    <result property="menuId"     column="menu_id"/>
    <result property="menuNm"     column="menu_nm"/>
    <result property="menuUrl"    column="menu_url"/>
    <result property="moduleId"   column="module_id"/>
    <result property="prntMenuId" column="prnt_menu_id"/>
    <result property="sortOrd"    column="sort_ord"/>
    <result property="canRead"    column="can_read"/>
    <result property="canWrite"   column="can_write"/>
    <result property="canDelete"  column="can_delete"/>
  </resultMap>

	<select id="selectMenuAuthByEmpAcct" resultMap="MenuAuthResultMap">
	   WITH perms AS (
	     SELECT
	       m.menu_id,
	       MAX(CASE WHEN a.sel_yn = 'e1' THEN 1 ELSE 0 END) AS can_read,
	       MAX(CASE
	             WHEN a.ins_yn = 'e1'
	               OR a.updt_yn = 'e1'
	             THEN 1 ELSE 0
	           END) AS can_write,
	       MAX(CASE WHEN a.del_yn = 'e1' THEN 1 ELSE 0 END) AS can_delete
	     FROM tb_user_role ur
	     JOIN tb_role r
	       ON ur.role_id = r.role_id
	      AND NVL(r.vend_id, ur.vend_id) = ur.vend_id
	     JOIN tb_auth a
	       ON a.role_id = r.role_id
	      AND NVL(a.vend_id, ur.vend_id) = ur.vend_id
	     JOIN tb_menu m
	       ON a.menu_id = m.menu_id
	      AND NVL(m.vend_id, ur.vend_id) = ur.vend_id
	     WHERE ur.emp_acct_id = #{empAcctId}
	       AND ur.vend_id     = #{vendId}
	       AND m.yn = 'e1'
	     GROUP BY m.menu_id
	   ),
	
	   leaf_ids AS (
	     -- ÏùΩÍ∏∞ Í∞ÄÎä•Ìïú Ïã§Ï†ú ÌéòÏù¥ÏßÄ
	     SELECT m.menu_id
	     FROM tb_menu m
	     JOIN perms p ON p.menu_id = m.menu_id
	     WHERE p.can_read = 1
	       AND m.menu_url IS NOT NULL
	       AND m.yn = 'e1'
	       AND (m.vend_id = #{vendId} OR m.vend_id IS NULL)
	       -- üö® Ïö¥ÏòÅÏûê Ï†ÑÏö© Î©îÎâ¥ Ï∞®Îã® (ÏùºÎ∞ò ÏÇ¨Ïö©Ïûê)
	       AND (
	         EXISTS (SELECT 1 FROM tb_oprtr_acct oa WHERE oa.login_id = #{loginId})
	         OR NVL(m.oprtr_yn, 'e2') != 'e1'
	       )
	   ),
	
	   tree_ids AS (
	     -- leaf ‚Üí Î∂ÄÎ™® ÏûêÎèô Ìè¨Ìï®
	     SELECT menu_id
	     FROM tb_menu
	     START WITH menu_id IN (SELECT menu_id FROM leaf_ids)
	     CONNECT BY PRIOR prnt_menu_id = menu_id
	   )
	
	   SELECT
	     m.menu_id,
	     m.menu_nm,
	     m.menu_url,
	     m.prnt_menu_id,
	     m.sort_ord,
	     m.module_id,
	     NVL(p.can_read,   0) AS can_read,
	     NVL(p.can_write,  0) AS can_write,
	     NVL(p.can_delete, 0) AS can_delete
	   FROM tb_menu m
	   LEFT JOIN perms p ON p.menu_id = m.menu_id
	   WHERE m.menu_id IN (SELECT menu_id FROM tree_ids)
	     AND m.yn = 'e1'
	     AND (m.vend_id = #{vendId} OR m.vend_id IS NULL)
		ORDER BY
		  NVL(m.prnt_menu_id, m.menu_id), 
		  CASE WHEN m.prnt_menu_id IS NULL THEN 0 ELSE 1 END, 
		  m.sort_ord,
		  m.menu_id
	 </select>
  
  	<select id="selectAllMenusForOprtr" resultType="store.yd2team.common.dto.MenuAuthDto">
	  SELECT
	      m.menu_id       AS menuId,
	      m.menu_nm       AS menuNm,
	      m.menu_url      AS menuUrl,
	      m.module_id     AS moduleId,
	      m.prnt_menu_id  AS prntMenuId,
	      m.sort_ord      AS sortOrd,
	      1               AS canRead,
	      1               AS canWrite,
	      1               AS canDelete,
	      CASE WHEN m.menu_tp = 'FOLDER' THEN 1 ELSE 0 END AS folder
	  FROM tb_menu m
	  WHERE m.yn = 'e1'
	  ORDER BY m.module_id, m.sort_ord, m.menu_id
	</select>
	
	<select id="selectMenusForUnpaid" resultType="store.yd2team.common.dto.MenuAuthDto">
	  SELECT
	      m.menu_id       AS menuId,
	      m.menu_nm       AS menuNm,
	      m.menu_url      AS menuUrl,
	      m.module_id     AS moduleId,
	      m.prnt_menu_id  AS prntMenuId,
	      m.sort_ord      AS sortOrd,
	      1               AS canRead,
	      0               AS canWrite,
	      0               AS canDelete,
	      CASE WHEN m.menu_tp = 'FOLDER' THEN 1 ELSE 0 END AS folder
	  FROM tb_menu m
	  WHERE m.yn = 'e1'
	    AND (
	         m.menu_id = 'MENU_COMM_G004'
	         OR m.menu_id IN ('MENU_COMM_010', 'MENU_COMM_012')
	    )
	  ORDER BY m.sort_ord, m.menu_id
	</select>
	
	<select id="selectMenuNameByUrl" resultType="string">
	  SELECT menu_nm
	  FROM (
	    SELECT menu_nm
	      FROM tb_menu
	     WHERE yn = 'e1'
	       AND menu_url = #{menuUrl}
	       AND (vend_id = #{vendId} OR vend_id IS NULL)
	     ORDER BY CASE WHEN vend_id = #{vendId} THEN 0 ELSE 1 END
	  )
	  WHERE ROWNUM = 1
	</select>


</mapper>
