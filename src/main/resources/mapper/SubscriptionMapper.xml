<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="store.yd2team.common.mapper.SubscriptionMapper">
	<!-- Insert subscription plan -->
	<insert id="insertPlan" parameterType="store.yd2team.common.service.subscriptionPlanVO">
		INSERT INTO tb_subsp_plan
		(
			subsp_plan_id,
			plan_nm,
			acct_issu_cnt,
			api_issu_cnt,
			amt,
			sttl_perd,
			applc_dt,
			yn
		)
		VALUES
		(
			#{subspPlanId},
			#{planNm},
			#{acctIssuCnt},
			#{apiIssuCnt},
			#{amt},
			#{sttlPerd},
			#{applcDt},
			#{yn}
		)
	</insert>
	
	<!-- Update subscription plan -->
	<update id="updatePlan" parameterType="store.yd2team.common.service.subscriptionPlanVO">
		UPDATE tb_subsp_plan
		SET
			plan_nm = #{planNm},
			acct_issu_cnt = #{acctIssuCnt},
			api_issu_cnt = #{apiIssuCnt},
			amt = #{amt},
			sttl_perd = #{sttlPerd},
			applc_dt = NVL(#{applcDt}, applc_dt),
			yn = #{yn},
			updt_dt = SYSDATE
		WHERE
			subsp_plan_id = #{subspPlanId}
	</update>
	
	<!-- Get max sequence for current year-month prefix, e.g. 'plan202511' -->
	<select id="getMaxPlanSeqOfMonth" parameterType="string" resultType="string">
		SELECT MAX(SUBSTR(subsp_plan_id, LENGTH(#{prefix}) + 1))
		FROM tb_subsp_plan
		WHERE subsp_plan_id LIKE CONCAT(#{prefix}, '%')
	</select>
	
	<!-- Select list of subscription plans -->
	<select id="selectSubscriptionPlans" resultType="store.yd2team.common.service.subscriptionPlanVO">
		SELECT
			subsp_plan_id AS subspPlanId,
			plan_nm AS planNm,
			acct_issu_cnt AS acctIssuCnt,
			api_issu_cnt AS apiIssuCnt,
			amt,
			sttl_perd AS sttlPerd,
			applc_dt AS applcDt,
			yn,
			crea_dt AS creaDt,
			crea_by AS creaBy,
			updt_dt AS updtDt,
			updt_by AS updtBy
		FROM tb_subsp_plan
		ORDER BY subsp_plan_id DESC
	</select>
	
	<!-- 결제용: 플랜명 + 결제주기로 단일 플랜 조회 (Oracle 호환) -->
	<select id="selectPlanForPayment" resultType="store.yd2team.common.service.subscriptionPlanVO">
		SELECT *
		FROM (
			SELECT
				subsp_plan_id AS subspPlanId,
				plan_nm       AS planNm,
				acct_issu_cnt AS acctIssuCnt,
				api_issu_cnt  AS apiIssuCnt,
				amt,
				sttl_perd     AS sttlPerd,
				applc_dt      AS applcDt,
				yn,
				crea_dt       AS creaDt,
				crea_by       AS creaBy,
				updt_dt       AS updtDt,
				updt_by       AS updtBy
			FROM tb_subsp_plan
			WHERE plan_nm = #{planNm}
			  AND (
					(#{sttlPerd} = 'MONTHLY' AND (sttl_perd = 'b1' OR sttl_perd = '월'))
				 OR (#{sttlPerd} = 'YEARLY'  AND (sttl_perd = 'b2' OR sttl_perd = '연'))
			  )
			ORDER BY applc_dt DESC
		)
		WHERE ROWNUM = 1
	</select>
	
	<!-- vendId(PK)로 tb_vend에서 상호명(vend_nm) 조회 -->
	<select id="selectVendNameById" parameterType="string" resultType="string">
		SELECT vend_nm
		FROM tb_vend
		WHERE vend_id = #{vendId}
	</select>

	<!-- 로그인 사용자의 vendId 기준 현재 구독 + 사용량 조회 -->
	<select id="selectSubscriptionUsageByVendId" parameterType="string" resultType="store.yd2team.common.dto.SubscriptionUsageDto">
		SELECT
			p.plan_nm        AS planNm,
			s.crea_dt        AS creaDt,
			s.start_dt       AS startDt,
			s.end_dt         AS endDt,
			p.sttl_perd      AS sttlPerd,
			p.acct_issu_cnt  AS acctIssuCnt,
			p.api_issu_cnt   AS apiIssuCnt,
			s.acct_use_cnt   AS acctUseCnt,
			s.api_use_cnt    AS apiUseCnt
		FROM tb_subsp s
		JOIN tb_subsp_plan p
		  ON s.subsp_plan_id = p.subsp_plan_id
		WHERE s.vend_id = #{vendId}
	</select>
	
	<!-- 신규 추가: tb_subsp ID 시퀀스 조회 (예: 'subsp_202512' prefix 기준 MAX 3자리) -->
	<select id="getMaxSubspSeqOfMonth" parameterType="string" resultType="string">
		SELECT MAX(SUBSTR(subsp_id, LENGTH(#{prefix}) + 1))
		FROM tb_subsp
		WHERE subsp_id LIKE CONCAT(#{prefix}, '%')
	</select>
	
	<!-- 구독(tb_subsp) 등록 -->
	<insert id="insertSubscription" parameterType="store.yd2team.common.service.SubscriptionVO">
		INSERT INTO tb_subsp
		(
			subsp_id,
			vend_id,
			subsp_plan_id,
			acct_use_cnt,
			api_use_cnt,
			start_dt,
			end_dt,
			crea_dt,
			crea_by
		)
		VALUES
		(
			#{subspId},
			#{vendId},
			#{subspPlanId},
			NVL(#{acctUseCnt}, 0),
			NVL(#{apiUseCnt}, 0),
			#{startDt},
			#{endDt},
			SYSDATE,
			#{creaBy}
		)
	</insert>
	
	<!-- 구독 존재 여부 체크 (vendId 기준) -->
	<select id="existsSubscriptionByVendId" parameterType="string" resultType="int">
		SELECT COUNT(*)
		FROM tb_subsp
		WHERE vend_id = #{vendId}
	</select>
	
	<!-- vendId 기준 구독 정보 수정 -->
	<update id="updateSubscriptionByVendId" parameterType="store.yd2team.common.service.SubscriptionVO">
		UPDATE tb_subsp
		SET
			subsp_plan_id = #{subspPlanId},
			start_dt      = #{startDt},
			end_dt        = #{endDt},
			updt_dt       = SYSDATE,
			updt_by       = #{updtBy}
		WHERE vend_id = #{vendId}
	</update>
	
	<!-- === 정산/결제(tb_sttl) 관련 쿼리 추가 === -->
	<select id="getMaxSttlSeqOfMonth" parameterType="string" resultType="string">
		SELECT MAX(SUBSTR(sttl_id, LENGTH(#{prefix}) + 1))
		FROM tb_sttl
		WHERE sttl_id LIKE CONCAT(#{prefix}, '%')
	</select>
	
	<insert id="insertSttl" parameterType="store.yd2team.common.service.SttlVO">
		INSERT INTO tb_sttl
		(
			sttl_id,
			vend_id,
			subsp_plan_id,
			payment_key,
			crea_by
		)
		VALUES
		(
			#{sttlId},
			#{vendId},
			#{subspPlanId},
			#{paymentKey},
			#{creaBy}
		)
	</insert>
	
	<!-- === 신규 추가: 결제 내역 조회 === -->
	<select id="selectSttlHistoryByVendId" parameterType="string" resultType="store.yd2team.common.dto.SttlHistoryDto">
		SELECT
			v.vend_nm             AS vendNm,
			p.plan_nm             AS planNm,
			p.sttl_perd           AS sttlPerd,
			s.crea_dt             AS startDt,
			CASE
				WHEN p.sttl_perd = 'b1' THEN ADD_MONTHS(s.crea_dt, 1)
				WHEN p.sttl_perd = 'b2' THEN ADD_MONTHS(s.crea_dt, 12)
				ELSE s.crea_dt
			END                  AS endDt
		FROM tb_sttl s
		JOIN tb_vend v
		  ON s.vend_id = v.vend_id
		JOIN tb_subsp_plan p
		  ON s.subsp_plan_id = p.subsp_plan_id
		WHERE s.vend_id = #{vendId}
		ORDER BY s.crea_dt DESC
	</select>

	<!-- === 신규 추가: vendId 기준 현재 구독 플랜 조회 (tb_subsp.subsp_plan_id -> tb_subsp_plan 조인) === -->
	<select id="selectCurrentPlanByVendId" parameterType="string" resultType="store.yd2team.common.service.subscriptionPlanVO">
		SELECT
			p.subsp_plan_id AS subspPlanId,
			p.plan_nm       AS planNm,
			p.acct_issu_cnt AS acctIssuCnt,
			p.api_issu_cnt  AS apiIssuCnt,
			p.amt           AS amt,
			p.sttl_perd     AS sttlPerd,
			p.applc_dt      AS applcDt,
			p.yn            AS yn,
			p.crea_dt       AS creaDt,
			p.crea_by       AS creaBy,
			p.updt_dt       AS updtDt,
			p.updt_by       AS updtBy
		FROM tb_subsp s
		JOIN tb_subsp_plan p
		  ON s.subsp_plan_id = p.subsp_plan_id
		WHERE s.vend_id = #{vendId}
	</select>

	<!-- 신규 추가: vendId 기준 API 사용량 증가 (tb_subsp.api_use_cnt = api_use_cnt + 1) -->
	<update id="incrementApiUseCountByVendId" parameterType="string">
		UPDATE tb_subsp
		SET api_use_cnt = NVL(api_use_cnt, 0) + 1
		WHERE vend_id = #{vendId}
	</update>
	
	<select id="selectExpiredVendIds" resultType="string">
	  SELECT DISTINCT vend_id
	    FROM tb_subsp
	   WHERE end_dt &lt; TRUNC(SYSDATE)
	</select>
	
	<select id="countActiveSubsp" resultType="int">
	  SELECT COUNT(*)
	  FROM tb_subsp
	  WHERE vend_id = #{vendId}
	    AND start_dt &lt;= TRUNC(SYSDATE)
	    AND end_dt   &gt;= TRUNC(SYSDATE)
	</select>

</mapper>