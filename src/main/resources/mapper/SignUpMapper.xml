<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="store.yd2team.common.mapper.SignUpMapper">
	
	<!-- 아이디 중복체크 -->
	<select id="countLoginId" parameterType="string" resultType="int">
		SELECT COUNT(*)
		FROM tb_emp_acct
		WHERE login_id = #{loginId}
	</select>
	
	<!-- 사업자등록번호 중복체크 -->
	<select id="countBizNo" parameterType="string" resultType="int">
		SELECT COUNT(*)
		FROM tb_vend
		WHERE bizno = #{bizNo}
	</select>
	
	<!-- 해당 월의 최대 업체 ID 시퀀스 조회 (예: vend_202512001 → 001) -->
	<select id="getMaxVendSeqOfMonth" parameterType="string" resultType="string">
		SELECT MAX(SUBSTR(vend_id, LENGTH(#{prefix}) + 1))
		FROM tb_vend
		WHERE vend_id LIKE CONCAT(#{prefix}, '%')
	</select>
	
	<!-- 해당 월의 최대 사원계정 ID 시퀀스 조회 (예: mas_acct_202512001 → 001) -->
	<select id="getMaxVendAcctSeqOfMonth" parameterType="string" resultType="string">
		SELECT MAX(SUBSTR(emp_acct_id, LENGTH(#{prefix}) + 1))
		FROM tb_emp_acct
		WHERE emp_acct_id LIKE CONCAT(#{prefix}, '%')
	</select>
	
	<!-- 신규 업체(vend) 등록: st는 DB 디폴트 사용 -->
	<insert id="insertVend" parameterType="store.yd2team.common.service.VendVO">
		INSERT INTO tb_vend (
			vend_id,
			vend_nm,
			rpstr_nm,
			bizno,
			hp,
			tel,
			email,
			addr,
			bizcnd,
			join_dt,
			crea_dt,
			crea_by,
			updt_by
		) VALUES (
			#{vendId},
			#{vendNm},
			#{rpstrNm},
			#{bizno},
			#{hp},
			#{tel},
			#{email},
			#{addr},
			#{bizcnd},
			SYSDATE,
			SYSDATE,
			#{creaBy},
			#{updtBy}
		)
	</insert>
	
	<!-- 신규 사원계정(emp_acct) 등록: st, yn, fail_cnt 등은 DB 디폴트 사용 -->
	<insert id="insertVendAcct" parameterType="store.yd2team.common.service.EmpAcctVO">
		INSERT INTO tb_emp_acct (
			emp_acct_id,
			vend_id,
			emp_id,
			login_id,
			login_pwd,
			mas_yn,
			lock_dttm,
			last_login,
			crea_dt,
			crea_by,
			updt_by
		) VALUES (
			#{empAcctId},
			#{vendId},
			#{empId},
			#{loginId},
			#{loginPwd},
			#{masYn},
			#{lockDttm},
			#{lastLogin},
			SYSDATE,
			#{creaBy},
			#{updtBy}
		)
	</insert>
	
	<insert id="insertUserRole">
	  INSERT INTO tb_user_role (
	      vend_id,
	      emp_acct_id,
	      role_id,
	      crea_dt,
	      crea_by,
	      updt_dt,
	      updt_by
	  ) VALUES (
	      #{vendId},
	      #{empAcctId},
	      #{roleId},
	      SYSDATE,
	      #{creaBy},
	      SYSDATE,
	      #{creaBy}
	  )
	</insert>
	
	<select id="countUserRole" resultType="int">
	  SELECT COUNT(*)
	  FROM tb_user_role
	  WHERE vend_id = #{vendId}
	    AND emp_acct_id = #{empAcctId}
	    AND role_id = #{roleId}
	</select>

	<!-- 신규 마스터 사원(tb_emp) 등록 -->
	<insert id="insertMasterEmp" parameterType="store.yd2team.insa.service.EmpVO">
		INSERT INTO tb_emp (
			emp_id,
			vend_id,
			nm,
			cttpc,
			email,
			dty,
			clsf,
			rspofc,
			emplym_ty,
			hffc_st,
			crea_by
		) VALUES (
			#{empId},
			#{vendId},
			#{nm},
			#{cttpc},
			#{email},
			#{dty},
			#{clsf},
			#{rspofc},
			#{emplymTy},
			#{hffcSt},
			#{creaBy}
		)
	</insert>

	<select id="getNextEmpId" resultType="string">
		SELECT 'emp' || TO_CHAR(SYSDATE, 'YYMM') ||
		       LPAD(NVL(MAX(SUBSTR(emp_id, LENGTH(emp_id)-2, 3)), 0) + 1, 3, '0') AS emp_id
		FROM tb_emp
		WHERE SUBSTR(emp_id, 4, 4) = TO_CHAR(SYSDATE, 'YYMM')
	</select>

</mapper>